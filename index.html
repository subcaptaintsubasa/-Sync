<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>XISync</title>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-CSR2CREBLH"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-CSR2CREBLH');
    </script>
    
    <!-- PWA Manifest (Inline) -->
    <link rel="manifest" href="manifest.json">

    <meta name="theme-color" content="#007bff">
    <link rel="icon" type="image/png" href="./icon.png">
    <link rel="apple-touch-icon" href="./icon.png">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <style>
        :root {
            --pitch-bg: #539d56; --line-color: rgba(255, 255, 255, 0.6); --sidebar-bg: #f4f4f4;
            --text-color: #333; --primary-color: #007bff; --secondary-color: #6c757d; --danger-color: #dc3545;
            --marker-gk-color: #f39c12; --marker-df-color: #3498db;
            --marker-mf-color: #2ecc71; --marker-fw-color: #e74c3c;
        }

        body {
            font-family: 'Helvetica Neue', 'Arial', 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', 'Meiryo', sans-serif;
            margin: 0; background-color: #e9e9e9; color: var(--text-color);
            padding: 20px; box-sizing: border-box; min-height: 100vh; overflow-x: hidden;
            touch-action: manipulation; /* Prevent double-tap zoom */
        }

        .container { display: flex; flex-wrap: wrap; gap: 20px; width: 100%; max-width: 1600px; margin: 0 auto; }
        .left-panel, .right-panel { width: 350px; flex-shrink: 0; background-color: var(--sidebar-bg); padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: flex; flex-direction: column; gap: 25px; }
        .main-content { flex-grow: 1; min-width: 400px; }

        .app-branding { text-align: center; padding-bottom: 20px; border-bottom: 1px solid #ddd; margin-bottom: 15px; }
        .app-branding h2 { margin: 0; font-size: 2em; color: var(--primary-color); letter-spacing: 1px;}
        .app-branding p { margin: 2px 0 0 0; font-size: 0.9em; color: #666; }

        [data-layout-mode="horizontal"] .left-panel { display: none; }
        [data-layout-mode="vertical"] .right-panel #player-management-section { display: none; }
        [data-layout-mode="vertical"] .container { align-items: flex-start; }

        @media (max-width: 1200px) {
            .container { flex-direction: column; align-items: center; }
            .left-panel, .right-panel, .main-content { width: 100%; max-width: 600px; }
            [data-layout-mode="vertical"] .left-panel { display: none; }
            [data-layout-mode="vertical"] .right-panel #player-management-section { display: flex; }
        }

        .control-group { display: flex; flex-direction: column; gap: 8px; }
        .control-group label { font-weight: bold; }
        #title-input { width: 100%; padding: 12px; font-size: 1.6em; font-weight: bold; border: 2px solid transparent; border-radius: 8px; box-sizing: border-box; margin-bottom: 15px; transition: border-color 0.3s; }
        #title-input:focus { outline: none; border-color: var(--primary-color); }
        
        #capture-area { position: relative; background-color: #4a8d4d; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .pitch-wrapper { position: relative; }
        .capture-title { color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.8); font-size: 30px; width: 100%; text-align:center; padding-bottom: 20px; box-sizing: border-box; display: none; }
        
        .pitch {
            position: relative; width: 100%; background-color: var(--pitch-bg);
            background-image: repeating-linear-gradient(90deg, transparent, transparent 4.8%, rgba(0,0,0,0.05) 5%, transparent 5.2%);
            border: 3px solid var(--line-color); border-radius: 10px; box-sizing: border-box; overflow: hidden;
        }
        .pitch-wrapper.vertical .pitch { padding-top: 125%; background-image: repeating-linear-gradient(0deg, transparent, transparent 4.8%, rgba(0,0,0,0.05) 5%, transparent 5.2%); } 
        .pitch-wrapper.horizontal .pitch { padding-top: 70%; }
        
        .pitch-line { position: absolute; box-sizing: border-box; border-color: var(--line-color); border-style: solid; }
        .vertical .center-line   { width: 100%; height: 3px; background-color: var(--line-color); top: 0; left: 0; }
        .vertical .center-circle { width: 40%; padding-top: 20%; border-width: 3px; border-radius: 0 0 50% 50%; border-top-style: none; top: -3px; left: 50%; transform: translateX(-50%); }
        .vertical .goal-area { width: 30%; height: 7%; border-width: 3px; border-bottom-style: none; bottom: 0; left: 50%; transform: translateX(-50%); }
        .vertical .penalty-area { width: 60%; height: 18%; border-width: 3px; border-bottom-style: none; bottom: 0; left: 50%; transform: translateX(-50%); }
        .vertical .penalty-arc { width: 20%; height: 8%; border-width: 3px; border-radius: 50% 50% 0 0; border-bottom-style: none; bottom: 18%; left: 50%; transform: translateX(-50%); }
        .vertical .goal { width: 20%; height: 4%; background: rgba(255,255,255,0.1); border-width: 3px; border-bottom-style: none; bottom: 0; left: 50%; transform: translateX(-50%); border-radius: 10px 10px 0 0; }
        
        .horizontal .center-line { width: 3px; height: 100%; background-color: var(--line-color); top: 0; right: 0; }
        .horizontal .center-circle { height: 52%; width: 18.2%; border: 3px solid var(--line-color); border-radius: 50% 0 0 50%; border-right-style: none; right: -3px; top: 50%; transform: translateY(-50%); }
        .horizontal .goal-area { width: 7%; height: 30%; border-width: 3px; border-left-style: none; top: 35%; left: 0; }
        .horizontal .penalty-area { width: 18%; height: 50%; border-width: 3px; border-left-style: none; top: 25%; left: 0; }
        .horizontal .penalty-arc { width: 8%; height: 20%; border-width: 3px; border-radius: 0 50% 50% 0; border-left-style: none; top: 40%; left: 18%; }
        .horizontal .goal { width: 4%; height: 20%; background: rgba(255,255,255,0.1); border-width: 3px; border-right-style: none; top: 40%; left: 0; border-radius: 0 10px 10px 0; }

        .capture-subs { padding-top: 20px; color: white; font-size: 15px; }
        .capture-subs h4 { margin: 0 0 12px 0; text-align: center; font-size: 1.2em; letter-spacing: 1px; }
        .subs-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .subs-pos-group { display: flex; align-items: baseline; gap: 10px; }
        .subs-pos-group .pos-label { font-weight: bold; flex-shrink: 0; width: 35px; }
        .subs-pos-group .names { word-break: keep-all; }

        .capture-watermark { display: none; }
        .is-capturing .capture-watermark { display: block; position: absolute; bottom: 10px; right: 15px; font-size: 14px; color: rgba(255, 255, 255, 0.7); text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }

        .player-container { position: absolute; display: flex; flex-direction: column; align-items: center; user-select: none; transform: translate(-50%, -50%); transition: top 0.3s ease, left 0.3s ease, transform 0.2s, box-shadow 0.2s; will-change: top, left, transform; border-radius: 50%; }
        .player-container.is-moving { cursor: move; z-index: 100; transform: translate(-50%, -50%) scale(1.15); transition: transform 0.2s, box-shadow 0.2s; } /* No position transition while moving */
        .player-container.drop-target-hover { transform: translate(-50%, -50%) scale(1.15); }
        .player-marker { width: 52px; height: 52px; border-radius: 50%; box-shadow: 0 3px 6px rgba(0,0,0,0.3); display: flex; flex-direction: column; justify-content: center; align-items: center; color: #333; font-weight: bold; border: 2px solid rgba(0,0,0,0.2); box-sizing: border-box; touch-action: none; /* For smoother drag on touch */ }
        [data-drag-mode="position"] .player-marker { cursor: grab; }
        [data-drag-mode="swap"] .player-marker { cursor: pointer; }
        .player-marker.gk { background-color: var(--marker-gk-color); } .player-marker.df { background-color: var(--marker-df-color); color: white; }
        .player-marker.mf { background-color: var(--marker-mf-color); color: white; } .player-marker.fw { background-color: var(--marker-fw-color); color: white; }
        .player-number { font-size: 22px; line-height: 1; pointer-events: none; } .player-pos { font-size: 11px; line-height: 1; opacity: 0.8; margin-top: 2px; pointer-events: none; }
        .player-name { background-color: rgba(0, 0, 0, 0.7); color: white; font-size: 14px; font-weight: bold; padding: 5px 8px; border-radius: 12px; margin-top: 6px; text-align: center; max-width: 120px; white-space: normal; word-break: break-all; line-height: 1.2; box-shadow: 0 1px 4px rgba(0,0,0,0.25); cursor: default; }
        .unassign-btn { position: absolute; top: -10px; right: -10px; width: 24px; height: 24px; background-color: rgba(255, 255, 255, 0.9); color: #555; border-radius: 50%; border: 1px solid #ccc; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 16px; font-weight: bold; line-height: 1; box-shadow: 0 1px 3px rgba(0,0,0,0.2); transition: all 0.2s; z-index: 11; padding: 0; }
        .unassign-btn:hover { background-color: #e74c3c; color: white; transform: scale(1.1); }
        .is-capturing .unassign-btn, .is-capturing .unassign-btn-sub { display: none; }
        
        button { width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: background-color 0.3s, transform 0.1s; }
        button:active { transform: scale(0.98); }
        .unassign-btn-sub:active,
        .edit-player-btn:active {
            transform: translateY(-50%) scale(1);
        }
        .btn-primary { background-color: var(--primary-color); color: white; } .btn-secondary { background-color: var(--secondary-color); color: white; } .btn-danger { background-color: var(--danger-color); color: white; }
        .orientation-toggle { display: flex; gap: 10px; }
        .orientation-toggle input { display: none; }
        .orientation-toggle label { flex: 1; text-align: center; padding: 8px; border-radius: 6px; border: 1px solid #ccc; cursor: pointer; background-color: #fff; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 14px; }
        .orientation-toggle input:checked + label { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        
        #player-list-controls { border: 1px solid #ddd; border-radius: 8px; padding: 15px; background-color: #fff; }
        
        .player-list-item { display: flex; align-items: center; padding: 8px 10px; border-bottom: 1px solid #eee; user-select: none; }
        .player-list-item:not(.is-assigned) { cursor: grab; }
        .player-list-item.is-assigned { background-color: #f0f0f0; color: #999; }
        .player-list-item .num, .player-list-item .name { padding: 4px; } .player-list-item .num { font-weight: bold; width: 30px; text-align: right; margin-right: 5px;}
        .player-list-item .name { flex-grow: 1; position: relative;}
        .player-list-item.is-assigned .num, .player-list-item.is-assigned .name { color: #888; } /* Assigned players are greyed out */
        .edit-player-btn { background: none; border: none; cursor: pointer; width: 30px; height: 30px; position: absolute; right: 5px; top: 50%; transform: translateY(-50%); color: #888; opacity: 0; transition: opacity 0.2s, background-color 0.2s; display: flex; align-items: center; justify-content: center; border-radius: 50%; padding: 0; }
        .edit-player-btn:hover { background-color: #f0f0f0; }
        .player-list-item:hover .edit-player-btn { opacity: 1; }
        .edit-player-btn:hover { color: var(--primary-color); }
        
        .drag-ghost { position: absolute; left: -1000px; background-color: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 2100; border-radius: 15px; padding: 5px 10px; font-size: 14px; display: inline-flex; align-items: center; }
        .drag-ghost .num { font-weight: bold; margin-right: 8px; }

        #substitutes-container { display: flex; flex-direction: column; gap: 10px; }
        .sub-category { display: flex; align-items: flex-start; gap: 8px; }
        .sub-category-label { font-weight: bold; width: 35px; padding-top: 10px; flex-shrink: 0; }
        .sub-drop-zone { flex-grow: 1; min-height: 40px; border: 2px dashed #ccc; border-radius: 8px; padding: 5px; background-color: #fff; transition: background-color 0.2s, border-color 0.2s; display: flex; flex-wrap: wrap; align-content: flex-start; gap: 8px; }
        .sub-drop-zone.drop-target-hover { background-color: #e9f5ff; border-color: var(--primary-color); }
        .substitute-item { position: relative; display: inline-flex; align-items: center; background-color: #e9ecef; border-radius: 15px; padding: 5px 25px 5px 10px; font-size: 14px; user-select: none; cursor: grab; }
        .substitute-item .num { font-weight: bold; margin-right: 8px; }
        .unassign-btn-sub { position: absolute; top: 50%; right: 4px; transform: translateY(-50%); width: 22px; height: 22px; background-color: #ccc; color: white; border-radius: 50%; border: none; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 16px; line-height: 1; padding: 0; transition: background-color 0.2s; }
        .unassign-btn-sub:hover { background-color: #e74c3c; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); width: 90%; max-width: 420px; position: relative; }
        .modal-close-btn { position: absolute; top: 10px; right: 15px; font-size: 28px; color: #999; background: none; border: none; cursor: pointer; width: auto; padding: 0; }
        .modal-content h3 { margin-top: 0; margin-bottom: 25px; text-align: center; }
        
        #edit-player-modal .form-group { margin-bottom: 20px; }
        #edit-player-modal .form-group label { display: block; margin-bottom: 8px; font-weight: bold; }
        #edit-player-modal input[type="text"] { width: 100%; padding: 12px; font-size: 16px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; }

        .number-input-wrapper { display: flex; align-items: center; gap: 5px; }
        .number-input-btn { width: 48px !important; height: 48px; font-size: 24px !important; padding: 0 !important; background-color: #f0f0f0; color: #333; flex-shrink: 0; user-select: none; }
        .number-input-btn:hover { background-color: #e0e0e0; }
        #edit-player-number { width: 100%; height: 48px; font-size: 22px; text-align: center; border: 1px solid #ccc; border-radius: 8px; -moz-appearance: textfield; }
        #edit-player-number::-webkit-outer-spin-button, #edit-player-number::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        #delete-player-btn-modal { display: flex; align-items: center; justify-content: center; gap: 8px; }
        #delete-player-btn-modal svg { width: 18px; height: 18px; }
        
        #formation-modal .modal-content { max-width: 600px; }
        #formation-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .formation-card { border: 2px solid #ddd; border-radius: 8px; padding: 15px; text-align: center; cursor: pointer; transition: all 0.2s ease; background-color: #fff; }
        .formation-card:hover { border-color: var(--primary-color); transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .formation-card.selected { border-color: var(--primary-color); background-color: #e9f5ff; font-weight: bold; }
        .formation-name { font-size: 1.1em; margin-bottom: 5px; }
        .formation-note { font-size: 0.8em; color: #666; }

        .share-section { margin-bottom: 25px; }
        .share-section-title { font-weight: bold; margin-bottom: 10px; }
        .share-actions { display: flex; flex-direction: column; gap: 10px; }
        .share-actions button, .share-actions label { flex: 1; font-size: 14px; padding: 10px; text-align: center; }
        #import-squad-input { display: none; }
        
        #open-sidebar-btn { display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 14px; padding: 10px; }
        #open-sidebar-btn svg { width: 20px; height: 20px; }

        #player-list-sidebar { position: fixed; top: 0; left: 0; width: 300px; height: 100vh; background-color: #fff; box-shadow: 4px 0 15px rgba(0,0,0,0.2); transform: translateX(-100%); transition: transform 0.3s ease-in-out; z-index: 1000; display: flex; flex-direction: column; }
        #player-list-sidebar.is-open { transform: translateX(0); }
        .sidebar-header { padding: 15px 15px 10px 15px; border-bottom: 1px solid #eee; display: flex; flex-direction: column; align-items: flex-start; gap: 4px; }
        .sidebar-header .title-bar { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .sidebar-header h3 { margin: 0; font-size: 1.2em; }
        .sidebar-add-player { padding: 15px; border-bottom: 1px solid #eee; background-color: #f9f9f9; }
        .add-player-form { display: flex; gap: 8px; align-items: center; }
        .add-player-form input[type="number"] { width: 60px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; } 
        .add-player-form input[type="text"] { flex: 1; min-width: 0; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .add-player-form button { width: auto; flex-shrink: 0; font-size: 14px; padding: 8px 12px; }
        #sidebar-player-list { flex-grow: 1; overflow-y: auto; }
        #sidebar-player-list.is-empty { padding: 20px; text-align: center; color: #888; }

        .mode-toggle-fab { position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px; background-color: var(--primary-color); color: white; border: none; border-radius: 50%; box-shadow: 0 4px 12px rgba(0,0,0,0.3); cursor: pointer; display: flex; justify-content: center; align-items: center; z-index: 1000; transition: transform 0.2s, background-color 0.2s; }
        .mode-toggle-fab:hover { background-color: #0056b3; }
        .mode-toggle-fab:active { transform: scale(0.95); }
        .mode-toggle-fab svg { width: 30px; height: 30px; }

        .mode-toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background-color: rgba(0, 0, 0, 0.8); color: white; padding: 10px 20px; border-radius: 20px; font-size: 14px; font-weight: bold; z-index: 3000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; white-space: nowrap; }
        .mode-toast.show { opacity: 1; visibility: visible; }
        
        /* --- ã‚µã‚¤ãƒ‰ãƒãƒ¼æ“ä½œæ”¹å–„ã®ãŸã‚ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
        .container {
            transition: padding-left 0.3s ease-in-out;
        }
        #player-list-sidebar.no-transition {
            /* JSã§ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã«ä½¿ç”¨ */
            transition: none;
        }

        .sidebar-handle {
            position: fixed;
            left: 0;
            top: calc(50% - 50px);
            width: 24px;
            height: 100px;
            background-color: var(--primary-color);
            border: 2px solid white;
            border-left: none;
            border-radius: 0 12px 12px 0;
            cursor: grab;
            z-index: 1001;
            transition: left 0.3s ease-in-out, background-color 0.2s;
            box-shadow: 2px 0 8px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sidebar-handle:hover {
            background-color: #0056b3;
        }
        .sidebar-handle::after {
            content: '';
            width: 4px;
            height: 40px;
            background-color: rgba(255,255,255,0.7);
            border-radius: 2px;
        }
        body.sidebar-is-open .sidebar-handle {
            left: -30px; /* é–‹ã„ã¦ã„ã‚‹ã¨ãã¯éš ã™ */
        }

        .pin-sidebar-btn {
            width: auto;
            height: auto;
            background: #f0f0f0;
            color: #333;
            border: 1px solid #ccc;
            border-radius: 50%;
            font-size: 16px;
            cursor: pointer;
            padding: 6px;
            line-height: 1;
            transition: all 0.2s;
            display: none; /* ã‚¹ãƒãƒ›ã§ã¯éè¡¨ç¤º */
        }
        @media (hover: hover) and (pointer: fine) {
            /* PC (ãƒ›ãƒãƒ¼å¯èƒ½ãƒ‡ãƒã‚¤ã‚¹) ã®ã¿è¡¨ç¤º */
            .pin-sidebar-btn { display: block; }
        }
        .pin-sidebar-btn:hover {
            background-color: #e0e0e0;
            transform: scale(1.1);
        }
        #player-list-sidebar.is-pinned .pin-sidebar-btn {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: rotate(45deg);
        }

        .sidebar-header .title-bar {
            /* ãƒ”ãƒ³ãƒœã‚¿ãƒ³é…ç½®ã®ãŸã‚ã®èª¿æ•´ */
            gap: 10px;
        }
        .sidebar-header .title-bar h3 {
            margin-right: auto;
        }
        /* (æ—¢å­˜ã®ã‚¹ã‚¿ã‚¤ãƒ«ã®æœ€å¾Œã«è¿½åŠ ) */

/* --- ã‚¹ãƒãƒ›é–‹ç™ºä¸­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒãƒŠãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
#mobile-notice-banner {
    display: none; /* PCã§ã¯éè¡¨ç¤ºãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ */
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background-color: #fffde7; /* è–„ã„é»„è‰² */
    color: #5d4037; /* æš—ã‚ã®èŒ¶è‰² */
    padding: 12px 50px 12px 15px; /* å³å´ã«é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç¢ºä¿ */
    box-sizing: border-box;
    z-index: 5000; /* æœ€å‰é¢ã«è¡¨ç¤º */
    box-shadow: 0 -2px 10px rgba(0,0,0,0.15);
    border-top: 3px solid #fbc02d; /* ç›®ç«‹ã¤é»„è‰²ã®ç·š */
    align-items: center;
}

#mobile-notice-banner .banner-content {
    display: flex;
    align-items: center;
    gap: 12px;
}

#mobile-notice-banner .icon {
    font-size: 24px;
    line-height: 1;
}

#mobile-notice-banner p {
    margin: 0;
    font-size: 13px;
    line-height: 1.4;
    font-weight: 500;
}

#close-notice-btn {
    position: absolute;
    top: 50%;
    right: 10px;
    transform: translateY(-50%);
    width: 32px;
    height: 32px;
    background: transparent;
    border: none;
    border-radius: 50%;
    color: #757575;
    font-size: 24px;
    cursor: pointer;
    line-height: 1;
    padding: 0;
    transition: background-color 0.2s;
    /* æ—¢å­˜ã®ãƒœã‚¿ãƒ³ãƒªã‚»ãƒƒãƒˆ */
    all: revert; 
    /* ä¸Šè¨˜ã§å‹•ã‹ãªã„å ´åˆã®å€‹åˆ¥ã‚¹ã‚¿ã‚¤ãƒ« */
     position: absolute; top: 50%; right: 10px; transform: translateY(-50%); width: 32px; height: 32px; background: none; border: none; font-size: 24px; cursor: pointer; padding: 0; 
}
#close-notice-btn:hover {
    background-color: rgba(0,0,0,0.1);
}

/* ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¯ã‚¨ãƒªã§ã‚¹ãƒãƒ›ã®å ´åˆã®ã¿è¡¨ç¤º */
@media (max-width: 768px) {
    #mobile-notice-banner {
        display: flex;
    }
    
    /* ãƒãƒŠãƒ¼ãŒè¡¨ç¤ºã•ã‚ŒãŸåˆ†ã€ãƒšãƒ¼ã‚¸ä¸‹éƒ¨ã«ä½™ç™½ã‚’è¿½åŠ  */
    body {
        padding-bottom: 70px; /* ãƒãƒŠãƒ¼ã®é«˜ã•ã«å¿œã˜ã¦èª¿æ•´ */
    }
}
/* --- START: ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³UIã‚¹ã‚¿ã‚¤ãƒ« --- */

/* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ(PC)ã§ã¯ã‚¹ãƒãƒ›ç”¨UIã‚’éè¡¨ç¤ºã« */
.mobile-header,
#mobile-subs-area,
#mobile-player-list-panel,
#mobile-formation-btn,
#mobile-player-list-btn,
#mobile-unassign-bumper {
    display: none;
}

/* is-mobileã‚¯ãƒ©ã‚¹ãŒä»˜ã„ãŸã‚‰PCç”¨UIã‚’éè¡¨ç¤ºã«ã—ã€ã‚¹ãƒãƒ›ç”¨ã‚’è¡¨ç¤ºã™ã‚‹ */
body.is-mobile .pc-ui-wrapper {
    display: none;
}
body.is-mobile .mobile-header,
body.is-mobile #mobile-subs-area,
body.is-mobile #mobile-player-list-btn {
    display: flex;
}
body.is-mobile #mobile-formation-btn,
body.is-mobile #mode-toggle-btn { /* æ—¢å­˜ã®FABã‚‚ãƒ¢ãƒã‚¤ãƒ«ã§è¡¨ç¤º */
    display: flex;
}

@media (max-width: 768px) {
    body {
        padding: 0;
        display: flex;
        flex-direction: column;
        height: 100vh; /* ã‚¹ãƒãƒ›ã®é«˜ã•ã„ã£ã±ã„ã« */
    }

    /* PCç”¨UIã‚’éè¡¨ç¤ºã«ã—ã€ã‚¹ãƒãƒ›ç”¨ã‚’è¡¨ç¤ºã™ã‚‹ã‚¯ãƒ©ã‚¹ */
    body.is-mobile {
        --safe-area-inset-top: env(safe-area-inset-top, 0px);
        --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
    }
    
    .mobile-header {
        position: sticky;
        top: 0;
        width: 100%;
        padding: 10px 15px;
        padding-top: calc(10px + var(--safe-area-inset-top));
        background: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        z-index: 1100;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        display: flex;
        align-items: center;
        gap: 10px;
        flex-shrink: 0;
    }
    #mobile-title-input {
        flex-grow: 1;
        border: none;
        background: transparent;
        font-size: 18px;
        font-weight: bold;
        outline: none;
    }

    body.is-mobile .main-content { /* ã‚¹ãƒãƒ›ã§ã¯ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒFlexboxã®å­ã«ãªã‚‹ */
        display: flex;
        flex-direction: column;
        flex-grow: 1;
        width: 100%;
        min-height: 0; /* flex-growã‚’æ­£ã—ãåŠ¹ã‹ã›ã‚‹ãŸã‚ */
        padding: 10px;
    }

    body.is-mobile #capture-area {
        flex-grow: 1;
        display: flex; /* capture-areaã‚’flexã«ã—ã¦ä¸­ã®pitch-wrapperã‚’ä¼¸ã°ã™ */
        padding: 10px;
    }
    body.is-mobile .pitch-wrapper {
        width: 100%;
        flex-grow: 1;
    }
    
    #mobile-subs-area {
        flex-shrink: 0;
        width: 100%;
        height: 100px;
        background: #f1f3f5;
        border-top: 1px solid #dee2e6;
        padding: 8px;
        overflow-x: auto;
        white-space: nowrap;
        box-sizing: border-box;
        padding-bottom: calc(8px + var(--safe-area-inset-bottom));
        -webkit-overflow-scrolling: touch;
        display: flex;
        gap: 15px;
    }
    .sub-category-mobile { display: flex; flex-direction: column; gap: 5px; }
    .sub-category-mobile-label { font-size: 12px; font-weight: bold; color: #868e96; }
    .sub-players-wrapper { display: flex; gap: 8px; }
    .sub-player-chip { width: 40px; height: 40px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 16px; color: white; background: var(--secondary-color); box-shadow: 0 1px 3px rgba(0,0,0,0.2); }

    /* FAB (ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒœã‚¿ãƒ³) å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
    .mobile-fab {
        position: fixed;
        width: 56px; height: 56px;
        border-radius: 50%;
        background-color: var(--primary-color);
        color: white;
        border: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 24px;
        z-index: 1200;
        transition: transform 0.2s, background-color 0.2s;
    }
    #mobile-hamburger-btn { position: static; width: 40px; height: 40px; flex-shrink: 0; background-color: transparent; color: #333; box-shadow: none; }
    
    #mode-toggle-btn { /* æ—¢å­˜ãƒœã‚¿ãƒ³ã®ä½ç½®ã‚’èª¿æ•´ */
        position: fixed; 
        right: 15px; bottom: calc(15px + var(--safe-area-inset-bottom));
        width: 56px; height: 56px; z-index: 1200;
    }
    #mobile-player-list-btn.bottom-left {
        left: 15px; bottom: calc(15px + var(--safe-area-inset-bottom));
    }
    .mobile-formation-fab {
        position: fixed;
        top: calc(70px + var(--safe-area-inset-top)); /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®é«˜ã•ã«å¿œã˜ã¦èª¿æ•´ */
        left: 50%; transform: translateX(-50%);
        padding: 8px 16px;
        border-radius: 20px;
        background-color: rgba(0, 0, 0, 0.6);
        color: white; font-size: 14px;
        border: none;
        z-index: 100;
        opacity: 0.8;
        cursor: pointer;
    }

    #mobile-player-list-panel {
        position: fixed;
        left: 0; top: 0;
        width: 85%;
        max-width: 320px;
        height: 100vh;
        background: #fff;
        box-shadow: 4px 0 15px rgba(0,0,0,0.2);
        z-index: 1500;
        transform: translateX(-105%);
        transition: transform 0.3s ease-in-out;
        display: flex;
        flex-direction: column;
    }
    #mobile-player-list-panel.is-open {
        transform: translateX(0);
    }
    #mobile-player-list-panel .panel-header {
        padding: 15px;
        padding-top: calc(15px + var(--safe-area-inset-top));
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #eee;
    }
    #mobile-player-list-panel .panel-header h3 { margin: 0; font-size: 1.1em; }
    #add-player-btn-mobile { width: auto; padding: 6px 12px; font-size: 14px; }
    
    #panel-player-list-grid {
        flex-grow: 1;
        overflow-y: auto;
        padding: 15px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        align-content: flex-start;
    }
    .list-player-item { display: flex; flex-direction: column; align-items: center; cursor: grab; user-select: none; }
    .list-player-item.is-assigned { opacity: 0.4; cursor: not-allowed; }
    .list-player-marker {
        width: 80px; height: 80px;
        border-radius: 50%;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: white; font-weight: bold;
        position: relative; /* for number */
    }
    .list-player-marker .list-player-number { position: absolute; top: 8px; font-size: 12px; opacity: 0.9; }
    .list-player-marker .list-player-name { font-size: 15px; text-align: center; padding: 0 5px; line-height: 1.2; word-break: break-all; }
    .list-player-marker.gk { background-color: var(--marker-gk-color); color: #333; }
    .list-player-marker.df { background-color: var(--marker-df-color); }
    .list-player-marker.mf { background-color: var(--marker-mf-color); }
    .list-player-marker.fw { background-color: var(--marker-fw-color); }
    
    /* ãƒ”ãƒƒãƒã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ« */
    .player-container.is-empty .player-marker { background: rgba(0,0,0,0.1); border-style: dashed; }
    .player-container.is-empty .player-number { display: none; }
    .player-container.is-empty .player-pos { font-weight: bold; font-size: 14px; color: rgba(255,255,255,0.7); opacity: 1; }
    .player-container.is-empty .player-name { display: none; }
    .player-container.is-empty .unassign-btn { display: none; }

    #mobile-unassign-bumper {
        position: fixed;
        top: 0;
        left: 0; right: 0;
        background: rgba(220, 53, 69, 0.8);
        color: white;
        text-align: center;
        padding: 20px;
        padding-top: calc(20px + var(--safe-area-inset-top));
        z-index: 1600;
        transform: translateY(-105%);
        transition: transform 0.2s ease-in-out, background-color 0.2s;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px; font-size: 18px; font-weight: bold;
    }
    #mobile-unassign-bumper.is-visible {
        transform: translateY(0);
    }
     #mobile-unassign-bumper.is-droppable {
        background: rgba(180, 40, 55, 0.95); /* Drop hover effect */
    }
    .is-capturing .mobile-formation-fab { display: none; } /* ç”»åƒä¿å­˜æ™‚ã«éè¡¨ç¤º */

} /* End of @media */
/* ä¿®æ­£ç®‡æ‰€: ã‚¹ã‚¿ã‚¤ãƒ«ã‚·ãƒ¼ãƒˆã®æœ«å°¾ã«è¿½åŠ  */

/* --- START: ã‚¹ãƒãƒ›UIæ”¹å–„ã‚¹ã‚¿ã‚¤ãƒ« --- */
@media (max-width: 768px) {
    #panel-player-list-grid {
        grid-template-columns: repeat(2, 1fr); /* 2åˆ—ã‚°ãƒªãƒƒãƒ‰ */
        gap: 20px;
        padding: 15px;
        align-content: flex-start;
    }

    .list-player-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
        user-select: none;
        cursor: grab;
    }
    .list-player-item.is-assigned {
        opacity: 0.4;
        cursor: not-allowed;
    }

    .list-player-marker {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        font-weight: bold;
        color: white;
        text-align: center;
        box-shadow: 0 3px 6px rgba(0,0,0,0.2);
        position: relative;
    }
    .list-player-marker .list-player-number {
        position: absolute;
        top: 10px;
        font-size: 14px;
        opacity: 0.9;
    }
    .list-player-marker .list-player-name {
        font-size: 18px;
        line-height: 1.2;
        padding: 0 8px;
        word-break: break-word;
    }
    
    .list-player-marker.gk { background-color: var(--marker-gk-color); color: #333; }
    .list-player-marker.df { background-color: var(--marker-df-color); }
    .list-player-marker.mf { background-color: var(--marker-mf-color); }
    .list-player-marker.fw { background-color: var(--marker-fw-color); }

    /* ãƒ”ãƒƒãƒã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ« */
    .player-container.is-empty .player-marker {
        background: rgba(0,0,0,0.1);
        border: 2px dashed rgba(255,255,255,0.5);
    }
    .player-container.is-empty .player-number { display: none; }
    .player-container.is-empty .player-pos {
        font-weight: bold;
        font-size: 14px;
        color: rgba(255,255,255,0.7);
        opacity: 1;
    }
    .player-container.is-empty .player-name { display: none; }
    .player-container.is-empty .unassign-btn { display: none; }
}
/* --- END: ã‚¹ãƒãƒ›UIæ”¹å–„ã‚¹ã‚¿ã‚¤ãƒ« --- */
/* --- END: ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³UIã‚¹ã‚¿ã‚¤ãƒ« --- */
    </style>
</head>
<body data-layout-mode="vertical" data-drag-mode="swap">
    <div id="update-notification" style="display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #333; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 9999; font-size: 14px; align-items: center; gap: 15px;">
        <span>æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒåˆ©ç”¨å¯èƒ½ã§ã™ã€‚</span>
        <button id="update-btn" style="width: auto; padding: 6px 12px; font-size: 13px; background-color: var(--primary-color); color: white; border: none; border-radius: 5px; cursor: pointer;">æ›´æ–°</button>
    </div>
        <header class="mobile-header">
        <input type="text" id="mobile-title-input" placeholder="ã‚¹ã‚¿ãƒ¡ãƒ³äºˆæƒ³">
        <button id="mobile-hamburger-btn" class="mobile-fab">â‰¡</button>
    </header>

    <div id="mobile-subs-area">
        <!-- ã“ã“ã«æ§ãˆé¸æ‰‹ãŒJSã§æç”»ã•ã‚Œã¾ã™ -->
    </div>

    <div id="mobile-player-list-panel">
        <div class="panel-header">
            <h3>é¸æ‰‹ãƒªã‚¹ãƒˆ</h3>
            <button id="add-player-btn-mobile" class="btn-primary">+</button>
        </div>
        <div id="panel-player-list-grid">
            <!-- ã“ã“ã«é¸æ‰‹ãƒãƒ¼ã‚«ãƒ¼ãŒJSã§æç”»ã•ã‚Œã¾ã™ -->
        </div>
    </div>
    
    <button id="mobile-formation-btn" class="mobile-formation-fab">4-2-3-1</button>
    <button id="mobile-player-list-btn" class="mobile-fab bottom-left">ğŸ‘¥</button>
    <!-- æ—¢å­˜ã® #mode-toggle-btn ã¯ãã®ã¾ã¾ä½¿ã„ã€CSSã§ä½ç½®ã‚’èª¿æ•´ã—ã¾ã™ -->

    <div id="mobile-unassign-bumper">
        <span>ğŸ—‘ï¸ ãƒªã‚¹ãƒˆã«æˆ»ã™</span>
    </div>

    <div id="mobile-hamburger-menu" class="modal-overlay">
        <div class="modal-content">
             <h3>ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h3>
             <div style="display: flex; flex-direction: column; gap: 15px;">
                <button id="save-image-btn-mobile" class="btn-primary">ç”»åƒã‚’ä¿å­˜</button>
                <button id="reset-all-btn-mobile" class="btn-danger">å…¨é…ç½®ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
                <button id="share-data-btn-mobile" class="btn-secondary">ãƒªã‚¹ãƒˆã‚’å…±æœ‰ / èª­è¾¼</button>
             </div>
        </div>
    </div>
    <div class="pc-ui-wrapper">
        <div id="mobile-notice-banner">
        <div class="banner-content">
            <span class="icon">âš ï¸</span>
            <p>ç¾åœ¨ã€ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³è¡¨ç¤ºã¯é–‹ç™ºä¸­ã§ã™ã€‚ä¸€éƒ¨æ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œã—ãªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</p>
        </div>
        <button id="close-notice-btn" title="é–‰ã˜ã‚‹">&times;</button>
    </div>
    <div class="sidebar-handle"></div>
    <div class="container">
        <div class="left-panel">
            <div id="player-management-section-left" class="control-group"></div>
        </div>
        
        <div class="main-content">
            <input type="text" id="title-input" placeholder="ã‚¹ã‚¿ãƒ¡ãƒ³äºˆæƒ³">
            <div id="capture-area">
                <div class="pitch-wrapper vertical" id="pitch-wrapper">
                    <div class="capture-title" id="capture-title"></div>
                    <div class="pitch" id="pitch"></div>
                </div>
                <div class="capture-subs" id="capture-subs"></div>
                <div id="capture-watermark" class="capture-watermark"></div>
            </div>
        </div>

        <aside class="right-panel">
             <div class="app-branding">
                <h2>XISync</h2>
            </div>

            <div class="control-group">
                <label>ãƒ”ãƒƒãƒã®å‘ã</label>
                <div class="orientation-toggle">
                    <input type="radio" id="orientation-v" name="orientation" value="vertical" checked><label for="orientation-v">ç¸¦</label>
                    <input type="radio" id="orientation-h" name="orientation" value="horizontal"><label for="orientation-h">æ¨ª</label>
                </div>
            </div>
            <div class="control-group">
                <label>ãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³</label>
                <button id="open-formation-modal-btn" class="btn-secondary"></button>
            </div>

            <div id="player-management-section" class="control-group" style="gap: 25px;">
                <div class="control-group">
                    <label>é¸æ‰‹ç®¡ç†</label>
                    <div id="player-list-controls">
                        <button id="open-sidebar-btn" class="btn-primary">
                             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M15.78 4.33C15.42 4.08 15 4 14.56 4h-5.12c-.44 0-.82.08-1.18.33L3 7.84V19c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V7.84l-5.22-3.51zM10 16H8v-2h2v2zm0-4H8v-2h2v2zm6 4h-2v-2h2v2zm0-4h-2v-2h2v2z"></path></svg>
                            <span>é¸æ‰‹ãƒªã‚¹ãƒˆã‚’é–‹ã</span>
                        </button>
                        <button id="share-data-btn" class="btn-secondary" style="margin-top: 10px; font-size: 14px; padding: 10px;">ãƒªã‚¹ãƒˆã‚’å…±æœ‰ / èª­è¾¼</button>
                    </div>
                </div>
                <div class="control-group">
                    <label>æ§ãˆé¸æ‰‹</label>
                    <div id="substitutes-container">
                        <div class="sub-drop-zone" data-pos-category="ALL"></div>
                    </div>
                </div>
            </div>
            
            <div class="control-group">
                <label>æ“ä½œ</label>
                <button id="save-image-btn" class="btn-primary">ç”»åƒã‚’ä¿å­˜ã™ã‚‹</button>
                <button id="reset-all-btn" class="btn-danger" style="margin-top: 10px;">å…¨é…ç½®ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
        </aside>
    </div>

    <!-- Sidebar, Modals, FAB -->
    <div id="player-list-sidebar">
        <div class="sidebar-header">
            <div class="title-bar">
                <h3>é¸æ‰‹ãƒªã‚¹ãƒˆ</h3>
                <button class="pin-sidebar-btn" title="ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’å›ºå®š">ğŸ“Œ</button>
            </div>
        </div>
        <div class="sidebar-add-player">
            <div class="add-player-form">
                <input type="number" id="sidebar-new-player-number" placeholder="No." min="1" inputmode="numeric" style="ime-mode: inactive;">
                <input type="text" id="sidebar-new-player-name" placeholder="é¸æ‰‹å">
                <select id="sidebar-new-player-pos" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                    <option value="FW">FW</option>
                    <option value="MF">MF</option>
                    <option value="DF">DF</option>
                    <option value="GK">GK</option>
                </select>
                <button id="sidebar-add-player-btn" class="btn-primary">+</button>
            </div>
        </div>
        <div id="sidebar-player-list"></div>
    </div>        

    <div class="modal-overlay" id="formation-modal">
        <div class="modal-content">
            <button class="modal-close-btn">&times;</button>
            <h3>ãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é¸æŠ</h3>
            <div id="formation-grid"></div>
        </div>
    </div>
    
    <div class="modal-overlay" id="edit-player-modal">
        <div class="modal-content">
            <button class="modal-close-btn">&times;</button>
            <h3>é¸æ‰‹æƒ…å ±ã®ç·¨é›†</h3>
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <div class="form-group">
                    <label for="edit-player-number">èƒŒç•ªå·</label>
                    <div class="number-input-wrapper">
                        <button id="decrement-btn" class="number-input-btn">-</button>
                        <input type="number" id="edit-player-number" inputmode="numeric" style="ime-mode: inactive;">
                        <button id="increment-btn" class="number-input-btn">+</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="edit-player-name">é¸æ‰‹å</label>
                    <input type="text" id="edit-player-name">
                </div>
                <div class="form-group">
                    <label for="edit-player-pos">ãƒã‚¸ã‚·ãƒ§ãƒ³</label>
                    <select id="edit-player-pos" style="width: 100%; padding: 12px; font-size: 16px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box;">
                        <option value="FW">FW</option>
                        <option value="MF">MF</option>
                        <option value="DF">DF</option>
                        <option value="GK">GK</option>
                    </select>
                </div>
                <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;">
                    <button id="save-player-changes-btn" class="btn-primary">å¤‰æ›´ã‚’ä¿å­˜</button>
                    <button id="delete-player-btn-modal" class="btn-danger">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
                        <span>ã“ã®é¸æ‰‹ã‚’å‰Šé™¤ã™ã‚‹</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="share-modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn">&times;</button>
            <h3>é¸æ‰‹ãƒªã‚¹ãƒˆã®å…±æœ‰ / èª­ã¿è¾¼ã¿</h3>
            <div class="share-section">
                <div class="share-section-title">ãƒªã‚¹ãƒˆã‚’å‡ºåŠ›</div>
                <div class="share-actions" style="flex-direction: column; gap: 10px;">
                    <button id="copy-url-btn" class="btn-primary">URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦å…±æœ‰</button>
                    <button id="copy-squad-btn" class="btn-secondary">ãƒ†ã‚­ã‚¹ãƒˆ(ãƒ‡ãƒ¼ã‚¿)ã‚’ã‚³ãƒ”ãƒ¼</button>
                    <button id="export-squad-btn" class="btn-secondary">ãƒ•ã‚¡ã‚¤ãƒ«ã§ä¿å­˜</button>
                </div>
            </div>
            <div class="share-section">
                <div class="share-section-title">ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿</div>
                <div class="share-actions">
                    <button id="import-from-clipboard-btn" class="btn-primary">ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰èª­è¾¼</button>
                    <label for="import-squad-input" class="btn-secondary">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦èª­è¾¼</label>
                    <input type="file" id="import-squad-input" accept=".json, .txt">
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="import-confirm-modal">
        <div class="modal-content">
            <h3>é¸æ‰‹ãƒªã‚¹ãƒˆã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h3>
            <p>å…±æœ‰ã•ã‚ŒãŸé¸æ‰‹ãƒ‡ãƒ¼ã‚¿ã§ç¾åœ¨ã®ãƒªã‚¹ãƒˆã‚’ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿé…ç½®ã¯ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚</p>
            <div id="import-preview-list" style="max-height: 200px; overflow-y: auto; border: 1px solid #eee; padding: 10px; margin-bottom: 20px; border-radius: 6px;">
            </div>
            <div style="display: flex; gap: 10px;">
                <button id="confirm-import-btn" class="btn-primary" style="flex: 1;">ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹</button>
                <button id="cancel-import-btn" class="btn-secondary" style="flex: 1;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>
    
    <div class="drag-ghost" id="drag-ghost"></div>

    <button id="mode-toggle-btn" class="mode-toggle-fab" title="ãƒãƒ¼ã‚«ãƒ¼æ“ä½œãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿"></button>
    <div id="mode-toast" class="mode-toast"></div>
</div>

<script>
// --- PWA Service Worker Registration ---
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js')
        .then(reg => console.log('Service Worker registered successfully:', reg.scope))
        .catch(err => console.log('Service Worker registration failed:', err));
}


document.addEventListener('DOMContentLoaded', () => {
    
const App = {
    els: {},
    isMobile: false, 
    isDraggingPlayer: false,
    _lastDragStartType: null,
    state: {
        squad: [],
        starters: {}, // { "posId": { playerId, coords }, ... }
        substitutes: { GK: [], DF: [], MF: [], FW: [] },
        config: {
            orientation: 'vertical',
            formation: '4-2-3-1',
            dragMode: 'swap',
            title: ''
        },
    },

    editingPlayerId: null,
    toastTimer: null,
    numberChangeInterval: null,
    _importedSquadData: null,
    sidebarHoverTimer: null,

    init() {
        this.isMobile = window.innerWidth <= 768; 
        if (this.isMobile) {
        this.els.body.classList.add('is-mobile');
        }
        this.cacheElements();
        this.setupNoticeBanner(); 
        this.defineConstants();
        this.clonePanels();
        this.loadState();
        this.checkUrlForSquadData();
        this.buildFormationModal();
        this.bindEvents();
        this.renderAll();
    },
    
    setupNoticeBanner() {
        const noticeBanner = document.getElementById('mobile-notice-banner');
        const closeNoticeBtn = document.getElementById('close-notice-btn');
        if (noticeBanner && closeNoticeBtn) {
            if (sessionStorage.getItem('mobileNoticeClosed') === 'true') {
                noticeBanner.style.display = 'none';
            }
            closeNoticeBtn.addEventListener('click', () => {
                noticeBanner.style.display = 'none';
                sessionStorage.setItem('mobileNoticeClosed', 'true');
            });
        }
    },

    cacheElements() {
        const query = (selector) => document.querySelector(selector);
        const queryAll = (selector) => document.querySelectorAll(selector);
        this.els = {
            body: document.body, pitch: query('#pitch'), pitchWrapper: query('#pitch-wrapper'),
            saveImageBtn: query('#save-image-btn'), dragGhost: query('#drag-ghost'),
            orientationRadios: document.getElementsByName('orientation'), titleInput: query('#title-input'),
            playerManagementSectionLeft: query('#player-management-section-left'),
            playerManagementSectionRight: query('#player-management-section'),
            panels: {
                left: { subDropZones: queryAll('.left-panel .sub-drop-zone') },
                right: { openFormationModalBtn: query('.right-panel #open-formation-modal-btn'), subDropZones: queryAll('.right-panel .sub-drop-zone'), resetAllBtn: query('#reset-all-btn') }
            },
            shareModal: {
                overlay: query('#share-modal-overlay'), copyUrlBtn: query('#copy-url-btn'),
                copySquadBtn: query('#copy-squad-btn'), exportSquadBtn: query('#export-squad-btn'),
                importSquadInput: query('#import-squad-input'), importFromClipboardBtn: query('#import-from-clipboard-btn')
            },
            sidebar: {
                el: query('#player-list-sidebar'), list: query('#sidebar-player-list'),
                addBtn: query('#sidebar-add-player-btn'), numberInput: query('#sidebar-new-player-number'),
                nameInput: query('#sidebar-new-player-name'), posSelect: query('#sidebar-new-player-pos')
            },
            editModal: {
                overlay: query('#edit-player-modal'), numberInput: query('#edit-player-number'),
                nameInput: query('#edit-player-name'), posSelect: query('#edit-player-pos'), saveBtn: query('#save-player-changes-btn'),
                deleteBtn: query('#delete-player-btn-modal'), incrementBtn: query('#increment-btn'), decrementBtn: query('#decrement-btn')
            },
            importConfirmModal: {
                overlay: query('#import-confirm-modal'), previewList: query('#import-preview-list'),
                confirmBtn: query('#confirm-import-btn'), cancelBtn: query('#cancel-import-btn')
            },
            formationModal: { overlay: query('#formation-modal'), grid: query('#formation-grid') },
            modeToggleBtn: query('#mode-toggle-btn'), modeToast: query('#mode-toast'),
            sidebarHandle: query('.sidebar-handle'),
            pinSidebarBtn: query('.pin-sidebar-btn'),
        mobile: {
            header: query('.mobile-header'),
            titleInput: query('#mobile-title-input'),
            hamburgerBtn: query('#mobile-hamburger-btn'),
            hamburgerMenu: query('#mobile-hamburger-menu'),
            saveImageBtn: query('#save-image-btn-mobile'),
            resetAllBtn: query('#reset-all-btn-mobile'),
            shareDataBtn: query('#share-data-btn-mobile'),
            subsArea: query('#mobile-subs-area'),
            playerListPanel: query('#mobile-player-list-panel'),
            playerListGrid: query('#panel-player-list-grid'),
            addPlayerBtn: query('#add-player-btn-mobile'),
            formationBtn: query('#mobile-formation-btn'),
            playerListBtn: query('#mobile-player-list-btn'),
            unassignBumper: query('#mobile-unassign-bumper')
        }
        };
        this.els.allModals = queryAll('.modal-overlay');
        this.els.allCloseBtns = queryAll('.modal-close-btn');
    },

    defineConstants() {
        this.formations = {'4-3-3':{name:'4-3-3',note:'',spec:[{pos:'GK'},{pos:'RSB'},{pos:'RCB'},{pos:'LCB'},{pos:'LSB'},{pos:'DMF'},{pos:'RCM'},{pos:'LCM'},{pos:'RWG'},{pos:'CF'},{pos:'LWG'}]},'4-4-2':{name:'4-4-2',note:'',spec:[{pos:'GK'},{pos:'RSB'},{pos:'RCB'},{pos:'LCB'},{pos:'LSB'},{pos:'RMF'},{pos:'CMF'},{pos:'CMF',isDuplicate:true},{pos:'LMF'},{pos:'FW'},{pos:'FW',isDuplicate:true}]},'4-2-3-1':{name:'4-2-3-1',note:'Standard',spec:[{pos:'GK'},{pos:'RSB'},{pos:'RCB'},{pos:'LCB'},{pos:'LSB'},{pos:'DMF'},{pos:'DMF',isDuplicate:true},{pos:'RMF'},{pos:'AMF'},{pos:'LMF'},{pos:'CF'}]},'4-1-4-1':{name:'4-1-4-1',note:'',spec:[{pos:'GK'},{pos:'RSB'},{pos:'RCB'},{pos:'LCB'},{pos:'LSB'},{pos:'DMF'},{pos:'RMF'},{pos:'RCM'},{pos:'LCM'},{pos:'LMF'},{pos:'CF'}]},'4-3-1-2':{name:'4-3-1-2',note:'Diamond',spec:[{pos:'GK'},{pos:'RSB'},{pos:'RCB'},{pos:'LCB'},{pos:'LSB'},{pos:'DMF'},{pos:'RCM'},{pos:'LCM'},{pos:'AMF'},{pos:'FW'},{pos:'FW',isDuplicate:true}]},'4-3-2-1':{name:'4-3-2-1',note:'Tree',spec:[{pos:'GK'},{pos:'RSB'},{pos:'RCB'},{pos:'LCB'},{pos:'LSB'},{pos:'RCM'},{pos:'CMF'},{pos:'LCM'},{pos:'RAM'},{pos:'LAM'},{pos:'CF'}]},'3-5-2':{name:'3-5-2',note:'',spec:[{pos:'GK'},{pos:'RCB'},{pos:'CB'},{pos:'LCB'},{pos:'RWB'},{pos:'RCM'},{pos:'DMF'},{pos:'LCM'},{pos:'LWB'},{pos:'FW'},{pos:'FW',isDuplicate:true}]},'3-4-3':{name:'3-4-3',note:'',spec:[{pos:'GK'},{pos:'RCB'},{pos:'CB'},{pos:'LCB'},{pos:'RMF'},{pos:'CMF'},{pos:'CMF',isDuplicate:true},{pos:'LMF'},{pos:'RWG'},{pos:'CF'},{pos:'LWG'}]},'3-4-2-1':{name:'3-4-2-1',note:'',spec:[{pos:'GK'},{pos:'RCB'},{pos:'CB'},{pos:'LCB'},{pos:'RWB'},{pos:'DMF'},{pos:'DMF',isDuplicate:true},{pos:'LWB'},{pos:'RAM'},{pos:'LAM'},{pos:'CF'}]},'5-3-2':{name:'5-3-2',note:'',spec:[{pos:'GK'},{pos:'RCB'},{pos:'CB'},{pos:'LCB'},{pos:'RWB'},{pos:'LWB'},{pos:'RCM'},{pos:'CMF'},{pos:'LCM'},{pos:'FW'},{pos:'FW',isDuplicate:true}]},'5-4-1':{name:'5-4-1',note:'',spec:[{pos:'GK'},{pos:'RSB'},{pos:'RCB'},{pos:'CB'},{pos:'LCB'},{pos:'LSB'},{pos:'RMF'},{pos:'RCM'},{pos:'LCM'},{pos:'LMF'},{pos:'CF'}]}};
        this.formationCoords = {'4-3-3':[{top:50,left:8},{top:85,left:28},{top:65,left:25},{top:35,left:25},{top:15,left:28},{top:50,left:48},{top:70,left:60},{top:30,left:60},{top:80,left:80},{top:50,left:85},{top:20,left:80}],'4-4-2':[{top:50,left:8},{top:85,left:28},{top:65,left:25},{top:35,left:25},{top:15,left:28},{top:85,left:55},{top:60,left:50},{top:40,left:50},{top:15,left:55},{top:65,left:78},{top:35,left:78}],'4-2-3-1':[{top:50,left:8},{top:85,left:28},{top:65,left:25},{top:35,left:25},{top:15,left:28},{top:65,left:48},{top:35,left:48},{top:80,left:70},{top:50,left:72},{top:20,left:70},{top:50,left:88}],'4-1-4-1':[{top:50,left:8},{top:85,left:28},{top:65,left:25},{top:35,left:25},{top:15,left:28},{top:50,left:45},{top:85,left:65},{top:65,left:62},{top:35,left:62},{top:15,left:65},{top:50,left:85}],'4-3-1-2':[{top:50,left:8},{top:85,left:28},{top:65,left:25},{top:35,left:25},{top:15,left:28},{top:50,left:45},{top:75,left:55},{top:25,left:55},{top:50,left:70},{top:65,left:85},{top:35,left:85}],'4-3-2-1':[{top:50,left:8},{top:85,left:28},{top:65,left:25},{top:35,left:25},{top:15,left:28},{top:70,left:55},{top:50,left:50},{top:30,left:55},{top:65,left:75},{top:35,left:75},{top:50,left:88}],'3-5-2':[{top:50,left:8},{top:75,left:28},{top:50,left:25},{top:25,left:28},{top:90,left:55},{top:70,left:50},{top:50,left:42},{top:30,left:50},{top:10,left:55},{top:65,left:82},{top:35,left:82}],'3-4-3':[{top:50,left:8},{top:75,left:28},{top:50,left:25},{top:25,left:28},{top:85,left:58},{top:65,left:52},{top:35,left:52},{top:15,left:58},{top:80,left:80},{top:50,left:85},{top:20,left:80}],'3-4-2-1':[{top:50,left:8},{top:75,left:28},{top:50,left:25},{top:25,left:28},{top:85,left:58},{top:65,left:50},{top:35,left:50},{top:15,left:58},{top:65,left:78},{top:35,left:78},{top:50,left:88}],'5-3-2':[{top:50,left:8},{top:75,left:28},{top:50,left:25},{top:25,left:28},{top:90,left:35},{top:10,left:35},{top:75,left:60},{top:50,left:55},{top:25,left:60},{top:65,left:82},{top:35,left:82}],'5-4-1':[{top:50,left:8},{top:90,left:28},{top:70,left:25},{top:50,left:22},{top:30,left:25},{top:10,left:28},{top:85,left:58},{top:60,left:52},{top:40,left:52},{top:15,left:58},{top:50,left:82}]};
        this.svgIcons = {position:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M7.646.146a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 1.707V5.5a.5.5 0 0 1-1 0V1.707L6.354 2.854a.5.5 0 1 1-.708-.708l2-2zM8 10a.5.5 0 0 1 .5.5v3.793l1.146-1.147a.5.5 0 0 1 .708.708l-2 2a.5.5 0 0 1-.708 0l-2-2a.5.5 0 0 1 .708-.708L7.5 14.293V10.5A.5.5 0 0 1 8 10zM.146 8.354a.5.5 0 0 1 0-.708l2-2a.5.5 0 1 1 .708.708L1.707 7.5H5.5a.5.5 0 0 1 0 1H1.707l1.147 1.146a.5.5 0 0 1-.708.708l-2-2zM10 8a.5.5 0 0 1 .5-.5h3.793l-1.147-1.146a.5.5 0 0 1 .708-.708l2 2a.5.5 0 0 1 0 .708l-2 2a.5.5 0 0 1-.708-.708L14.293 8.5H10.5A.5.5 0 0 1 10 8z"/></svg>',swap:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1 11.5a.5.5 0 0 0 .5.5h11.793l-1.147 1.146a.5.5 0 0 0 .708.708l2-2a.5.5 0 0 0 0-.708l-2-2a.5.5 0 0 0-.708.708L13.293 11H1.5a.5.5 0 0 0-.5.5zm14-7a.5.5 0 0 1-.5.5H2.707l1.147 1.146a.5.5 0 1 1-.708.708l-2-2a.5.5 0 0 1 0-.708l2-2a.5.5 0 1 1 .708.708L2.707 4H14.5a.5.5 0 0 1 .5.5z"/></svg>'};
    },

    clonePanels() {
        this.els.playerManagementSectionLeft.innerHTML = this.els.playerManagementSectionRight.innerHTML;
        this.cacheElements(); 
        this.els.allShareBtns = document.querySelectorAll('#share-data-btn');
        this.els.allOpenSidebarBtns = document.querySelectorAll('#open-sidebar-btn');
    },
    
    bindEvents() {
        document.addEventListener('dragend', this.handleDragEnd.bind(this));
            if (this.isMobile) {
        // Title sync
        this.els.mobile.titleInput.addEventListener('input', (e) => this.els.titleInput.value = e.target.value);
        this.els.titleInput.addEventListener('input', (e) => this.els.mobile.titleInput.value = e.target.value);

        // Hamburger Menu
        this.els.mobile.hamburgerBtn.addEventListener('click', () => this.openModal(this.els.mobile.hamburgerMenu));
        this.els.mobile.hamburgerMenu.addEventListener('click', (e) => {
            if (e.target === this.els.mobile.hamburgerMenu) this.closeAllModals();
        });
        this.els.mobile.saveImageBtn.addEventListener('click', this.saveImage.bind(this));
        this.els.mobile.resetAllBtn.addEventListener('click', this.resetAllAssignments.bind(this));
        this.els.mobile.shareDataBtn.addEventListener('click', () => { this.closeAllModals(); this.openModal(this.els.shareModal.overlay); });

        // Player List Panel
        this.els.mobile.playerListBtn.addEventListener('click', () => {
            this.els.mobile.playerListPanel.classList.toggle('is-open');
        });
        this.els.mobile.addPlayerBtn.addEventListener('click', () => {
            this.editingPlayerId = null; // æ–°è¦è¿½åŠ ãƒ¢ãƒ¼ãƒ‰ã«è¨­å®š
            this.els.editModal.numberInput.value = '';
            this.els.editModal.nameInput.value = '';
            this.els.editModal.posSelect.value = 'FW';
            this.openModal(this.els.editModal.overlay);
            this.els.mobile.playerListPanel.classList.remove('is-open'); // ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹
        });

        // Formation Popover
        this.els.mobile.formationBtn.addEventListener('click', () => {
            this.buildFormationModal(); // Logic will be modified to use popover on mobile
            this.openModal(this.els.formationModal.overlay); // Temporarily uses existing modal
        });
        
        // Unassign Bumper drag events
        this.els.mobile.unassignBumper.addEventListener('dragover', (e) => {
            e.preventDefault();
            this.els.mobile.unassignBumper.classList.add('is-droppable');
        });
         this.els.mobile.unassignBumper.addEventListener('dragleave', () => {
            this.els.mobile.unassignBumper.classList.remove('is-droppable');
        });
         this.els.mobile.unassignBumper.addEventListener('drop', (e) => {
            e.preventDefault();
            const data = JSON.parse(e.dataTransfer.getData('application/json'));
            if (data.playerId) {
                this.unassignPlayer(data.playerId);
                this.renderAll();
            }
            this.els.mobile.unassignBumper.classList.remove('is-droppable');
        });
        return; // PCç”¨ã®ã‚¤ãƒ™ãƒ³ãƒˆã¯ãƒã‚¤ãƒ³ãƒ‰ã—ãªã„
    }
        // --- ã‚µã‚¤ãƒ‰ãƒãƒ¼ä»¥å¤–ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
        [...this.els.orientationRadios].forEach(radio => radio.addEventListener('change', e => { this.state.config.orientation = e.target.value; this.renderAll(); }));
        this.els.allShareBtns.forEach(btn => btn.addEventListener('click', () => this.openModal(this.els.shareModal.overlay)));
        if (this.els.panels.right.resetAllBtn) this.els.panels.right.resetAllBtn.addEventListener('click', this.resetAllAssignments.bind(this));
        if (this.els.panels.right.openFormationModalBtn) this.els.panels.right.openFormationModalBtn.addEventListener('click', () => { this.buildFormationModal(); this.openModal(this.els.formationModal.overlay); });

        this.els.sidebar.addBtn.addEventListener('click', this.addPlayer.bind(this));
        this.els.sidebar.nameInput.addEventListener('keypress', e => e.key === 'Enter' && this.addPlayer());

        this.els.allModals.forEach(modal => modal.addEventListener('click', e => e.target === modal && this.closeAllModals()));
        this.els.allCloseBtns.forEach(btn => btn.addEventListener('click', this.closeAllModals.bind(this)));

        this.els.editModal.saveBtn.addEventListener('click', this.savePlayerChanges.bind(this));
        this.els.editModal.deleteBtn.addEventListener('click', this.deletePlayerFromModal.bind(this));
        this.els.editModal.incrementBtn.addEventListener('click', () => this.changeNumber(1));
        this.els.editModal.decrementBtn.addEventListener('click', () => this.changeNumber(-1));
        ['mousedown', 'touchstart'].forEach(evt => {
            this.els.editModal.incrementBtn.addEventListener(evt, () => this.numberChangeInterval = setInterval(() => this.changeNumber(1), 100));
            this.els.editModal.decrementBtn.addEventListener(evt, () => this.numberChangeInterval = setInterval(() => this.changeNumber(-1), 100));
        });
        ['mouseup', 'mouseleave', 'touchend'].forEach(evt => {
            document.addEventListener(evt, () => clearInterval(this.numberChangeInterval));
        });

        this.els.shareModal.copyUrlBtn.addEventListener('click', this.copySquadUrlToClipboard.bind(this));
        this.els.shareModal.copySquadBtn.addEventListener('click', this.copySquadToClipboard.bind(this));
        this.els.shareModal.exportSquadBtn.addEventListener('click', this.exportSquadToFile.bind(this));
        this.els.shareModal.importSquadInput.addEventListener('change', this.importFromFile.bind(this));
        this.els.shareModal.importFromClipboardBtn.addEventListener('click', this.importFromClipboard.bind(this));
        
        this.els.importConfirmModal.confirmBtn.addEventListener('click', this.confirmImport.bind(this));
        this.els.importConfirmModal.cancelBtn.addEventListener('click', () => { this.closeAllModals(); history.replaceState(null, '', window.location.pathname); });

        this.els.modeToggleBtn.addEventListener('click', this.toggleDragMode.bind(this));
        this.els.saveImageBtn.addEventListener('click', this.saveImage.bind(this));

        document.querySelectorAll('.sub-drop-zone').forEach(zone => {
            zone.addEventListener('dragover', this.handleDragOver.bind(this));
            zone.addEventListener('dragleave', this.handleDragLeave.bind(this));
            zone.addEventListener('drop', this.handleDropOnSubZone.bind(this));
        });
        
        let titleSaveTimeout;
        this.els.titleInput.addEventListener('input', () => { clearTimeout(titleSaveTimeout); titleSaveTimeout = setTimeout(() => this.saveState(), 500); });
        
        // --- æ–°ã—ã„ã‚µã‚¤ãƒ‰ãƒãƒ¼æ“ä½œã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— ---
        this.setupSidebarControls();
    },
    
    saveState() {
        this.state.config.title = this.els.titleInput.value;
        localStorage.setItem("xisyncAppState", JSON.stringify(this.state));
    },

    loadState() {
        const savedStateJSON = localStorage.getItem("xisyncAppState");
        if (savedStateJSON) {
            try {
                const savedState = JSON.parse(savedStateJSON);
                Object.assign(this.state, savedState);
                this.state.config = {
                    ...{ orientation: "vertical", formation: "4-2-3-1", dragMode: "swap", title: "" },
                    ...savedState.config
                };
                this.state.substitutes = savedState.substitutes || { GK: [], DF: [], MF: [], FW: [] };
            } catch (e) {
                console.error("Failed to load state:", e);
            }
        }
    },

// é–‹å§‹
updateUI() {
    this.els.titleInput.value = this.state.config.title;
    this.els.body.dataset.dragMode = this.state.config.dragMode;
    this.els.modeToggleBtn.innerHTML = this.svgIcons[this.state.config.dragMode];
    
    if (this.isMobile) {
        // Mobile UI updates
        this.els.mobile.titleInput.value = this.state.config.title;
        this.els.mobile.formationBtn.textContent = this.formations[this.state.config.formation].name;
    } else {
        // PC specific UI updates
        document.querySelector(`input[name="orientation"][value="${this.state.config.orientation}"]`).checked = true;
        this.els.body.dataset.layoutMode = this.state.config.orientation;
        this.els.panels.right.openFormationModalBtn.textContent = this.formations[this.state.config.formation].name;
    }
},
// çµ‚äº†

    renderAll() {
        this.updateUI();
        this.renderFormation();
        this.renderPlayerList();
        this.renderSubstitutes();
        this.saveState();
    },

    renderFormation() {
        this.els.pitchWrapper.className = `pitch-wrapper ${this.state.config.orientation}`;
        this.els.pitch.innerHTML = '<div class="pitch-line center-line"></div><div class="pitch-line center-circle"></div><div class="pitch-line goal-area"></div><div class="pitch-line penalty-area"></div><div class="pitch-line penalty-arc"></div><div class="pitch-line goal"></div>';
        
        const formationSpec = this.formations[this.state.config.formation].spec;
        const formationCoords = this.formationCoords[this.state.config.formation];
        
        formationSpec.forEach((spec, index) => {
            const posId = `${spec.pos}_${spec.isDuplicate ? index : 1}`;
            this.createPlayerMarker(spec, formationCoords[index], posId);
        });
    },

// ä¿®æ­£ç®‡æ‰€: createPlayerMarker ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ã€ä»¥ä¸‹ã®å®Œå…¨ãªã‚³ãƒ¼ãƒ‰ã§ä¸¸ã”ã¨ç½®ãæ›ãˆã¦ãã ã•ã„ã€‚

createPlayerMarker(posSpec, defaultCoords, posId) {
    const markerEl = document.createElement('div');
    markerEl.className = 'player-container';
    markerEl.dataset.posId = posId;

    const starter = this.state.starters[posId];
    const currentCoords = starter?.coords ?? defaultCoords;

    if (this.state.config.orientation === 'vertical') {
        markerEl.style.top = `${100 - (currentCoords.left * 0.9)}%`;
        markerEl.style.left = `${currentCoords.top}%`;
    } else {
        markerEl.style.top = `${currentCoords.top}%`;
        markerEl.style.left = `${currentCoords.left * 0.9}%`;
    }

    const player = starter ? this.state.squad.find(p => p.id === starter.playerId) : null;
    const role = this.getRole(posSpec.pos);
    
    // playerã®å­˜åœ¨æœ‰ç„¡ã§ is-empty ã‚¯ãƒ©ã‚¹ã‚’åˆ¶å¾¡
    if (!player) {
        markerEl.classList.add('is-empty');
    }

    markerEl.innerHTML = `
        <div class="player-marker ${role}">
            <span class="player-number">${player?.number ?? ''}</span>
            <span class="player-pos">${posSpec.pos}</span>
        </div>
        <div class="player-name">${player?.name ?? posSpec.pos}</div>`;
        
    markerEl.addEventListener('dragover', this.handleDragOver.bind(this));
    markerEl.addEventListener('dragleave', this.handleDragLeave.bind(this));
    markerEl.addEventListener('drop', (e) => this.handleDropOnPitch(e, posId));

    if (player) {
        if (this.state.config.dragMode === 'position') {
            this.makeMarkerMovable(markerEl);
            markerEl.draggable = false;
        } else {
            markerEl.draggable = true;
            markerEl.addEventListener('dragstart', (e) => this.handleDragStart(e, { type: 'pitch', posId: posId, playerId: player.id }));
        }
        const unassignBtn = document.createElement('button');
        unassignBtn.innerHTML = '&times;';
        unassignBtn.className = 'unassign-btn';
        unassignBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            this.unassignPlayer(player.id);
            this.renderAll();
        });
        markerEl.appendChild(unassignBtn);
    }
    this.els.pitch.appendChild(markerEl);
},
    
    getRole(pos) {
        if (pos === 'GK') return 'gk';
        if (['B', 'SB', 'CB'].some(p => pos.includes(p))) return 'df';
        if (['MF', 'WB', 'AM', 'CM', 'DM'].some(p => pos.includes(p))) return 'mf';
        return 'fw';
    },

    makeMarkerMovable(marker) {
        const handleMouseDown = (e) => {
            if (e.target.tagName !== 'DIV' || !e.target.classList.contains('player-marker')) return;
            marker.classList.add('is-moving');

            const handleMouseMove = (moveEvent) => {
                const pitchRect = this.els.pitch.getBoundingClientRect();
                const newLeft = Math.max(0, Math.min(100, (moveEvent.clientX - pitchRect.left) / pitchRect.width * 100));
                const newTop = Math.max(0, Math.min(100, (moveEvent.clientY - pitchRect.top) / pitchRect.height * 100));
                marker.style.left = `${newLeft}%`;
                marker.style.top = `${newTop}%`;
            };
            const handleMouseUp = () => {
                marker.classList.remove('is-moving');
                document.removeEventListener('mousemove', handleMouseMove);
                
                const posId = marker.dataset.posId;
                const newLeftPercent = parseFloat(marker.style.left);
                const newTopPercent = parseFloat(marker.style.top);
                
                if (this.state.config.orientation === 'vertical') {
                    this.state.starters[posId].coords = { top: newLeftPercent, left: (100 - newTopPercent) / 0.9 };
                } else {
                    this.state.starters[posId].coords = { top: newTopPercent, left: newLeftPercent / 0.9 };
                }
                this.saveState();
            };
            
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp, { once: true });
        };
        marker.addEventListener('mousedown', handleMouseDown);
    },

// é–‹å§‹
// ä¿®æ­£ç®‡æ‰€: renderPlayerList ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä¸¸ã”ã¨ç½®ãæ›ãˆ

renderPlayerList() {
    const assignedPlayerIds = new Set([
        ...Object.values(this.state.starters).map(s => s.playerId),
        ...Object.values(this.state.substitutes).flat()
    ]);

    if (this.isMobile) {
        // â–¼â–¼â–¼ ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ç”¨ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å‡¦ç† â–¼â–¼â–¼
        const gridContainer = this.els.mobile.playerListGrid;
        gridContainer.innerHTML = '';

        if (this.state.squad.length === 0) {
            gridContainer.innerHTML = '<p style="color:#888; grid-column: 1 / -1; text-align: center;">é¸æ‰‹ãŒã„ã¾ã›ã‚“ã€‚<br>ã€Œ+ã€ãƒœã‚¿ãƒ³ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>';
            return;
        }

        this.state.squad.sort((a, b) => a.number - b.number).forEach(player => {
            const isAssigned = assignedPlayerIds.has(player.id);
            const itemEl = document.createElement('div');
            itemEl.className = `list-player-item ${isAssigned ? 'is-assigned' : ''}`;
            
            if (!isAssigned) {
                itemEl.draggable = true;
                itemEl.addEventListener('dragstart', (e) => this.handleDragStart(e, { type: 'list', playerId: player.id }));
            }

            const role = (player.posCategory || 'fw').toLowerCase();
            itemEl.innerHTML = `
                <div class="list-player-marker ${role}">
                    <span class="list-player-number">${player.number}</span>
                    <span class="list-player-name">${player.name}</span>
                </div>`;
            
            // é•·æŠ¼ã—ã§ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
            let longPressTimer;
            const cancelLongPress = () => clearTimeout(longPressTimer);
            itemEl.addEventListener('touchstart', (e) => {
                 if (isAssigned) return;
                 longPressTimer = setTimeout(() => { 
                     navigator.vibrate?.(50); 
                     this.openEditModal(player.id); 
                 }, 600);
            }, { passive: true });
            itemEl.addEventListener('touchend', cancelLongPress);
            itemEl.addEventListener('touchmove', cancelLongPress);

            gridContainer.appendChild(itemEl);
        });
        return; 
    }

    // â–¼â–¼â–¼ PCç”¨ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å‡¦ç† (å¤‰æ›´ãªã—) â–¼â–¼â–¼
    const listContainer = this.els.sidebar.list;
    // (ä»¥ä¸‹ã€æ—¢å­˜ã®PCç”¨ã‚³ãƒ¼ãƒ‰)
    listContainer.innerHTML = '';
    if (this.state.squad.length === 0) {
        listContainer.className = 'is-empty';
        listContainer.textContent = 'ä¸Šã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰é¸æ‰‹ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚';
        return;
    }
    listContainer.className = '';
    
    this.state.squad.sort((a, b) => a.number - b.number).forEach(player => {
        const isAssigned = assignedPlayerIds.has(player.id);
        const itemEl = document.createElement('div');
        itemEl.className = `player-list-item ${isAssigned ? 'is-assigned' : ''}`;
        itemEl.dataset.playerId = player.id;
        itemEl.innerHTML = `
            <span class="num">${player.number}</span>
            <div class="name">
                <span>${player.name}</span>
                <button class="edit-player-btn" title="ç·¨é›†">âœï¸</button>
            </div>`;
        
        itemEl.querySelector('.edit-player-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            this.openEditModal(player.id);
        });

        if (!isAssigned) {
            itemEl.draggable = true;
            itemEl.addEventListener('dragstart', (e) => this.handleDragStart(e, { type: 'list', playerId: player.id }));
        }

        itemEl.addEventListener('dblclick', () => {
            this.openEditModal(player.id);
        });

        let longPressTimer;
        const cancelLongPress = () => clearTimeout(longPressTimer);
        const startLongPress = (e) => {
            if (e.target.closest('.edit-player-btn')) return;
            longPressTimer = setTimeout(() => {
                navigator.vibrate?.(50);
                this.openEditModal(player.id);
                longPressTimer = null; 
            }, 500); 
        };
        itemEl.addEventListener('touchstart', startLongPress, { passive: true });
        itemEl.addEventListener('touchend', cancelLongPress);
        itemEl.addEventListener('touchmove', cancelLongPress);

        listContainer.appendChild(itemEl);
    });
},
// çµ‚äº†
// é–‹å§‹
renderSubstitutes() {
    if (this.isMobile) {
        // â–¼â–¼â–¼ ã‚¹ãƒãƒ›ç”¨ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å‡¦ç† â–¼â–¼â–¼
        const subsContainer = this.els.mobile.subsArea;
        subsContainer.innerHTML = '';

        ['GK', 'DF', 'MF', 'FW'].forEach(pos => {
            const categoryEl = document.createElement('div');
            categoryEl.className = 'sub-category-mobile';
            categoryEl.innerHTML = `<span class="sub-category-mobile-label">${pos}</span>`;
            
            const playersWrapper = document.createElement('div');
            playersWrapper.className = 'sub-players-wrapper';
            
            // ã‚«ãƒ†ã‚´ãƒªã‚¨ãƒªã‚¢è‡ªä½“ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ã«ã™ã‚‹
            categoryEl.addEventListener('dragover', this.handleDragOver.bind(this));
            categoryEl.addEventListener('dragleave', this.handleDragLeave.bind(this));
            categoryEl.addEventListener('drop', (e) => this.handleDropOnSubZone(e, pos));
            const playersInPos = (this.state.substitutes[pos] || [])
                .map(id => this.state.squad.find(p => p.id === id)).filter(Boolean);

            playersInPos.forEach(player => {
                const role = (player.posCategory || 'fw').toLowerCase();
                const chipEl = document.createElement('div');
                chipEl.className = `sub-player-chip ${role}`;
                chipEl.textContent = player.number;
                chipEl.draggable = true;
                chipEl.dataset.playerId = player.id; // ãƒ‡ãƒ¼ã‚¿å±æ€§ã‚’è¿½åŠ 
                chipEl.addEventListener('dragstart', (e) => this.handleDragStart(e, { type: 'substitute', playerId: player.id, category: pos }));
                playersWrapper.appendChild(chipEl);
            });
            categoryEl.appendChild(playersWrapper);
            subsContainer.appendChild(categoryEl);
        });
        return; // ã‚¹ãƒãƒ›ã®å ´åˆã¯ã“ã“ã§å‡¦ç†çµ‚äº†
    }

    // â–¼â–¼â–¼ ä»¥ä¸‹ã¯æ—¢å­˜ã®PCç”¨ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å‡¦ç† â–¼â–¼â–¼
    const zone = document.querySelector('.sub-drop-zone');
    zone.innerHTML = '';
    const allSubIds = Object.values(this.state.substitutes).flat();
    
    allSubIds.forEach(playerId => {
        const player = this.state.squad.find(p => p.id === playerId);
        if (!player) return;
        const subItem = document.createElement('div');
        subItem.className = 'substitute-item';
        subItem.dataset.playerId = playerId;
        subItem.draggable = true;
        subItem.addEventListener('dragstart', (e) => this.handleDragStart(e, { type: 'substitute', playerId, category: player.posCategory }));
        subItem.innerHTML = `
            <span class="num">${player.number}</span>
            <span class="name">${player.name}</span>
            <button class="unassign-btn-sub">&times;</button>`;
        subItem.querySelector('.unassign-btn-sub').addEventListener('click', (e) => {
            e.stopPropagation();
            this.unassignPlayer(playerId);
            this.renderAll();
        });
        zone.appendChild(subItem);
    });
},
// çµ‚äº†

// ä¿®æ­£ç®‡æ‰€: handleDragStart ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä¸¸ã”ã¨ç½®ãæ›ãˆ

handleDragStart(e, data) {
    this.isDraggingPlayer = true;
    this._lastDragStartType = data.type; // ã©ã®ã‚¨ãƒªã‚¢ã‹ã‚‰ãƒ‰ãƒ©ãƒƒã‚°ãŒå§‹ã¾ã£ãŸã‹è¨˜éŒ²
    
    if (this.isMobile) {
        this.els.mobile.unassignBumper.classList.add('is-visible');
        // ãƒ‰ãƒ©ãƒƒã‚°å…ƒãŒãƒªã‚¹ãƒˆã®å ´åˆã€ãƒ‘ãƒãƒ«ã‚’è‡ªå‹•ã§é–‰ã˜ã‚‹
        if (data.type === 'list') {
            this.els.mobile.playerListPanel.classList.remove('is-open');
        }
    }
    
    e.dataTransfer.setData('application/json', JSON.stringify(data));
    e.dataTransfer.effectAllowed = 'move';
    const player = this.state.squad.find(p => p.id === data.playerId);
    if (player) {
        this.els.dragGhost.innerHTML = `<span class="num">${player.number}</span><span class="name">${player.name}</span>`;
        e.dataTransfer.setDragImage(this.els.dragGhost, 15, 15);
    }
    e.stopPropagation();
    
    if (this.els.sidebar.el.classList.contains('is-open')) {
        this.closeSidebar(true);
    }
},
// ä¿®æ­£ç®‡æ‰€: handleDragEnd ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä¸¸ã”ã¨ç½®ãæ›ãˆ

handleDragEnd(e) {
    if (!this.isDraggingPlayer) return;
    this.isDraggingPlayer = false;

    if (this.isMobile) {
        this.els.mobile.unassignBumper.classList.remove('is-visible', 'is-droppable');
        
        // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹å…ƒãŒãƒªã‚¹ãƒˆã ã£ãŸå ´åˆã€ãƒ‰ãƒ­ãƒƒãƒ—å¾Œã«ãƒ‘ãƒãƒ«ã‚’å†è¡¨ç¤º
        if (this._lastDragStartType === 'list') {
            // å°‘ã—é…å»¶ã•ã›ã‚‹ã“ã¨ã§ã€ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†ãŒå®Œäº†ã—ã¦ã‹ã‚‰ãƒ‘ãƒãƒ«ã‚’é–‹ã
            setTimeout(() => {
                this.els.mobile.playerListPanel.classList.add('is-open');
            }, 100); 
        }
    }
    this._lastDragStartType = null; // è¨˜éŒ²ã‚’ãƒªã‚»ãƒƒãƒˆ
},

    handleDragOver(e) { e.preventDefault(); e.currentTarget.classList.add('drop-target-hover'); },
    handleDragLeave(e) { e.currentTarget.classList.remove('drop-target-hover'); },

    handleDropOnPitch(e, targetPosId) {
        e.preventDefault(); e.stopPropagation();
        e.currentTarget.classList.remove('drop-target-hover');
        const data = JSON.parse(e.dataTransfer.getData('application/json'));
        const draggedPlayerId = data.playerId;
        const playerOnTarget = this.state.starters[targetPosId]?.playerId;
        
        if (draggedPlayerId === playerOnTarget) return;

        this.unassignPlayer(draggedPlayerId);
        
        if (playerOnTarget) {
            this.unassignPlayer(playerOnTarget);
            if (data.type === 'pitch') {
                this.state.starters[data.posId] = { playerId: playerOnTarget, coords: this.state.starters[data.posId]?.coords || null };
            } else {
                const posName = targetPosId.split('_')[0];
                const role = this.getRole(posName).toUpperCase();
                this.state.substitutes[role].push(playerOnTarget);
            }
        }
        
        this.state.starters[targetPosId] = { playerId: draggedPlayerId, coords: this.state.starters[targetPosId]?.coords || null };
        this.renderAll();
    },

// handleDropOnSubZoneãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä¸¸ã”ã¨ç½®ãæ›ãˆ
handleDropOnSubZone(e, mobilePosCategory = null) {
    e.preventDefault(); e.stopPropagation();
    e.currentTarget.classList.remove('drop-target-hover');

    try {
        const data = JSON.parse(e.dataTransfer.getData('application/json'));
        const player = this.state.squad.find(p => p.id === data.playerId);

        if (player) {
            this.unassignPlayer(data.playerId);
            const targetCategory = this.isMobile ? mobilePosCategory : player.posCategory;
            
            if (!this.state.substitutes[targetCategory]) {
                this.state.substitutes[targetCategory] = [];
            }
            this.state.substitutes[targetCategory].push(data.playerId);
            this.renderAll();
        }
    } catch (err) {
        console.error("Drop failed:", err);
    }
},

    unassignPlayer(playerId) {
        for (const posId in this.state.starters) {
            if (this.state.starters[posId]?.playerId === playerId) {
                delete this.state.starters[posId];
                return;
            }
        }
        for (const category in this.state.substitutes) {
            this.state.substitutes[category] = (this.state.substitutes[category] || []).filter(id => id !== playerId);
        }
    },

    addPlayer() {
        const number = this.els.sidebar.numberInput.value;
        const name = this.els.sidebar.nameInput.value.trim();
        const posCategory = this.els.sidebar.posSelect.value; // è¿½åŠ 
        if (!number || !name) { alert('èƒŒç•ªå·ã¨é¸æ‰‹åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
        if (this.state.squad.some(p => p.number === parseInt(number))) { alert('ã“ã®èƒŒç•ªå·ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚'); return; }
        this.state.squad.push({ id: `p_${Date.now()}`, number: parseInt(number), name, posCategory }); // å¤‰æ›´
        this.els.sidebar.numberInput.value = '';
        this.els.sidebar.nameInput.value = '';
        this.els.sidebar.numberInput.focus();
        this.renderAll();
    },

    resetAllAssignments() {
        if (confirm('ã™ã¹ã¦ã®é¸æ‰‹ã®é…ç½®ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
            this.state.starters = {};
            this.state.substitutes = { GK: [], DF: [], MF: [], FW: [] };
            this.renderAll();
        }
    },
    
    openModal(modalEl) { modalEl.style.display = 'flex'; },
    closeAllModals() {
        this.els.allModals.forEach(modal => modal.style.display = 'none');
        clearInterval(this.numberChangeInterval);
    },

    buildFormationModal() {
        this.els.formationModal.grid.innerHTML = '';
        for (const key in this.formations) {
            const formation = this.formations[key];
            const card = document.createElement('div');
            card.className = 'formation-card';
            card.dataset.formation = key;
            card.innerHTML = `<div class="formation-name">${formation.name}</div><div class="formation-note">${formation.note || '&nbsp;'}</div>`;
            if (key === this.state.config.formation) card.classList.add('selected');
            card.addEventListener('click', () => {
                this.changeFormation(key);
                this.closeAllModals();
            });
            this.els.formationModal.grid.appendChild(card);
        }
    },

    changeFormation(newFormationKey) {
        const oldStarters = { ...this.state.starters };
        this.state.starters = {};

        const newPositions = this.formations[newFormationKey].spec.map((spec, index) => {
            const posId = `${spec.pos}_${spec.isDuplicate ? index : 1}`;
            const coords = this.formationCoords[newFormationKey][index];
            const characteristics = this.getPositionCharacteristics(spec.pos, coords);
            return { posId, pos: spec.pos, characteristics, isAssigned: false };
        });

        Object.values(oldStarters).forEach(starterData => {
            const player = this.state.squad.find(p => p.id === starterData.playerId);
            if (!player) return;

            let bestMatch = null;
            let bestScore = -Infinity;

            const oldPosId = Object.keys(oldStarters).find(key => oldStarters[key].playerId === starterData.playerId);
            const oldPosName = oldPosId ? oldPosId.split('_')[0] : '';
            const oldFormationKey = this.state.config.formation;
            const oldPosIndex = this.formations[oldFormationKey].spec.findIndex((spec, i) => `${spec.pos}_${spec.isDuplicate ? i : 1}` === oldPosId);
            const oldCoords = (oldPosIndex !== -1) ? this.formationCoords[oldFormationKey][oldPosIndex] : { top: 50, left: 50 };
            const oldCharacteristics = this.getPositionCharacteristics(oldPosName, oldCoords);

            newPositions.forEach(newPos => {
                if (newPos.isAssigned) return;
                const score = this.calculatePositionSimilarity(oldCharacteristics, newPos.characteristics);
                if (score > bestScore) {
                    bestScore = score;
                    bestMatch = newPos;
                }
            });

            if (bestMatch) {
                this.state.starters[bestMatch.posId] = { playerId: starterData.playerId, coords: null };
                bestMatch.isAssigned = true;
            } else {
                const role = this.getRole(oldPosName).toUpperCase();
                if (!this.state.substitutes[role]) this.state.substitutes[role] = [];
                this.state.substitutes[role].push(starterData.playerId);
            }
        });
        
        this.state.config.formation = newFormationKey;
        this.renderAll();
    },

    getPositionCharacteristics(posName, coords) {
        let role = 'GENERIC';
        if (posName === 'GK') role = 'GK';
        else if (posName.includes('CB')) role = 'CB';
        else if (posName.includes('SB')) role = 'SB';
        else if (posName.includes('WB')) role = 'WB';
        else if (posName.includes('DMF') || posName.includes('CMF')) role = 'CM';
        else if (posName.includes('AMF')) role = 'AM';
        else if (posName.includes('WG') || posName.includes('MF')) role = 'WM';
        else if (posName.includes('FW') || posName.includes('CF')) role = 'FW';
        
        let side = 'Center';
        if (posName.startsWith('R') || coords.top > 60) side = 'Right';
        if (posName.startsWith('L') || coords.top < 40) side = 'Left';
        
        let vertical = 'Mid';
        if (coords.left < 35) vertical = 'Def';
        if (coords.left > 75) vertical = 'Fwd';
        
        return { role, side, vertical, x: coords.top, y: coords.left };
    },

    calculatePositionSimilarity(char1, char2) {
        let score = 0;
        if (char1.role === char2.role) {
            score += 100;
        } else {
            const similarRoles = { 'SB': ['WB'], 'WB': ['SB', 'WM'], 'CM': ['AM'], 'AM': ['CM', 'FW'], 'WM': ['FW', 'WB'] };
            if (similarRoles[char1.role]?.includes(char2.role)) score += 50;
        }
        if (char1.side === char2.side) score += 20;
        if (char1.vertical === char2.vertical) score += 10;
        
        const distance = Math.sqrt(Math.pow(char1.x - char2.x, 2) + Math.pow(char1.y - char2.y, 2));
        score -= distance;
        return score;
    },

    openEditModal(playerId) {
        const player = this.state.squad.find(p => p.id === playerId);
        if (!player) return;
        this.editingPlayerId = playerId;
        this.els.editModal.numberInput.value = player.number;
        this.els.editModal.nameInput.value = player.name;
        this.els.editModal.posSelect.value = player.posCategory || 'FW'; // è¿½åŠ 
        this.openModal(this.els.editModal.overlay);
    },

// ä¿®æ­£ç®‡æ‰€: savePlayerChanges ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä¸¸ã”ã¨ç½®ãæ›ãˆ

savePlayerChanges() {
    const newNumber = parseInt(this.els.editModal.numberInput.value, 10);
    const newName = this.els.editModal.nameInput.value.trim();
    const newPosCategory = this.els.editModal.posSelect.value;

    if (!newNumber || !newName) {
        alert('èƒŒç•ªå·ã¨é¸æ‰‹åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
    }

    if (this.editingPlayerId) { // --- æ›´æ–°ã®å ´åˆ ---
        const player = this.state.squad.find(p => p.id === this.editingPlayerId);
        if (player) {
            if (this.state.squad.some(p => p.number === newNumber && p.id !== player.id)) {
                alert('ãã®èƒŒç•ªå·ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚'); return;
            }
            player.number = newNumber;
            player.name = newName;
            player.posCategory = newPosCategory;
        }
    } else { // --- æ–°è¦è¿½åŠ ã®å ´åˆ ---
        if (this.state.squad.some(p => p.number === newNumber)) {
            alert('ã“ã®èƒŒç•ªå·ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚'); return;
        }
        this.state.squad.push({ id: `p_${Date.now()}`, number: newNumber, name: newName, posCategory: newPosCategory });
    }

    this.renderAll();
    this.closeAllModals();
},

    deletePlayerFromModal() {
        if (this.editingPlayerId && confirm('ã“ã®é¸æ‰‹ã‚’ãƒªã‚¹ãƒˆã‹ã‚‰å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
            this.unassignPlayer(this.editingPlayerId);
            this.state.squad = this.state.squad.filter(p => p.id !== this.editingPlayerId);
            this.closeAllModals();
            this.renderAll();
        }
    },
    
    changeNumber(amount) {
        let currentNum = parseInt(this.els.editModal.numberInput.value, 10) || 0;
        let newNum = currentNum + amount;
        if (newNum < 1) newNum = 1;
        this.els.editModal.numberInput.value = newNum;
    },

    toggleDragMode() {
        this.state.config.dragMode = this.state.config.dragMode === 'position' ? 'swap' : 'position';
        this.showModeToast();
        this.renderAll();
    },

    showModeToast() {
        clearTimeout(this.toastTimer);
        this.els.modeToast.textContent = this.state.config.dragMode === 'swap' ? 'é¸æ‰‹äº¤ä»£ãƒ¢ãƒ¼ãƒ‰' : 'ãƒãƒ¼ã‚«ãƒ¼ç§»å‹•ãƒ¢ãƒ¼ãƒ‰';
        this.els.modeToast.classList.add('show');
        this.toastTimer = setTimeout(() => { this.els.modeToast.classList.remove('show'); }, 1500);
    },
    
saveImage() {
    const allSubs = Object.values(this.state.substitutes).flat();
    if (allSubs.length > 9) {
        const proceed = confirm(
            `è­¦å‘Šï¼šæ§ãˆé¸æ‰‹ã®äººæ•°ãŒ9äººã‚’è¶…ãˆã¦ã„ã¾ã™ï¼ˆç¾åœ¨ ${allSubs.length}äººï¼‰ã€‚\nå…¬å¼ãƒ«ãƒ¼ãƒ«ã§ã¯èªã‚ã‚‰ã‚Œã¦ã„ã¾ã›ã‚“ãŒã€ã“ã®ã¾ã¾ç”»åƒã‚’ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ`
        );
        if (!proceed) {
            this.closeAllModals(); // ã‚¹ãƒãƒ›ã®ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
            return; // ä¿å­˜ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        }
    }
        const originalArea = document.getElementById('capture-area');
        // ãƒ¡ãƒ¢ãƒªä¸Šã§è¦ç´ ã®ã‚¯ãƒ­ãƒ¼ãƒ³ã‚’ä½œæˆ
        const cloneArea = originalArea.cloneNode(true);
        cloneArea.style.position = 'absolute';
        cloneArea.style.left = '-9999px'; // ç”»é¢å¤–ã«é…ç½®
        cloneArea.style.top = '0px';
        cloneArea.style.width = originalArea.offsetWidth + 'px'; // å…ƒã®ã‚µã‚¤ã‚ºã‚’ç¶­æŒ
        document.body.appendChild(cloneArea);

        // ã‚¯ãƒ­ãƒ¼ãƒ³ã«å¯¾ã—ã¦ã®ã¿ã€ç”»åƒå‡ºåŠ›ç”¨ã®å¤‰æ›´ã‚’åŠ ãˆã‚‹
        let subsHTML = '';
        ['GK', 'DF', 'MF', 'FW'].forEach(pos => {
            const playersInPos = (this.state.substitutes[pos] || [])
                .map(id => this.state.squad.find(p => p.id === id))
                .filter(Boolean);
            
            if (playersInPos.length > 0) {
                const names = playersInPos.map(p => `${p.number} ${p.name}`).join(' / ');
                subsHTML += `<div class="subs-pos-group"><span class="pos-label">${pos}:</span><span class="names">${names}</span></div>`;
            }
        });

        const captureSubs = cloneArea.querySelector('#capture-subs');
        if (captureSubs) {
            captureSubs.innerHTML = subsHTML ? `<h4>SUBSTITUTES</h4><div class="subs-grid">${subsHTML}</div>` : '';
        }

        const captureTitle = cloneArea.querySelector('#capture-title');
        const titleInput = this.els.titleInput;
        if (captureTitle) {
            captureTitle.textContent = titleInput.value || titleInput.placeholder;
            captureTitle.style.display = 'block';
        }
        
        const watermark = cloneArea.querySelector('#capture-watermark');
        if (watermark) {
            watermark.textContent = "Created with XISync";
        }
        
        cloneArea.classList.add('is-capturing');

        // ã‚¯ãƒ­ãƒ¼ãƒ³ã—ãŸè¦ç´ ã‚’ç”»åƒåŒ–
        html2canvas(cloneArea, { backgroundColor: '#4a8d4d', scale: 3 }).then(canvas => {
            const link = document.createElement('a');
            const fileName = (titleInput.value || 'tactical-canvas').replace(/[\\/:"*?<>|]/g, '').replace(/\s+/g, '_');
            link.download = `${fileName}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }).finally(() => {
            // çµ‚ã‚ã£ãŸã‚‰ã‚¯ãƒ­ãƒ¼ãƒ³ã‚’å‰Šé™¤
            document.body.removeChild(cloneArea);
        });
    },
    
    checkUrlForSquadData() {
        const dataParam = new URLSearchParams(window.location.search).get('data');
        if (dataParam) {
            try {
                const decompressed = LZString.decompressFromEncodedURIComponent(dataParam);
                const squadData = JSON.parse(decompressed);
                if (this.isValidSquad(squadData)) {
                    this.showImportConfirmation(squadData);
                }
            } catch (error) {
                console.error('URL Data Error:', error);
                history.replaceState(null, '', window.location.pathname);
            }
        }
    },
    
    isValidSquad(squad) {
        return Array.isArray(squad) && squad.every(p => p.id && typeof p.number !== 'undefined' && p.name);
    },
    
    showImportConfirmation(squadData) {
        this._importedSquadData = squadData;
        this.els.importConfirmModal.previewList.innerHTML = '<ul style="list-style: none; padding: 0;">' + squadData
            .sort((a,b) => a.number - b.number)
            .map(p => `<li><strong>No.${p.number}</strong> ${p.name}</li>`).join('') + '</ul>';
        this.openModal(this.els.importConfirmModal.overlay);
    },

    confirmImport() {
        if (!this._importedSquadData) return;
        this.state.squad = this._importedSquadData;
        this.state.starters = {};
        this.state.substitutes = { GK: [], DF: [], MF: [], FW: [] };
        this.renderAll();
        this.closeAllModals();
        history.replaceState(null, '', window.location.pathname);
        alert(`${this.state.squad.length}äººã®é¸æ‰‹ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚`);
        this._importedSquadData = null;
    },

    processImport(data) {
        if (this.isValidSquad(data)) {
            this.showImportConfirmation(data);
        } else {
            alert('ç„¡åŠ¹ãªãƒ‡ãƒ¼ã‚¿å½¢å¼ã§ã™ã€‚');
        }
    },

    copySquadUrlToClipboard() {
        if (this.state.squad.length === 0) { alert("å…±æœ‰ã™ã‚‹é¸æ‰‹ãŒã„ã¾ã›ã‚“ã€‚"); return; }
        try {
            const squadJSON = JSON.stringify(this.state.squad);
            const compressed = LZString.compressToEncodedURIComponent(squadJSON);
            const baseUrl = window.location.href.split('?')[0].split('#')[0];
            const shareUrl = `${baseUrl}?data=${compressed}`;
            navigator.clipboard.writeText(shareUrl).then(() => {
                alert("å…±æœ‰ç”¨URLã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
                this.closeAllModals();
            }).catch(err => alert("URLã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"));
        } catch(e) {
            alert("URLã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        }
    },

    copySquadToClipboard() {
        if (this.state.squad.length === 0) { alert("ã‚³ãƒ”ãƒ¼ã™ã‚‹é¸æ‰‹ãŒã„ã¾ã›ã‚“ã€‚"); return; }
        navigator.clipboard.writeText(JSON.stringify(this.state.squad)).then(() => {
            alert('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
            this.closeAllModals();
        }).catch(() => alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'));
    },
    
    exportSquadToFile() {
        if (this.state.squad.length === 0) { alert("ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹é¸æ‰‹ãŒã„ã¾ã›ã‚“ã€‚"); return; }
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.state.squad));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "xisync_squad.json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
        this.closeAllModals();
    },

    importFromFile(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                this.processImport(JSON.parse(event.target.result));
            } catch (error) {
                alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
        };
        reader.readAsText(file);
        e.target.value = ''; // Reset file input
    },

    async importFromClipboard() {
        try {
            const text = await navigator.clipboard.readText();
            if (text) {
                try {
                    this.processImport(JSON.parse(text));
                } catch (e) { alert('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã®ãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒç„¡åŠ¹ã§ã™ã€‚'); }
            } else { alert('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ãŒç©ºã§ã™ã€‚'); }
        } catch (err) {
            alert('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        }
    },
    setupSidebarControls() {
        const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        
        // æ—¢å­˜ã®ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
        this.els.allOpenSidebarBtns.forEach(btn => btn.addEventListener('click', () => this.openSidebar(true)));
        
        if (isTouchDevice) {
            this.setupTouchSidebar();
        } else {
            this.setupMouseSidebar();
        }
    },

setupMouseSidebar() {
    const sidebar = this.els.sidebar.el;
    const handle = this.els.sidebarHandle;

    handle.addEventListener('mouseenter', () => {
        this.sidebarHoverTimer = setTimeout(() => {
            this.openSidebar();
        }, 200);
    });

    handle.addEventListener('mouseleave', () => clearTimeout(this.sidebarHoverTimer));

    sidebar.addEventListener('mouseleave', () => {
        // â–¼â–¼â–¼ ã“ã“ã‹ã‚‰ãŒå¤‰æ›´ç‚¹ â–¼â–¼â–¼
        // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªè¦ç´ ãŒã‚µã‚¤ãƒ‰ãƒãƒ¼å†…ã®å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã§ãªã„ã‹ãƒã‚§ãƒƒã‚¯
        const activeEl = document.activeElement;
        const isTypingInSidebar = 
            activeEl === this.els.sidebar.numberInput ||
            activeEl === this.els.sidebar.nameInput ||
            activeEl === this.els.sidebar.posSelect;

        if (isTypingInSidebar) {
            return; // å…¥åŠ›ä¸­ã¯é–‰ã˜ãªã„
        }
        // â–²â–²â–² ã“ã“ã¾ã§ãŒå¤‰æ›´ç‚¹ â–²â–²â–²

        clearTimeout(this.sidebarHoverTimer);
        this.closeSidebar();
    });

    this.els.pinSidebarBtn.addEventListener('click', () => this.toggleSidebarPin());
},

    setupTouchSidebar() {
        const sidebar = this.els.sidebar.el;
        const handle = this.els.sidebarHandle;
        let startX = 0, currentX = 0, isDragging = false;

        const dragStart = (e) => {
            isDragging = true;
            startX = e.touches[0].clientX;
            sidebar.classList.add('no-transition');
            document.body.style.overflowX = 'hidden';
        };

        const dragMove = (e) => {
            if (!isDragging) return;
            currentX = e.touches[0].clientX;
            const diff = Math.min(300, Math.max(0, currentX - startX));
            sidebar.style.transform = `translateX(${-300 + diff}px)`;
        };

        const dragEnd = () => {
            if (!isDragging) return;
            isDragging = false;
            sidebar.classList.remove('no-transition');
            sidebar.style.transform = '';
            document.body.style.overflowX = '';

            const threshold = 100;
            if (currentX - startX > threshold) {
                this.openSidebar();
            } else {
                this.closeSidebar();
            }
        };

        handle.addEventListener('touchstart', dragStart, { passive: true });
        document.addEventListener('touchmove', dragMove, { passive: true });
        document.addEventListener('touchend', dragEnd);

        // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®å¤–å´ã‚¿ãƒƒãƒ—ã§é–‰ã˜ã‚‹
        document.addEventListener('click', (e) => {
            if (sidebar.classList.contains('is-open') && !sidebar.contains(e.target) && !e.target.closest('.sidebar-handle') && !e.target.closest('#open-sidebar-btn')) {
                this.closeSidebar(true);
            }
        });
    },

    openSidebar(isPinned = false) {
        if (isPinned) this.els.sidebar.el.classList.add('is-pinned');
        this.els.sidebar.el.classList.add('is-open');
        this.els.body.classList.add('sidebar-is-open');
    },

    closeSidebar(force = false) {
        if (this.els.sidebar.el.classList.contains('is-pinned') && !force) return;
        
        if (force) {
           this.els.sidebar.el.classList.remove('is-pinned');
        }
        this.els.sidebar.el.classList.remove('is-open');
        this.els.body.classList.remove('sidebar-is-open');
    },

    toggleSidebarPin() {
        const sidebar = this.els.sidebar.el;
        sidebar.classList.toggle('is-pinned');
        if (sidebar.classList.contains('is-pinned')) {
            this.openSidebar();
        }
    }
};

App.init(); // Run the app

});

</script>
</body>
</html>
