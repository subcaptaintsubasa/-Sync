<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>XISync</title>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-CSR2CREBLH"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-CSR2CREBLH');
    </script>
    
    <!-- PWA Manifest (Inline) -->
    <link rel="manifest" href="manifest.json">

    <meta name="theme-color" content="#007bff">
    <link rel="icon" type="image/png" href="./icon.png">
    <link rel="apple-touch-icon" href="./icon.png">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <style>
    /* --- ボタン等のタップ/クリック時の青い枠を消す --- */
button, a, input, select, textarea {
    -webkit-tap-highlight-color: transparent; /* スマホでのタップ時のハイライトを消す */
    outline: none; /* クリック/フォーカス時の青い枠を消す */
}

        :root {
    --pitch-bg: #539d56; --line-color: rgba(255, 255, 255, 0.6); --sidebar-bg: #f4f4f4;
    --text-color: #333; --primary-color: #007bff; --secondary-color: #6c757d; --danger-color: #dc3545;
    /* --- マーカー色を微調整 --- */
    --marker-gk-color: #f1c40f; --marker-gk-shadow: #c8a205; /* 黄色 */
    --marker-df-color: #3498db; --marker-df-shadow: #2173a8; /* 青色 */
    --marker-mf-color: #2ecc71; --marker-mf-shadow: #209153; /* 緑色 */
    --marker-fw-color: #e74c3c; --marker-fw-shadow: #b83325; /* 赤色 */
}

        body {
            font-family: 'Helvetica Neue', 'Arial', 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', 'Meiryo', sans-serif;
            margin: 0; background-color: #e9e9e9; color: var(--text-color);
            padding: 20px; box-sizing: border-box; min-height: 100vh; overflow-x: hidden;
            touch-action: manipulation; /* Prevent double-tap zoom */
        }

        .container { display: flex; flex-wrap: wrap; gap: 20px; width: 100%; max-width: 1600px; margin: 0 auto; }
        .left-panel, .right-panel { width: 350px; flex-shrink: 0; background-color: var(--sidebar-bg); padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: flex; flex-direction: column; gap: 25px; }
        .main-content { flex-grow: 1; min-width: 400px; }

        .app-branding { text-align: center; padding-bottom: 20px; border-bottom: 1px solid #ddd; margin-bottom: 15px; }
        .app-branding h2 { margin: 0; font-size: 2em; color: var(--primary-color); letter-spacing: 1px;}
        .app-branding p { margin: 2px 0 0 0; font-size: 0.9em; color: #666; }

        [data-layout-mode="horizontal"] .left-panel { display: none; }
        [data-layout-mode="vertical"] .right-panel #player-management-section { display: none; }
        [data-layout-mode="vertical"] .container { align-items: flex-start; }

        @media (max-width: 1200px) {
            .container { flex-direction: column; align-items: center; }
            .left-panel, .right-panel, .main-content { width: 100%; max-width: 600px; }
            [data-layout-mode="vertical"] .left-panel { display: none; }
            [data-layout-mode="vertical"] .right-panel #player-management-section { display: flex; }
        }

        .control-group { display: flex; flex-direction: column; gap: 8px; }
        .control-group label { font-weight: bold; }
        #title-input { width: 100%; padding: 12px; font-size: 1.6em; font-weight: bold; border: 2px solid transparent; border-radius: 8px; box-sizing: border-box; margin-bottom: 15px; transition: border-color 0.3s; }
        #title-input:focus { outline: none; border-color: var(--primary-color); }
        
        #capture-area { position: relative; background-color: #4a8d4d; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .pitch-wrapper { position: relative; }
        .capture-title { color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.8); font-size: 30px; width: 100%; text-align:center; padding-bottom: 20px; box-sizing: border-box; display: none; }
        
        .pitch {
            position: relative; width: 100%; background-color: var(--pitch-bg);
            background-image: repeating-linear-gradient(90deg, transparent, transparent 4.8%, rgba(0,0,0,0.05) 5%, transparent 5.2%);
            border: 3px solid var(--line-color); border-radius: 10px; box-sizing: border-box; overflow: hidden;
        }
        .pitch-wrapper.vertical .pitch { padding-top: 120%; background-image: repeating-linear-gradient(0deg, transparent, transparent 4.8%, rgba(0,0,0,0.05) 5%, transparent 5.2%); }         .pitch-wrapper.horizontal .pitch { padding-top: 70%; }
        
        .pitch-line { position: absolute; box-sizing: border-box; border-color: var(--line-color); border-style: solid; }
        .vertical .center-line   { width: 100%; height: 3px; background-color: var(--line-color); top: 0; left: 0; }
        .vertical .center-circle { width: 40%; padding-top: 20%; border-width: 3px; border-radius: 0 0 50% 50%; border-top-style: none; top: -3px; left: 50%; transform: translateX(-50%); }
        .vertical .goal-area { width: 30%; height: 7%; border-width: 3px; border-bottom-style: none; bottom: 0; left: 50%; transform: translateX(-50%); }
        .vertical .penalty-area { width: 60%; height: 18%; border-width: 3px; border-bottom-style: none; bottom: 0; left: 50%; transform: translateX(-50%); }
        .vertical .penalty-arc { width: 20%; height: 8%; border-width: 3px; border-radius: 50% 50% 0 0; border-bottom-style: none; bottom: 18%; left: 50%; transform: translateX(-50%); }
        .vertical .goal { width: 20%; height: 4%; background: rgba(255,255,255,0.1); border-width: 3px; border-bottom-style: none; bottom: 0; left: 50%; transform: translateX(-50%); border-radius: 10px 10px 0 0; }
        
        .horizontal .center-line { width: 3px; height: 100%; background-color: var(--line-color); top: 0; right: 0; }
        .horizontal .center-circle { height: 52%; width: 18.2%; border: 3px solid var(--line-color); border-radius: 50% 0 0 50%; border-right-style: none; right: -3px; top: 50%; transform: translateY(-50%); }
        .horizontal .goal-area { width: 7%; height: 30%; border-width: 3px; border-left-style: none; top: 35%; left: 0; }
        .horizontal .penalty-area { width: 18%; height: 50%; border-width: 3px; border-left-style: none; top: 25%; left: 0; }
        .horizontal .penalty-arc { width: 8%; height: 20%; border-width: 3px; border-radius: 0 50% 50% 0; border-left-style: none; top: 40%; left: 18%; }
        .horizontal .goal { width: 4%; height: 20%; background: rgba(255,255,255,0.1); border-width: 3px; border-right-style: none; top: 40%; left: 0; border-radius: 0 10px 10px 0; }

        .capture-subs { padding-top: 20px; color: white; font-size: 15px; }
        .capture-subs h4 { margin: 0 0 12px 0; text-align: center; font-size: 1.2em; letter-spacing: 1px; }
        .subs-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .subs-pos-group { display: flex; align-items: baseline; gap: 10px; }
        .subs-pos-group .pos-label { font-weight: bold; flex-shrink: 0; width: 35px; }
        .subs-pos-group .names { word-break: keep-all; }

        .capture-watermark { display: none; }
        .is-capturing .capture-watermark { display: block; position: absolute; bottom: 10px; right: 15px; font-size: 14px; color: rgba(255, 255, 255, 0.7); text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }

        .player-container { position: absolute; display: flex; flex-direction: column; align-items: center; user-select: none; transform: translate(-50%, -50%); transition: top 0.3s ease, left 0.3s ease, transform 0.2s, box-shadow 0.2s; will-change: top, left, transform; border-radius: 50%; }
        .player-container.is-moving { cursor: move; z-index: 100; transform: translate(-50%, -50%) scale(1.15); transition: transform 0.2s, box-shadow 0.2s; } /* No position transition while moving */
        .player-container.drop-target-hover { transform: translate(-50%, -50%) scale(1.15); }
/* デザイン案7の .player-marker スタイル全体を、以下のコードに置き換えます */

.player-marker {
    width: 52px;
    height: 52px;
    border-radius: 50%;
    position: relative;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    font-weight: bold;
    /* 厚みの影と、地面に落ちる影を分離してよりリアルに */
    box-shadow: 0 4px 0px var(--shadow-color, #999), /* JSで色が変わる厚み部分 */
                0 8px 10px rgba(0,0,0,0.4);
    border: 2px solid rgba(0,0,0,0.2);
    box-sizing: border-box;
    touch-action: none;
    transition: all 0.15s cubic-bezier(.2, .8, .4, 1.2); /* 弾むようなアニメーション */
}

/* ポジションごとに、基本色と影色変数を設定 */
.player-marker.gk { background-color: var(--marker-gk-color); --shadow-color: var(--marker-gk-shadow); color: #333; }
.player-marker.df { background-color: var(--marker-df-color); --shadow-color: var(--marker-df-shadow); color: white; }
.player-marker.mf { background-color: var(--marker-mf-color); --shadow-color: var(--marker-mf-shadow); color: white; }
.player-marker.fw { background-color: var(--marker-fw-color); --shadow-color: var(--marker-fw-shadow); color: white; }

/* ▼ ドラッグ中のアニメーションを改良 ▼ */
.player-container.is-moving .player-marker {
    transform: translateY(-5px) scale(1.1) rotateZ(-3deg); /* 少し浮き上がり、傾く */
    box-shadow: 0 2px 0px var(--shadow-color, #999), 
                0 15px 20px rgba(0,0,0,0.3); /* 影も少し広がる */
}

/* 内側のリングを追加 (少し控えめな半透明に) */
.player-marker::after {
    content: '';
    position: absolute;
    top: 3px; left: 3px; right: 3px; bottom: 3px;
    border: 2px solid rgba(255, 255, 255, 0.4);
    border-radius: 50%;
    pointer-events: none;
}

        .player-number { font-size: 22px; line-height: 1; pointer-events: none; } .player-pos { font-size: 11px; line-height: 1; opacity: 0.8; margin-top: 2px; pointer-events: none; }
        .player-name { background-color: rgba(0, 0, 0, 0.7); color: white; font-size: 14px; font-weight: bold; padding: 5px 8px; border-radius: 12px; margin-top: 6px; text-align: center; max-width: 120px; white-space: normal; word-break: break-all; line-height: 1.2; box-shadow: 0 1px 4px rgba(0,0,0,0.25); cursor: default; }
        .unassign-btn { position: absolute; top: -10px; right: -10px; width: 24px; height: 24px; background-color: rgba(255, 255, 255, 0.9); color: #555; border-radius: 50%; border: 1px solid #ccc; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 16px; font-weight: bold; line-height: 1; box-shadow: 0 1px 3px rgba(0,0,0,0.2); transition: all 0.2s; z-index: 11; padding: 0; }
        .unassign-btn:hover { background-color: #e74c3c; color: white; transform: scale(1.1); }
        .is-capturing .unassign-btn, .is-capturing .unassign-btn-sub { display: none; }
        
        button { width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: background-color 0.3s, transform 0.1s; }
        button:active { transform: scale(0.98); }
        .unassign-btn-sub:active,
        .edit-player-btn:active {
            transform: translateY(-50%) scale(1);
        }
        .btn-primary { background-color: var(--primary-color); color: white; } .btn-secondary { background-color: var(--secondary-color); color: white; } .btn-danger { background-color: var(--danger-color); color: white; }
        .orientation-toggle { display: flex; gap: 10px; }
        .orientation-toggle input { display: none; }
        .orientation-toggle label { flex: 1; text-align: center; padding: 8px; border-radius: 6px; border: 1px solid #ccc; cursor: pointer; background-color: #fff; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 14px; }
        .orientation-toggle input:checked + label { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        
        #player-list-controls { border: 1px solid #ddd; border-radius: 8px; padding: 15px; background-color: #fff; }
        
        .player-list-item { display: flex; align-items: center; padding: 8px 10px; border-bottom: 1px solid #eee; user-select: none; }
        .player-list-item:not(.is-assigned) { cursor: grab; }
        .player-list-item.is-assigned { background-color: #f0f0f0; color: #999; }
        .player-list-item .num, .player-list-item .name { padding: 4px; } .player-list-item .num { font-weight: bold; width: 30px; text-align: right; margin-right: 5px;}
        .player-list-item .name { flex-grow: 1; position: relative;}
        .player-list-item.is-assigned .num, .player-list-item.is-assigned .name { color: #888; } /* Assigned players are greyed out */
        .edit-player-btn { background: none; border: none; cursor: pointer; width: 30px; height: 30px; position: absolute; right: 5px; top: 50%; transform: translateY(-50%); color: #888; opacity: 0; transition: opacity 0.2s, background-color 0.2s; display: flex; align-items: center; justify-content: center; border-radius: 50%; padding: 0; }
        .edit-player-btn:hover { background-color: #f0f0f0; }
        .player-list-item:hover .edit-player-btn { opacity: 1; }
        .edit-player-btn:hover { color: var(--primary-color); }
        
                /* ▼▼▼ ここから修正 ▼▼▼ */
                .drag-ghost {
            position: absolute;
            left: -1000px; /* 初期位置は画面外 */
            z-index: 2100;
            display: flex;
            flex-direction: column-reverse; /* ← この行を修正 (マーカーが上に、名前が下にくるのを反転) */
            align-items: center;
            pointer-events: none; /* マウスイベントを透過させる */
        }
        .drag-ghost .name {
            background-color: rgba(0, 0, 0, 0.75);
            color: white;
            font-size: 14px;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 12px;
            margin-top: 6px; /* ← margin-bottom から変更 */
            white-space: nowrap; /* 名前が改行されないように */
        }
        .drag-ghost .num {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 22px;
            font-weight: bold;
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
            border: 2px solid white;
        }

                /* スマホ用のドラッグゴーストスタイル */
        .list-player-item.is-drag-ghost-mobile {
            opacity: 0.9;
            position: relative; /* ← この行を追加 */
        }
        .list-player-item.is-drag-ghost-mobile .list-player-marker {
            width: 52px;
            height: 52px;
        }
        .list-player-item.is-drag-ghost-mobile .list-player-number {
            font-size: 22px;
            top: 50%;
            transform: translateY(-50%);
        }
        .list-player-item.is-drag-ghost-mobile .list-player-name {
            display: block; /* 名前を常に表示 */
            position: absolute;
            bottom: 100%; /* マーカーの上部に配置 */
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 6px;
            background-color: rgba(0, 0, 0, 0.75);
            color: white;
            font-size: 14px;
            padding: 5px 10px;
            border-radius: 12px;
            white-space: nowrap;
        }
        /* ▲▲▲ ここまで追加 ▲▲▲ */

        #substitutes-container { display: flex; flex-direction: column; gap: 10px; }
        .sub-category { display: flex; align-items: flex-start; gap: 8px; }
        .sub-category-label { font-weight: bold; width: 35px; padding-top: 10px; flex-shrink: 0; }
        .sub-drop-zone { flex-grow: 1; min-height: 40px; border: 2px dashed #ccc; border-radius: 8px; padding: 5px; background-color: #fff; transition: background-color 0.2s, border-color 0.2s; display: flex; flex-wrap: wrap; align-content: flex-start; gap: 8px; }
        .sub-drop-zone.drop-target-hover { background-color: #e9f5ff; border-color: var(--primary-color); }
        .substitute-item { position: relative; display: inline-flex; align-items: center; background-color: #e9ecef; border-radius: 15px; padding: 5px 25px 5px 10px; font-size: 14px; user-select: none; cursor: grab; }
        .substitute-item .num { font-weight: bold; margin-right: 8px; }
        .unassign-btn-sub { position: absolute; top: 50%; right: 4px; transform: translateY(-50%); width: 22px; height: 22px; background-color: #ccc; color: white; border-radius: 50%; border: none; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 16px; line-height: 1; padding: 0; transition: background-color 0.2s; }
        .unassign-btn-sub:hover { background-color: #e74c3c; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); width: 90%; max-width: 420px; position: relative; }
        .modal-close-btn { position: absolute; top: 10px; right: 15px; font-size: 28px; color: #999; background: none; border: none; cursor: pointer; width: auto; padding: 0; }
        .modal-content h3 { margin-top: 0; margin-bottom: 25px; text-align: center; }
        
        #edit-player-modal .form-group { margin-bottom: 20px; }
        #edit-player-modal .form-group label { display: block; margin-bottom: 8px; font-weight: bold; }
        #edit-player-modal input[type="text"] { width: 100%; padding: 12px; font-size: 16px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; }

        .number-input-wrapper { display: flex; align-items: center; gap: 5px; }
        .number-input-btn { width: 48px !important; height: 48px; font-size: 24px !important; padding: 0 !important; background-color: #f0f0f0; color: #333; flex-shrink: 0; user-select: none; }
        .number-input-btn:hover { background-color: #e0e0e0; }
        #edit-player-number { width: 100%; height: 48px; font-size: 22px; text-align: center; border: 1px solid #ccc; border-radius: 8px; -moz-appearance: textfield; }
        #edit-player-number::-webkit-outer-spin-button, #edit-player-number::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        #delete-player-btn-modal { display: flex; align-items: center; justify-content: center; gap: 8px; }
        #delete-player-btn-modal svg { width: 18px; height: 18px; }
        
        #formation-modal .modal-content { max-width: 600px; }
        #formation-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .formation-card { border: 2px solid #ddd; border-radius: 8px; padding: 15px; text-align: center; cursor: pointer; transition: all 0.2s ease; background-color: #fff; }
        .formation-card:hover { border-color: var(--primary-color); transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .formation-card.selected { border-color: var(--primary-color); background-color: #e9f5ff; font-weight: bold; }
        .formation-name { font-size: 1.1em; margin-bottom: 5px; }
        .formation-note { font-size: 0.8em; color: #666; }

        .share-section { margin-bottom: 25px; }
        .share-section-title { font-weight: bold; margin-bottom: 10px; }
        .share-actions { display: flex; flex-direction: column; gap: 10px; }
        .share-actions button, .share-actions label { flex: 1; font-size: 14px; padding: 10px; text-align: center; }
        #import-squad-input { display: none; }
        
        #open-sidebar-btn { display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 14px; padding: 10px; }
        #open-sidebar-btn svg { width: 20px; height: 20px; }

        #player-list-sidebar { position: fixed; top: 0; left: 0; width: 300px; height: 100vh; background-color: #fff; box-shadow: 4px 0 15px rgba(0,0,0,0.2); transform: translateX(-100%); transition: transform 0.3s ease-in-out; z-index: 1000; display: flex; flex-direction: column; }
        #player-list-sidebar.is-open { transform: translateX(0); }
        .sidebar-header { padding: 15px 15px 10px 15px; border-bottom: 1px solid #eee; display: flex; flex-direction: column; align-items: flex-start; gap: 4px; }
        .sidebar-header .title-bar { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .sidebar-header h3 { margin: 0; font-size: 1.2em; }
        .sidebar-add-player { padding: 15px; border-bottom: 1px solid #eee; background-color: #f9f9f9; }
        .add-player-form { display: flex; gap: 8px; align-items: center; }
        .add-player-form input[type="number"] { width: 60px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; } 
        .add-player-form input[type="text"] { flex: 1; min-width: 0; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .add-player-form button { width: auto; flex-shrink: 0; font-size: 14px; padding: 8px 12px; }
        #sidebar-player-list { flex-grow: 1; overflow-y: auto; }
        #sidebar-player-list.is-empty { padding: 20px; text-align: center; color: #888; }

        .mode-toggle-fab { position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px; background-color: var(--primary-color); color: white; border: none; border-radius: 50%; box-shadow: 0 4px 12px rgba(0,0,0,0.3); cursor: pointer; display: flex; justify-content: center; align-items: center; z-index: 1000; transition: transform 0.2s, background-color 0.2s; }
        .mode-toggle-fab:hover { background-color: #0056b3; }
        .mode-toggle-fab:active { transform: scale(0.95); }
        .mode-toggle-fab svg { width: 30px; height: 30px; }

        .mode-toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background-color: rgba(0, 0, 0, 0.8); color: white; padding: 10px 20px; border-radius: 20px; font-size: 14px; font-weight: bold; z-index: 3000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; white-space: nowrap; }
        .mode-toast.show { opacity: 1; visibility: visible; }
        
        /* --- サイドバー操作改善のためのスタイル --- */
        .container {
            transition: padding-left 0.3s ease-in-out;
        }
        #player-list-sidebar.no-transition {
            /* JSでドラッグ中に使用 */
            transition: none;
        }

        .sidebar-handle {
            position: fixed;
            left: 0;
            top: calc(50% - 50px);
            width: 24px;
            height: 100px;
            background-color: var(--primary-color);
            border: 2px solid white;
            border-left: none;
            border-radius: 0 12px 12px 0;
            cursor: grab;
            z-index: 1001;
            transition: left 0.3s ease-in-out, background-color 0.2s;
            box-shadow: 2px 0 8px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sidebar-handle:hover {
            background-color: #0056b3;
        }
        .sidebar-handle::after {
            content: '';
            width: 4px;
            height: 40px;
            background-color: rgba(255,255,255,0.7);
            border-radius: 2px;
        }
        body.sidebar-is-open .sidebar-handle {
            left: -30px; /* 開いているときは隠す */
        }

        .pin-sidebar-btn {
            width: auto;
            height: auto;
            background: #f0f0f0;
            color: #333;
            border: 1px solid #ccc;
            border-radius: 50%;
            font-size: 16px;
            cursor: pointer;
            padding: 6px;
            line-height: 1;
            transition: all 0.2s;
            display: none; /* スマホでは非表示 */
        }
        @media (hover: hover) and (pointer: fine) {
            /* PC (ホバー可能デバイス) のみ表示 */
            .pin-sidebar-btn { display: block; }
        }
        .pin-sidebar-btn:hover {
            background-color: #e0e0e0;
            transform: scale(1.1);
        }
        #player-list-sidebar.is-pinned .pin-sidebar-btn {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: rotate(45deg);
        }

        .sidebar-header .title-bar {
            /* ピンボタン配置のための調整 */
            gap: 10px;
        }
        .sidebar-header .title-bar h3 {
            margin-right: auto;
        }
        /* (既存のスタイルの最後に追加) */

/* --- スマホ開発中メッセージバナーのスタイル --- */
#mobile-notice-banner {
    display: none; /* PCでは非表示がデフォルト */
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background-color: #fffde7; /* 薄い黄色 */
    color: #5d4037; /* 暗めの茶色 */
    padding: 12px 50px 12px 15px; /* 右側に閉じるボタンのスペースを確保 */
    box-sizing: border-box;
    z-index: 5000; /* 最前面に表示 */
    box-shadow: 0 -2px 10px rgba(0,0,0,0.15);
    border-top: 3px solid #fbc02d; /* 目立つ黄色の線 */
    align-items: center;
}

#mobile-notice-banner .banner-content {
    display: flex;
    align-items: center;
    gap: 12px;
}

#mobile-notice-banner .icon {
    font-size: 24px;
    line-height: 1;
}

#mobile-notice-banner p {
    margin: 0;
    font-size: 13px;
    line-height: 1.4;
    font-weight: 500;
}

#close-notice-btn {
    position: absolute;
    top: 50%;
    right: 10px;
    transform: translateY(-50%);
    width: 32px;
    height: 32px;
    background: transparent;
    border: none;
    border-radius: 50%;
    color: #757575;
    font-size: 24px;
    cursor: pointer;
    line-height: 1;
    padding: 0;
    transition: background-color 0.2s;
    /* 既存のボタンリセット */
    all: revert; 
    /* 上記で動かない場合の個別スタイル */
     position: absolute; top: 50%; right: 10px; transform: translateY(-50%); width: 32px; height: 32px; background: none; border: none; font-size: 24px; cursor: pointer; padding: 0; 
}
#close-notice-btn:hover {
    background-color: rgba(0,0,0,0.1);
}

/* 【修正後】 */
/* メディアクエリでスマホの場合のみ表示 */
/* --- 2024/XX/XX プロト版リリースにあたり一時的に非表示 --- */
/* @media (max-width: 768px) {
    #mobile-notice-banner {
        display: flex;
    }
    
    / * バナーが表示された分、ページ下部に余白を追加 * /
    body {
        padding-bottom: 70px; / * バナーの高さに応じて調整 * /
    }
} */
/* --- ここまで --- */
/* --- START: スマートフォンUIスタイル --- */

/* デフォルト(PC)ではスマホ用UIを非表示に */
.mobile-header,
#mobile-subs-area,
#mobile-player-list-panel,
#mobile-formation-btn,
#mobile-player-list-btn,
#mobile-unassign-bumper {
    display: none;
}

/* is-mobileクラスが付いたらPC用UIを非表示にし、スマホ用を表示する */
body.is-mobile .container {
    padding: 0; /* PC用の余白をなくす */
}
body.is-mobile .left-panel,
body.is-mobile .right-panel,
body.is-mobile .sidebar-handle,
body.is-mobile #player-list-sidebar,
body.is-mobile #title-input {
    display: none; /* PC用のUI要素を個別に非表示にする */
}
body.is-mobile .mobile-header,
body.is-mobile #mobile-subs-area,
body.is-mobile #mobile-player-list-btn {
    display: flex;
}
body.is-mobile #mobile-formation-btn,
body.is-mobile #mode-toggle-btn { /* 既存のFABもモバイルで表示 */
    display: flex;
}

@media (max-width: 768px) {

body.is-mobile .container {
    display: block; /* PC用のflex設定を解除 */
    padding: 0;
    width: 100%;
    max-width: 100%;
}
body.is-mobile .main-content {
    display: flex;
    flex-direction: column;
    flex-grow: 1;
    width: 100%;
    min-width: 0; /* PC用の最小幅(400px)をここで解除します */
    min-height: 0;
    overflow: hidden; /* ← この1行を追加 */
    padding: 0 10px 10px;
    box-sizing: border-box; /* paddingを含めて幅を100%に収めます */
}

/* ▼▼▼ このコードを追加 ▼▼▼ */
body.is-mobile .pc-ui-wrapper {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    min-height: 0; /* flexアイテムのオーバーフローを防ぐため */
}
/* ▲▲▲ ここまで ▲▲▲ */

    .sub-player-chip.gk { background-color: var(--marker-gk-color); color: #333; }
.sub-player-chip.df { background-color: var(--marker-df-color); }
.sub-player-chip.mf { background-color: var(--marker-mf-color); }
.sub-player-chip.fw { background-color: var(--marker-fw-color); }
    body {
        padding: 0;
        display: flex;
        flex-direction: column;
        height: 100vh; /* スマホの高さいっぱいに */
    }

    /* PC用UIを非表示にし、スマホ用を表示するクラス */
    body.is-mobile {
        --safe-area-inset-top: env(safe-area-inset-top, 0px);
        --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
    }
    
    .mobile-header {
        position: sticky;
        top: 0;
        width: 100%;
        padding: 10px 15px;
        padding-top: calc(10px + var(--safe-area-inset-top));
        background: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        z-index: 1100;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        display: flex;
        align-items: center;
        gap: 10px;
        flex-shrink: 0;
        box-sizing: border-box; /* ← この一行を追加！ */

    }
        #mobile-title-input {
        width: 100%;
        padding: 10px;
        font-size: 16px;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        box-sizing: border-box;
        font-weight: bold;
        outline: none;
    }


    body.is-mobile #capture-area {
        flex-grow: 1;
        display: flex; /* capture-areaをflexにして中のpitch-wrapperを伸ばす */
        padding: 10px;
    }
    body.is-mobile .pitch-wrapper {
        width: 100%;
        flex-grow: 1;
    }
    
    #mobile-subs-area {
        flex-shrink: 0;
        width: 100%;
        height: 100px;
        background: #f1f3f5;
        border-top: 1px solid #dee2e6;
        padding: 8px;
        overflow-x: auto;
        white-space: nowrap;
        box-sizing: border-box;
        padding-bottom: calc(8px + var(--safe-area-inset-bottom));
        -webkit-overflow-scrolling: touch;
        display: flex;
        gap: 15px;
    }
    .sub-category-mobile { display: flex; flex-direction: column; gap: 5px; }
    .sub-category-mobile-label { font-size: 12px; font-weight: bold; color: #868e96; }
    .sub-players-wrapper { display: flex; gap: 8px; }
    .sub-player-chip { width: 40px; height: 40px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 16px; color: white; background: var(--secondary-color); box-shadow: 0 1px 3px rgba(0,0,0,0.2); }

    /* FAB (フローティングボタン) 共通スタイル */
    .mobile-fab {
        position: fixed;
        width: 56px; height: 56px;
        border-radius: 50%;
        background-color: var(--primary-color);
        color: white;
        border: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 24px;
        z-index: 1200;
        transition: transform 0.2s, background-color 0.2s;
    }
/* 修正後のコード (ここから) */
#mobile-hamburger-btn {
    position: static; /* 位置をヘッダー内に固定 */
    width: 40px;
    height: 40px;
    flex-shrink: 0; /* 縮まないようにする */
    background-color: transparent; /* 背景を透明に */
    color: #333; /* アイコンの色 */
    box-shadow: none; /* 影を消す */
    
    /* ▼▼▼以下のスタイルを追加・確認してください▼▼▼ */
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 24px;
    padding: 0; /* 内側の余白をなくす */
    border: none; /* 枠線をなくす */
}
/* (ここまで) */#mobile-hamburger-btn { position: static; width: 40px; height: 40px; flex-shrink: 0; background-color: transparent; color: #333; box-shadow: none; }
    
    #mode-toggle-btn { /* 既存ボタンの位置を調整 */
        position: fixed; 
        right: 15px; bottom: calc(15px + var(--safe-area-inset-bottom));
        width: 56px; height: 56px; z-index: 1200;
    }
    #mobile-player-list-btn.bottom-left {
        left: 15px; bottom: calc(15px + var(--safe-area-inset-bottom));
    }
            .mobile-formation-fab {
        position: fixed;
        left: 50%;
        bottom: calc(15px + var(--safe-area-inset-bottom));
        transform: translateX(-50%);
        width: auto; /* 横幅を自動調整に変更 */
        height: 44px; /* 高さを少し小さく */
        border-radius: 22px; /* 角を丸くする */
        padding: 0 20px; /* 横の余白を追加 */
        background-color: #6c757d;
        color: white;
        border: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 14px;
        font-weight: bold;
        z-index: 1200;
        transition: transform 0.2s, background-color 0.2s;
    }

    #mobile-player-list-panel {
        position: fixed;
        left: 0; top: 0;
        width: 85%;
        max-width: 320px;
        height: 100vh;
        background: #fff;
        box-shadow: 4px 0 15px rgba(0,0,0,0.2);
        z-index: 1500;
        transform: translateX(-105%);
        transition: transform 0.3s ease-in-out;
        display: flex;
        flex-direction: column;
    }
    #mobile-player-list-panel.is-open {
        transform: translateX(0);
    }
    #mobile-player-list-panel .panel-header {
        padding: 15px;
        padding-top: calc(15px + var(--safe-area-inset-top));
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #eee;
    }
    #mobile-player-list-panel .panel-header h3 { margin: 0; font-size: 1.1em; }
    #add-player-btn-mobile { width: auto; padding: 6px 12px; font-size: 14px; }
    
    #panel-player-list-grid {
        flex-grow: 1;
        overflow-y: auto;
        padding: 15px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        align-content: flex-start;
    }
    .list-player-item { display: flex; flex-direction: column; align-items: center; cursor: grab; user-select: none; }
    .list-player-item.is-assigned { opacity: 0.4; cursor: not-allowed; }
    .list-player-marker {
        width: 30px; height: 30px;
        border-radius: 50%;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: white; font-weight: bold;
        position: relative; /* for number */
    }
    .list-player-marker .list-player-number { position: absolute; top: 8px; font-size: 12px; opacity: 0.9; }
    .list-player-marker .list-player-name { font-size: 15px; text-align: center; padding: 0 5px; line-height: 1.2; word-break: break-all; }
    .list-player-marker.gk { background-color: var(--marker-gk-color); color: #333; }
    .list-player-marker.df { background-color: var(--marker-df-color); }
    .list-player-marker.mf { background-color: var(--marker-mf-color); }
    .list-player-marker.fw { background-color: var(--marker-fw-color); }
    
    /* ピッチのプレースホルダースタイル */
    .player-container.is-empty .player-marker { background: rgba(0,0,0,0.1); border-style: dashed; }
    .player-container.is-empty .player-number { display: none; }
    .player-container.is-empty .player-pos { font-weight: bold; font-size: 14px; color: rgba(255,255,255,0.7); opacity: 1; }
    .player-container.is-empty .player-name { display: none; }
    .player-container.is-empty .unassign-btn { display: none; }

    #mobile-unassign-bumper {
        position: fixed;
        top: 0;
        left: 0; right: 0;
        background: rgba(220, 53, 69, 0.8);
        color: white;
        text-align: center;
        padding: 20px;
        padding-top: calc(20px + var(--safe-area-inset-top));
        z-index: 1600;
        transform: translateY(-105%);
        transition: transform 0.2s ease-in-out, background-color 0.2s;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px; font-size: 18px; font-weight: bold;
    }
    #mobile-unassign-bumper.is-visible {
        transform: translateY(0);
    }
     #mobile-unassign-bumper.is-droppable {
        background: rgba(180, 40, 55, 0.95); /* Drop hover effect */
    }
    .is-capturing .mobile-formation-fab { display: none; } /* 画像保存時に非表示 */

} /* End of @media */
/* 修正箇所: スタイルシートの末尾に追加 */

/* --- START: スマホUI改善スタイル --- */
@media (max-width: 768px) {
    #panel-player-list-grid {
        grid-template-columns: repeat(2, 1fr); /* 2列グリッド */
        gap: 20px;
        padding: 15px;
        align-content: flex-start;
    }

    .list-player-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
        user-select: none;
        cursor: grab;
    }
    .list-player-item.is-assigned {
        opacity: 0.4;
        cursor: not-allowed;
    }

    .list-player-marker {
        width: 75px;
        height: 75px;
        border-radius: 50%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        font-weight: bold;
        color: white;
        text-align: center;
        box-shadow: 0 3px 6px rgba(0,0,0,0.2);
        position: relative;
    }
    .list-player-marker .list-player-number {
        position: absolute;
        top: 10px;
        font-size: 14px;
        opacity: 0.9;
    }
    .list-player-marker .list-player-name {
        font-size: 12px;
        line-height: 1.2;
        padding: 0px;
        word-break: auto-phrase
;
    }
    
    .list-player-marker.gk { background-color: var(--marker-gk-color); color: #333; }
    .list-player-marker.df { background-color: var(--marker-df-color); }
    .list-player-marker.mf { background-color: var(--marker-mf-color); }
    .list-player-marker.fw { background-color: var(--marker-fw-color); }

    /* ピッチのプレースホルダースタイル */
    .player-container.is-empty .player-marker {
        background: rgba(0,0,0,0.1);
        border: 2px dashed rgba(255,255,255,0.5);
    }
    .player-container.is-empty .player-number { display: none; }
    .player-container.is-empty .player-pos {
        font-weight: bold;
        font-size: 14px;
        color: rgba(255,255,255,0.7);
        opacity: 1;
    }
    .player-container.is-empty .player-name { display: none; }
    .player-container.is-empty .unassign-btn { display: none; }
}

        /* ドラッグ中の控え選手エリアのスタイル */
        body.is-dragging-player.is-mobile #mobile-subs-area {
            outline: 2px dashed var(--primary-color);
            outline-offset: -4px;
            background-color: #e9f5ff;
        }
/* --- END: スマホUI改善スタイル --- */
/* --- END: スマートフォンUIスタイル --- */
/* --- START: スマホUIヘッダー改修スタイル --- */
@media (max-width: 768px) {
    .mobile-header h2#mobile-app-logo {
        margin: 0;
        font-size: 22px;
        color: var(--primary-color);
        flex-grow: 1;
        line-height: 1;
        font-family: 'Helvetica Neue', Arial, sans-serif;
    }
    .mobile-title-wrapper {
        padding: 0 15px 10px 15px;
        background: #f8f9fa;
        flex-shrink: 0;
        box-sizing: border-box;
    }
}
/* --- END: スマホUIヘッダー改修スタイル --- */
/* --- START: ロゴ画像差し替え準備スタイル --- */
@media (max-width: 768px) {
    .mobile-logo-link {
        text-decoration: none;
        display: flex;
        align-items: center;
        flex-grow: 1;
    }
    .mobile-logo-link img {
        height: 28px; /* ロゴ画像の高さを指定 */
        width: auto;
    }
}
/* --- END: ロゴ画像差し替え準備スタイル --- */
/* --- START: アクションシートのスタイル --- */
#share-action-sheet {
    align-items: flex-end; /* 画面下に配置 */
    background: rgba(0,0,0,0.4);
    z-index: 2500;
}
.action-sheet-content {
    background: #f4f4f4;
    width: 100%;
    max-width: 500px;
    margin: 0 auto;
    padding: 10px;
    padding-bottom: calc(10px + env(safe-area-inset-bottom, 0px)); /* スマホのノッチ対応 */
    box-sizing: border-box;
    transform: translateY(100%);
    transition: transform 0.25s ease-out;
    display: flex;
    flex-direction: column;
    gap: 8px;
    border-radius: 16px 16px 0 0;
}
#share-action-sheet.is-open .action-sheet-content {
    transform: translateY(0);
}
.action-sheet-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    padding: 16px;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    background-color: #fff;
    color: var(--primary-color);
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    transition: background-color 0.2s;
}
.action-sheet-btn:active {
    background-color: #e9e9e9;
    transform: scale(1); /* 既存のボタン効果を無効化 */
}
.action-sheet-btn.cancel {
    background-color: #fff;
    color: var(--danger-color);
    margin-top: 8px;
}
/* --- END: アクションシートのスタイル --- */
    </style>
</head>
<body data-layout-mode="vertical" data-drag-mode="swap">
    <div id="update-notification" style="display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #333; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 9999; font-size: 14px; align-items: center; gap: 15px;">
        <span>新しいバージョンが利用可能です。</span>
        <button id="update-btn" style="width: auto; padding: 6px 12px; font-size: 13px; background-color: var(--primary-color); color: white; border: none; border-radius: 5px; cursor: pointer;">更新</button>
    </div>
                <header class="mobile-header">
        <!-- ロゴ部分：将来的に画像に差し替える場合は、下の<h2>タグを<img src="画像のパス">に置き換えます -->
        <a href="./index.html" class="mobile-logo-link">
            <h2 id="mobile-app-logo">XISync</h2>
        </a>        <button id="mobile-hamburger-btn" class="mobile-fab">≡</button>
    </header>
        <div class="mobile-title-wrapper">
        <input type="text" id="mobile-title-input" placeholder="タイトルを入力">
    </div>

    <div id="mobile-player-list-panel">
        <div class="panel-header">
            <h3>選手リスト</h3>
            <button id="add-player-btn-mobile" class="btn-primary">+</button>
        </div>
        <div id="panel-player-list-grid">
            <!-- ここに選手マーカーがJSで描画されます -->
        </div>
    </div>
    
    <button id="mobile-formation-btn" class="mobile-formation-fab">4-2-3-1</button>
    <button id="mobile-player-list-btn" class="mobile-fab bottom-left">👤</button>
    <!-- 既存の #mode-toggle-btn はそのまま使い、CSSで位置を調整します -->

    <div id="mobile-unassign-bumper">
        <span>🗑️ リストに戻す</span>
    </div>

    <div id="mobile-hamburger-menu" class="modal-overlay">
        <div class="modal-content">
             <h3>メニュー</h3>
             <div style="display: flex; flex-direction: column; gap: 15px;">
                <button id="save-image-btn-mobile" class="btn-primary">画像を保存</button>
                <button id="reset-all-btn-mobile" class="btn-danger">全配置をリセット</button>
                <button id="share-data-btn-mobile" class="btn-secondary">リストを共有 / 読込</button>
             </div>
        </div>
    </div><div class="pc-ui-wrapper">
        <div id="mobile-notice-banner">
        <div class="banner-content">
            <span class="icon">⚠️</span>
            <p>現在、スマートフォン表示は開発中です。一部機能が正常に動作しない場合があります。</p>
        </div>
        <button id="close-notice-btn" title="閉じる">&times;</button>
    </div>
    <div class="sidebar-handle"></div>
    <div class="container">
        <div class="left-panel">
            <div id="player-management-section-left" class="control-group"></div>
        </div>

        <div class="main-content">
            <input type="text" id="title-input" placeholder="タイトルを入力">
            <div id="capture-area">
                <div class="pitch-wrapper vertical" id="pitch-wrapper">
                    <div class="capture-title" id="capture-title"></div>
                    <div class="pitch" id="pitch"></div>
                </div>
                <div class="capture-subs" id="capture-subs"></div>
                <div id="capture-watermark" class="capture-watermark"></div>
            </div>
        </div>

    <div id="mobile-subs-area">
        <!-- ここに控え選手がJSで描画されます -->
    </div>

        <aside class="right-panel">
             <div class="app-branding">
                <h2>XISync</h2>
            </div>

            <div class="control-group">
                <label>ピッチの向き</label>
                <div class="orientation-toggle">
                    <input type="radio" id="orientation-v" name="orientation" value="vertical" checked><label for="orientation-v">縦</label>
                    <input type="radio" id="orientation-h" name="orientation" value="horizontal"><label for="orientation-h">横</label>
                </div>
            </div>
            <div class="control-group">
                <label>フォーメーション</label>
                <button id="open-formation-modal-btn" class="btn-secondary"></button>
            </div>

            <div id="player-management-section" class="control-group" style="gap: 25px;">
                <div class="control-group">
                    <label>選手管理</label>
                    <div id="player-list-controls">
                        <button id="open-sidebar-btn" class="btn-primary">
                             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M15.78 4.33C15.42 4.08 15 4 14.56 4h-5.12c-.44 0-.82.08-1.18.33L3 7.84V19c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V7.84l-5.22-3.51zM10 16H8v-2h2v2zm0-4H8v-2h2v2zm6 4h-2v-2h2v2zm0-4h-2v-2h2v2z"></path></svg>
                            <span>選手リストを開く</span>
                        </button>
                        <button id="share-data-btn" class="btn-secondary" style="margin-top: 10px; font-size: 14px; padding: 10px;">リストを共有 / 読込</button>
                    </div>
                </div>
                <div class="control-group">
                    <label>控え選手</label>
                    <div id="substitutes-container">
                        <div class="sub-drop-zone" data-pos-category="ALL"></div>
                    </div>
                </div>
            </div>
            
            <div class="control-group">
                <label>操作</label>
                <button id="save-image-btn" class="btn-primary">画像を保存する</button>
                <button id="reset-all-btn" class="btn-danger" style="margin-top: 10px;">全配置をリセット</button>
            </div>
        </aside>
    </div>
    <div class="modal-overlay" id="share-action-sheet">
        <div class="action-sheet-content">
            <button id="action-sheet-share-btn" class="action-sheet-btn">
                <span>アプリで共有</span>
            </button>
            <button id="action-sheet-save-btn" class="action-sheet-btn">
                <span>端末に保存</span>
            </button>
            <button id="action-sheet-cancel-btn" class="action-sheet-btn cancel">キャンセル</button>
        </div>
    </div>
    <!-- Sidebar, Modals, FAB -->
    <div id="player-list-sidebar">
        <div class="sidebar-header">
            <div class="title-bar">
                <h3>選手リスト</h3>
                <button class="pin-sidebar-btn" title="サイドバーを固定">📌</button>
            </div>
        </div>
        <div class="sidebar-add-player">
            <div class="add-player-form">
                <input type="number" id="sidebar-new-player-number" placeholder="No." min="1" inputmode="numeric" style="ime-mode: inactive;">
                <input type="text" id="sidebar-new-player-name" placeholder="選手名">
                <select id="sidebar-new-player-pos" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                    <option value="FW">FW</option>
                    <option value="MF">MF</option>
                    <option value="DF">DF</option>
                    <option value="GK">GK</option>
                </select>
                <button id="sidebar-add-player-btn" class="btn-primary">+</button>
            </div>
        </div>
        <div id="sidebar-player-list"></div>
    </div>        

    <div class="modal-overlay" id="formation-modal">
        <div class="modal-content">
            <button class="modal-close-btn">&times;</button>
            <h3>フォーメーションを選択</h3>
            <div id="formation-grid"></div>
        </div>
    </div>
    
    <div class="modal-overlay" id="edit-player-modal">
        <div class="modal-content">
            <button class="modal-close-btn">&times;</button>
            <h3>選手情報の編集</h3>
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <div class="form-group">
                    <label for="edit-player-number">背番号</label>
                    <div class="number-input-wrapper">
                        <button id="decrement-btn" class="number-input-btn">-</button>
                        <input type="number" id="edit-player-number" inputmode="numeric" style="ime-mode: inactive;">
                        <button id="increment-btn" class="number-input-btn">+</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="edit-player-name">選手名</label>
                    <input type="text" id="edit-player-name">
                </div>
                <div class="form-group">
                    <label for="edit-player-pos">ポジション</label>
                    <select id="edit-player-pos" style="width: 100%; padding: 12px; font-size: 16px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box;">
                        <option value="FW">FW</option>
                        <option value="MF">MF</option>
                        <option value="DF">DF</option>
                        <option value="GK">GK</option>
                    </select>
                </div>
                <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;">
                    <button id="save-player-changes-btn" class="btn-primary">変更を保存</button>
                    <button id="delete-player-btn-modal" class="btn-danger">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
                        <span>この選手を削除する</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="share-modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn">&times;</button>
            <h3>選手リストの共有 / 読み込み</h3>
            <div class="share-section">
                <div class="share-section-title">リストを出力</div>
                <div class="share-actions" style="flex-direction: column; gap: 10px;">
                    <button id="copy-url-btn" class="btn-primary">URLをコピーして共有</button>
                    <button id="copy-squad-btn" class="btn-secondary">テキスト(データ)をコピー</button>
                    <button id="export-squad-btn" class="btn-secondary">ファイルで保存</button>
                </div>
            </div>
            <div class="share-section">
                <div class="share-section-title">リストを読み込み</div>
                <div class="share-actions">
                    <button id="import-from-clipboard-btn" class="btn-primary">クリップボードから読込</button>
                    <label for="import-squad-input" class="btn-secondary">ファイルを選択して読込</label>
                    <input type="file" id="import-squad-input" accept=".json, .txt">
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="import-confirm-modal">
        <div class="modal-content">
            <h3>選手リストのインポート</h3>
            <p>共有された選手データで現在のリストを上書きしますか？配置はリセットされます。</p>
            <div id="import-preview-list" style="max-height: 200px; overflow-y: auto; border: 1px solid #eee; padding: 10px; margin-bottom: 20px; border-radius: 6px;">
            </div>
            <div style="display: flex; gap: 10px;">
                <button id="confirm-import-btn" class="btn-primary" style="flex: 1;">インポートする</button>
                <button id="cancel-import-btn" class="btn-secondary" style="flex: 1;">キャンセル</button>
            </div>
        </div>
    </div>
    
    <div class="drag-ghost" id="drag-ghost">
        <span class="num"></span>
        <span class="name"></span>
    </div>
    
    <button id="mode-toggle-btn" class="mode-toggle-fab" title="マーカー操作モード切替"></button>
    <div id="mode-toast" class="mode-toast"></div>
</div>
<script>


document.addEventListener('DOMContentLoaded', () => {
    
const App = {
    els: {},
    isMobile: false, 
    isDraggingPlayer: false,
    _lastDragStartType: null,
    state: {
        squad: [],
        starters: {}, // { "posId": { playerId, coords }, ... }
        substitutes: { GK: [], DF: [], MF: [], FW: [] },
        config: {
            orientation: 'vertical',
            formation: '4-2-3-1',
            dragMode: 'swap',
            title: ''
        },
    },

    editingPlayerId: null,
    toastTimer: null,
    numberChangeInterval: null,
        _importedSquadData: null,
    sidebarHoverTimer: null,
        isIOS() {
        return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    },

    init() {
        this.isMobile = window.innerWidth <= 768; 
        this.cacheElements();
        if (this.isMobile) {
            this.els.body.classList.add('is-mobile');
        }
        this.setupNoticeBanner(); 
        this.defineConstants();
        this.clonePanels();
        this.loadState();
        this.checkUrlForSquadData();
        this.buildFormationModal();
        this.bindEvents();
        this.renderAll();
    },
    
    setupNoticeBanner() {
        const noticeBanner = document.getElementById('mobile-notice-banner');
        const closeNoticeBtn = document.getElementById('close-notice-btn');
        if (noticeBanner && closeNoticeBtn) {
            if (sessionStorage.getItem('mobileNoticeClosed') === 'true') {
                noticeBanner.style.display = 'none';
            }
            closeNoticeBtn.addEventListener('click', () => {
                noticeBanner.style.display = 'none';
                sessionStorage.setItem('mobileNoticeClosed', 'true');
            });
        }
    },

    cacheElements() {
        const query = (selector) => document.querySelector(selector);
        const queryAll = (selector) => document.querySelectorAll(selector);
        this.els = {
            body: document.body, pitch: query('#pitch'), pitchWrapper: query('#pitch-wrapper'),
            saveImageBtn: query('#save-image-btn'), dragGhost: query('#drag-ghost'),
            orientationRadios: document.getElementsByName('orientation'), titleInput: query('#title-input'),
            playerManagementSectionLeft: query('#player-management-section-left'),
            playerManagementSectionRight: query('#player-management-section'),
            panels: {
                left: { subDropZones: queryAll('.left-panel .sub-drop-zone') },
                right: { openFormationModalBtn: query('.right-panel #open-formation-modal-btn'), subDropZones: queryAll('.right-panel .sub-drop-zone'), resetAllBtn: query('#reset-all-btn') }
            },
            shareModal: {
                overlay: query('#share-modal-overlay'), copyUrlBtn: query('#copy-url-btn'),
                copySquadBtn: query('#copy-squad-btn'), exportSquadBtn: query('#export-squad-btn'),
                importSquadInput: query('#import-squad-input'), importFromClipboardBtn: query('#import-from-clipboard-btn')
            },
            sidebar: {
                el: query('#player-list-sidebar'), list: query('#sidebar-player-list'),
                addBtn: query('#sidebar-add-player-btn'), numberInput: query('#sidebar-new-player-number'),
                nameInput: query('#sidebar-new-player-name'), posSelect: query('#sidebar-new-player-pos')
            },
            editModal: {
                overlay: query('#edit-player-modal'), numberInput: query('#edit-player-number'),
                nameInput: query('#edit-player-name'), posSelect: query('#edit-player-pos'), saveBtn: query('#save-player-changes-btn'),
                deleteBtn: query('#delete-player-btn-modal'), incrementBtn: query('#increment-btn'), decrementBtn: query('#decrement-btn')
            },
            importConfirmModal: {
                overlay: query('#import-confirm-modal'), previewList: query('#import-preview-list'),
                confirmBtn: query('#confirm-import-btn'), cancelBtn: query('#cancel-import-btn')
            },
            formationModal: { overlay: query('#formation-modal'), grid: query('#formation-grid') },
            modeToggleBtn: query('#mode-toggle-btn'), modeToast: query('#mode-toast'),
            sidebarHandle: query('.sidebar-handle'),
            pinSidebarBtn: query('.pin-sidebar-btn'),
        mobile: {
            header: query('.mobile-header'),
            titleInput: query('#mobile-title-input'),
            hamburgerBtn: query('#mobile-hamburger-btn'),
            hamburgerMenu: query('#mobile-hamburger-menu'),
            saveImageBtn: query('#save-image-btn-mobile'),
            resetAllBtn: query('#reset-all-btn-mobile'),
            shareDataBtn: query('#share-data-btn-mobile'),
            subsArea: query('#mobile-subs-area'),
            playerListPanel: query('#mobile-player-list-panel'),
            playerListGrid: query('#panel-player-list-grid'),
            addPlayerBtn: query('#add-player-btn-mobile'),
            formationBtn: query('#mobile-formation-btn'),
            playerListBtn: query('#mobile-player-list-btn'),
            unassignBumper: query('#mobile-unassign-bumper')
        }
        };
        this.els.allModals = queryAll('.modal-overlay');
        this.els.allCloseBtns = queryAll('.modal-close-btn');
                this.els.shareActionSheet = {
            overlay: query('#share-action-sheet'),
            shareBtn: query('#action-sheet-share-btn'),
            saveBtn: query('#action-sheet-save-btn'),
            cancelBtn: query('#action-sheet-cancel-btn')
        };
    },

    defineConstants() {
        this.formations = {'4-3-3':{name:'4-3-3',note:'',spec:[{pos:'GK'},{pos:'RSB'},{pos:'RCB'},{pos:'LCB'},{pos:'LSB'},{pos:'DMF'},{pos:'RCM'},{pos:'LCM'},{pos:'RWG'},{pos:'CF'},{pos:'LWG'}]},'4-4-2':{name:'4-4-2',note:'',spec:[{pos:'GK'},{pos:'RSB'},{pos:'RCB'},{pos:'LCB'},{pos:'LSB'},{pos:'RMF'},{pos:'CMF'},{pos:'CMF',isDuplicate:true},{pos:'LMF'},{pos:'FW'},{pos:'FW',isDuplicate:true}]},'4-2-3-1':{name:'4-2-3-1',note:'Standard',spec:[{pos:'GK'},{pos:'RSB'},{pos:'RCB'},{pos:'LCB'},{pos:'LSB'},{pos:'DMF'},{pos:'DMF',isDuplicate:true},{pos:'RMF'},{pos:'AMF'},{pos:'LMF'},{pos:'CF'}]},'4-1-4-1':{name:'4-1-4-1',note:'',spec:[{pos:'GK'},{pos:'RSB'},{pos:'RCB'},{pos:'LCB'},{pos:'LSB'},{pos:'DMF'},{pos:'RMF'},{pos:'RCM'},{pos:'LCM'},{pos:'LMF'},{pos:'CF'}]},'4-3-1-2':{name:'4-3-1-2',note:'Diamond',spec:[{pos:'GK'},{pos:'RSB'},{pos:'RCB'},{pos:'LCB'},{pos:'LSB'},{pos:'DMF'},{pos:'RCM'},{pos:'LCM'},{pos:'AMF'},{pos:'FW'},{pos:'FW',isDuplicate:true}]},'4-3-2-1':{name:'4-3-2-1',note:'Tree',spec:[{pos:'GK'},{pos:'RSB'},{pos:'RCB'},{pos:'LCB'},{pos:'LSB'},{pos:'RCM'},{pos:'CMF'},{pos:'LCM'},{pos:'RAM'},{pos:'LAM'},{pos:'CF'}]},'3-5-2':{name:'3-5-2',note:'',spec:[{pos:'GK'},{pos:'RCB'},{pos:'CB'},{pos:'LCB'},{pos:'RWB'},{pos:'RCM'},{pos:'DMF'},{pos:'LCM'},{pos:'LWB'},{pos:'FW'},{pos:'FW',isDuplicate:true}]},'3-4-3':{name:'3-4-3',note:'',spec:[{pos:'GK'},{pos:'RCB'},{pos:'CB'},{pos:'LCB'},{pos:'RMF'},{pos:'CMF'},{pos:'CMF',isDuplicate:true},{pos:'LMF'},{pos:'RWG'},{pos:'CF'},{pos:'LWG'}]},'3-4-2-1':{name:'3-4-2-1',note:'',spec:[{pos:'GK'},{pos:'RCB'},{pos:'CB'},{pos:'LCB'},{pos:'RWB'},{pos:'DMF'},{pos:'DMF',isDuplicate:true},{pos:'LWB'},{pos:'RAM'},{pos:'LAM'},{pos:'CF'}]},'5-3-2':{name:'5-3-2',note:'',spec:[{pos:'GK'},{pos:'RCB'},{pos:'CB'},{pos:'LCB'},{pos:'RWB'},{pos:'LWB'},{pos:'RCM'},{pos:'CMF'},{pos:'LCM'},{pos:'FW'},{pos:'FW',isDuplicate:true}]},'5-4-1':{name:'5-4-1',note:'',spec:[{pos:'GK'},{pos:'RSB'},{pos:'RCB'},{pos:'CB'},{pos:'LCB'},{pos:'LSB'},{pos:'RMF'},{pos:'RCM'},{pos:'LCM'},{pos:'LMF'},{pos:'CF'}]}};
        this.formationCoords = {'4-3-3':[{top:50,left:8},{top:85,left:28},{top:65,left:25},{top:35,left:25},{top:15,left:28},{top:50,left:48},{top:70,left:60},{top:30,left:60},{top:80,left:80},{top:50,left:90},{top:20,left:80}],'4-4-2':[{top:50,left:8},{top:85,left:28},{top:65,left:25},{top:35,left:25},{top:15,left:28},{top:85,left:55},{top:60,left:50},{top:40,left:50},{top:15,left:55},{top:65,left:82},{top:35,left:82}],'4-2-3-1':[{top:50,left:8},{top:85,left:28},{top:65,left:25},{top:35,left:25},{top:15,left:28},{top:65,left:48},{top:35,left:48},{top:80,left:70},{top:50,left:72},{top:20,left:70},{top:50,left:92}],'4-1-4-1':[{top:50,left:8},{top:85,left:28},{top:65,left:25},{top:35,left:25},{top:15,left:28},{top:50,left:45},{top:85,left:65},{top:65,left:62},{top:35,left:62},{top:15,left:65},{top:50,left:88}],'4-3-1-2':[{top:50,left:8},{top:85,left:28},{top:65,left:25},{top:35,left:25},{top:15,left:28},{top:50,left:45},{top:75,left:55},{top:25,left:55},{top:50,left:70},{top:65,left:88},{top:35,left:88}],'4-3-2-1':[{top:50,left:8},{top:85,left:28},{top:65,left:25},{top:35,left:25},{top:15,left:28},{top:70,left:55},{top:50,left:50},{top:30,left:55},{top:65,left:75},{top:35,left:75},{top:50,left:92}],'3-5-2':[{top:50,left:8},{top:75,left:28},{top:50,left:25},{top:25,left:28},{top:90,left:55},{top:70,left:50},{top:50,left:42},{top:30,left:50},{top:10,left:55},{top:65,left:85},{top:35,left:85}],'3-4-3':[{top:50,left:8},{top:75,left:28},{top:50,left:25},{top:25,left:28},{top:85,left:58},{top:65,left:52},{top:35,left:52},{top:15,left:58},{top:80,left:80},{top:50,left:90},{top:20,left:80}],'3-4-2-1':[{top:50,left:8},{top:75,left:28},{top:50,left:25},{top:25,left:28},{top:85,left:58},{top:65,left:50},{top:35,left:50},{top:15,left:58},{top:65,left:78},{top:35,left:78},{top:50,left:92}],'5-3-2':[{top:50,left:8},{top:75,left:28},{top:50,left:25},{top:25,left:28},{top:90,left:35},{top:10,left:35},{top:75,left:60},{top:50,left:55},{top:25,left:60},{top:65,left:85},{top:35,left:85}],'5-4-1':[{top:50,left:8},{top:90,left:28},{top:70,left:25},{top:50,left:22},{top:30,left:25},{top:10,left:28},{top:85,left:58},{top:60,left:52},{top:40,left:52},{top:15,left:58},{top:50,left:85}]};        this.svgIcons = {position:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M7.646.146a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 1.707V5.5a.5.5 0 0 1-1 0V1.707L6.354 2.854a.5.5 0 1 1-.708-.708l2-2zM8 10a.5.5 0 0 1 .5.5v3.793l1.146-1.147a.5.5 0 0 1 .708.708l-2 2a.5.5 0 0 1-.708 0l-2-2a.5.5 0 0 1 .708-.708L7.5 14.293V10.5A.5.5 0 0 1 8 10zM.146 8.354a.5.5 0 0 1 0-.708l2-2a.5.5 0 1 1 .708.708L1.707 7.5H5.5a.5.5 0 0 1 0 1H1.707l1.147 1.146a.5.5 0 0 1-.708.708l-2-2zM10 8a.5.5 0 0 1 .5-.5h3.793l-1.147-1.146a.5.5 0 0 1 .708-.708l2 2a.5.5 0 0 1 0 .708l-2 2a.5.5 0 0 1-.708-.708L14.293 8.5H10.5A.5.5 0 0 1 10 8z"/></svg>',swap:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1 11.5a.5.5 0 0 0 .5.5h11.793l-1.147 1.146a.5.5 0 0 0 .708.708l2-2a.5.5 0 0 0 0-.708l-2-2a.5.5 0 0 0-.708.708L13.293 11H1.5a.5.5 0 0 0-.5.5zm14-7a.5.5 0 0 1-.5.5H2.707l1.147 1.146a.5.5 0 1 1-.708.708l-2-2a.5.5 0 0 1 0-.708l2-2a.5.5 0 1 1 .708.708L2.707 4H14.5a.5.5 0 0 1 .5.5z"/></svg>'};
    },

    clonePanels() {
        this.els.playerManagementSectionLeft.innerHTML = this.els.playerManagementSectionRight.innerHTML;
        this.cacheElements(); 
        this.els.allShareBtns = document.querySelectorAll('#share-data-btn');
        this.els.allOpenSidebarBtns = document.querySelectorAll('#open-sidebar-btn');
    },
    
    bindEvents() {
        document.addEventListener('dragend', this.handleDragEnd.bind(this));
            if (this.isMobile) {
        // Title sync
        this.els.mobile.titleInput.addEventListener('input', (e) => this.els.titleInput.value = e.target.value);
        this.els.titleInput.addEventListener('input', (e) => this.els.mobile.titleInput.value = e.target.value);

        // Hamburger Menu
        this.els.mobile.hamburgerBtn.addEventListener('click', () => this.openModal(this.els.mobile.hamburgerMenu));
        this.els.mobile.hamburgerMenu.addEventListener('click', (e) => {
            if (e.target === this.els.mobile.hamburgerMenu) this.closeAllModals();
        });
        this.els.mobile.saveImageBtn.addEventListener('click', this.saveImage.bind(this));
        this.els.mobile.resetAllBtn.addEventListener('click', this.resetAllAssignments.bind(this));
        this.els.mobile.shareDataBtn.addEventListener('click', () => { this.closeAllModals(); this.openModal(this.els.shareModal.overlay); });

        // Player List Panel
        this.els.mobile.playerListBtn.addEventListener('click', () => {
            this.els.mobile.playerListPanel.classList.toggle('is-open');
        });
       		// パネルの外側をクリックしたら閉じるイベント
		document.addEventListener('click', (e) => {
			const panel = this.els.mobile.playerListPanel;
            const isClickInsideModal = e.target.closest('.modal-overlay');

			// パネルが開いていて、かつクリックした場所がパネル/ボタン/モーダルの「外側」である場合
			if (panel.classList.contains('is-open') && !panel.contains(e.target) && !this.els.mobile.playerListBtn.contains(e.target) && !isClickInsideModal) {
				panel.classList.remove('is-open');
			}
		});
        this.els.mobile.addPlayerBtn.addEventListener('click', () => {
            this.editingPlayerId = null; // 新規追加モードに設定
            this.els.editModal.numberInput.value = '';
            this.els.editModal.nameInput.value = '';
            this.els.editModal.posSelect.value = 'FW';
            this.openModal(this.els.editModal.overlay);
        });

        // Formation Popover
        this.els.mobile.formationBtn.addEventListener('click', () => {
            this.buildFormationModal(); // Logic will be modified to use popover on mobile
            this.openModal(this.els.formationModal.overlay); // Temporarily uses existing modal
        });
        
        // Unassign Bumper drag events
        this.els.mobile.unassignBumper.addEventListener('dragover', (e) => {
            e.preventDefault();
            this.els.mobile.unassignBumper.classList.add('is-droppable');
        });
         this.els.mobile.unassignBumper.addEventListener('dragleave', () => {
            this.els.mobile.unassignBumper.classList.remove('is-droppable');
        });
         this.els.mobile.unassignBumper.addEventListener('drop', (e) => {
            e.preventDefault();
            const data = JSON.parse(e.dataTransfer.getData('application/json'));
            if (data.playerId) {
                this.unassignPlayer(data.playerId);
                this.renderAll();
            }
            this.els.mobile.unassignBumper.classList.remove('is-droppable');
        });
                // 控え選手エリア全体をドロップ可能にする
        const subsArea = this.els.mobile.subsArea;
        subsArea.addEventListener('dragover', this.handleDragOver.bind(this));
        subsArea.addEventListener('dragleave', this.handleDragLeave.bind(this));
        subsArea.addEventListener('drop', (e) => this.handleDropOnSubZone(e));
    }
        // --- サイドバー以外のイベントリスナー ---
        [...this.els.orientationRadios].forEach(radio => radio.addEventListener('change', e => { this.state.config.orientation = e.target.value; this.renderAll(); }));
        this.els.allShareBtns.forEach(btn => btn.addEventListener('click', () => this.openModal(this.els.shareModal.overlay)));
        if (this.els.panels.right.resetAllBtn) this.els.panels.right.resetAllBtn.addEventListener('click', this.resetAllAssignments.bind(this));
        if (this.els.panels.right.openFormationModalBtn) this.els.panels.right.openFormationModalBtn.addEventListener('click', () => { this.buildFormationModal(); this.openModal(this.els.formationModal.overlay); });

        this.els.sidebar.addBtn.addEventListener('click', this.addPlayer.bind(this));
        this.els.sidebar.nameInput.addEventListener('keypress', e => e.key === 'Enter' && this.addPlayer());

        this.els.allModals.forEach(modal => modal.addEventListener('click', e => e.target === modal && this.closeAllModals()));
        this.els.allCloseBtns.forEach(btn => btn.addEventListener('click', this.closeAllModals.bind(this)));

        this.els.editModal.saveBtn.addEventListener('click', this.savePlayerChanges.bind(this));
        this.els.editModal.deleteBtn.addEventListener('click', this.deletePlayerFromModal.bind(this));
        this.els.editModal.incrementBtn.addEventListener('click', () => this.changeNumber(1));
        this.els.editModal.decrementBtn.addEventListener('click', () => this.changeNumber(-1));
        ['mousedown', 'touchstart'].forEach(evt => {
            this.els.editModal.incrementBtn.addEventListener(evt, () => this.numberChangeInterval = setInterval(() => this.changeNumber(1), 100));
            this.els.editModal.decrementBtn.addEventListener(evt, () => this.numberChangeInterval = setInterval(() => this.changeNumber(-1), 100));
        });
        ['mouseup', 'mouseleave', 'touchend'].forEach(evt => {
            document.addEventListener(evt, () => clearInterval(this.numberChangeInterval));
        });

        this.els.shareModal.copyUrlBtn.addEventListener('click', this.copySquadUrlToClipboard.bind(this));
        this.els.shareModal.copySquadBtn.addEventListener('click', this.copySquadToClipboard.bind(this));
        this.els.shareModal.exportSquadBtn.addEventListener('click', this.exportSquadToFile.bind(this));
        this.els.shareModal.importSquadInput.addEventListener('change', this.importFromFile.bind(this));
        this.els.shareModal.importFromClipboardBtn.addEventListener('click', this.importFromClipboard.bind(this));
        
        this.els.importConfirmModal.confirmBtn.addEventListener('click', this.confirmImport.bind(this));
        this.els.importConfirmModal.cancelBtn.addEventListener('click', () => { this.closeAllModals(); history.replaceState(null, '', window.location.pathname); });

        this.els.modeToggleBtn.addEventListener('click', this.toggleDragMode.bind(this));
        this.els.saveImageBtn.addEventListener('click', this.saveImage.bind(this));

        document.querySelectorAll('.sub-drop-zone').forEach(zone => {
            zone.addEventListener('dragover', this.handleDragOver.bind(this));
            zone.addEventListener('dragleave', this.handleDragLeave.bind(this));
            zone.addEventListener('drop', this.handleDropOnSubZone.bind(this));
        });
        
        let titleSaveTimeout;
        this.els.titleInput.addEventListener('input', () => { clearTimeout(titleSaveTimeout); titleSaveTimeout = setTimeout(() => this.saveState(), 500); });
        
        // --- 新しいサイドバー操作のセットアップ ---
        this.setupSidebarControls();
    },
    
    saveState() {
        this.state.config.title = this.els.titleInput.value;
        localStorage.setItem("xisyncAppState", JSON.stringify(this.state));
    },

        loadState() {
        const savedStateJSON = localStorage.getItem("xisyncAppState");
        if (savedStateJSON) {
            try {
                const savedState = JSON.parse(savedStateJSON);
                Object.assign(this.state, savedState);
                this.state.config = {
                    ...{ orientation: "vertical", formation: "4-2-3-1", dragMode: "swap", title: "" },
                    ...savedState.config
                };
                this.state.substitutes = savedState.substitutes || { GK: [], DF: [], MF: [], FW: [] };
            } catch (e) {
                console.error("Failed to load state:", e);
            }
        }
    },

    updateUI() {
        this.els.titleInput.value = this.state.config.title;
        this.els.body.dataset.dragMode = this.state.config.dragMode;
        this.els.modeToggleBtn.innerHTML = this.svgIcons[this.state.config.dragMode];
        
        if (this.isMobile) {
            // Mobile UI updates
            this.els.mobile.titleInput.value = this.state.config.title;
            this.els.mobile.formationBtn.textContent = this.formations[this.state.config.formation].name;
        } else {
            // PC specific UI updates
            document.querySelector(`input[name="orientation"][value="${this.state.config.orientation}"]`).checked = true;
            this.els.body.dataset.layoutMode = this.state.config.orientation;
            this.els.panels.right.openFormationModalBtn.textContent = this.formations[this.state.config.formation].name;
        }
    },

    renderAll() {
        this.updateUI();
        this.renderFormation();
        this.renderPlayerList();
        this.renderSubstitutes();
        this.saveState();
    },

    renderFormation() {
        this.els.pitchWrapper.className = `pitch-wrapper ${this.state.config.orientation}`;
        this.els.pitch.innerHTML = '<div class="pitch-line center-line"></div><div class="pitch-line center-circle"></div><div class="pitch-line goal-area"></div><div class="pitch-line penalty-area"></div><div class="pitch-line penalty-arc"></div><div class="pitch-line goal"></div>';
        
        const formationSpec = this.formations[this.state.config.formation].spec;
        const formationCoords = this.formationCoords[this.state.config.formation];
        
        formationSpec.forEach((spec, index) => {
            const posId = `${spec.pos}_${spec.isDuplicate ? index : 1}`;
            this.createPlayerMarker(spec, formationCoords[index], posId);
        });
    },

    createPlayerMarker(posSpec, defaultCoords, posId) {
        const markerEl = document.createElement('div');
        markerEl.className = 'player-container';
        markerEl.dataset.posId = posId;

        const starter = this.state.starters[posId];
        const currentCoords = starter?.coords ?? defaultCoords;

        if (this.state.config.orientation === 'vertical') {
            markerEl.style.top = `${100 - (currentCoords.left * 0.9)}%`;
            markerEl.style.left = `${currentCoords.top}%`;
        } else {
            markerEl.style.top = `${currentCoords.top}%`;
            markerEl.style.left = `${currentCoords.left * 0.9}%`;
        }

        const player = starter ? this.state.squad.find(p => p.id === starter.playerId) : null;
        const role = this.getRole(posSpec.pos);
        
        if (!player) {
            markerEl.classList.add('is-empty');
        }

        markerEl.innerHTML = `
            <div class="player-marker ${role}">
                <span class="player-number">${player?.number ?? ''}</span>
                <span class="player-pos">${posSpec.pos}</span>
            </div>
            <div class="player-name">${player?.name ?? posSpec.pos}</div>`;
            
        markerEl.addEventListener('dragover', this.handleDragOver.bind(this));
        markerEl.addEventListener('dragleave', this.handleDragLeave.bind(this));
        markerEl.addEventListener('drop', (e) => this.handleDropOnPitch(e, posId));

        if (player) {
            const startDragHandler = (e) => this.handleDragStart(e, { type: 'pitch', posId: posId, playerId: player.id });

            if (this.state.config.dragMode === 'position') {
                this.makeMarkerMovable(markerEl);
                markerEl.draggable = false;
            } else {
                 markerEl.draggable = true;
                markerEl.addEventListener('dragstart', startDragHandler);
                if (this.isMobile) {
                    markerEl.addEventListener('touchstart', startDragHandler, { passive: false });
                }
            }
            const unassignBtn = document.createElement('button');
            unassignBtn.innerHTML = '&times;';
            unassignBtn.className = 'unassign-btn';
            unassignBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.unassignPlayer(player.id);
                this.renderAll();
            });
            markerEl.appendChild(unassignBtn);
        }
        this.els.pitch.appendChild(markerEl);
    },
    
    getRole(pos) {
        if (pos === 'GK') return 'gk';
        if (['B', 'SB', 'CB'].some(p => pos.includes(p))) return 'df';
        if (['MF', 'WB', 'AM', 'CM', 'DM'].some(p => pos.includes(p))) return 'mf';
        return 'fw';
    },

    makeMarkerMovable(marker) {
		const handleDown = (e) => {
			if (e.target.tagName !== 'DIV' || !e.target.classList.contains('player-marker')) return;
			marker.classList.add('is-moving');
			
			const clientX = e.clientX ?? e.touches[0].clientX;
			const clientY = e.clientY ?? e.touches[0].clientY;

			const handleMove = (moveEvent) => {
				const moveClientX = moveEvent.clientX ?? moveEvent.touches[0].clientX;
				const moveClientY = moveEvent.clientY ?? moveEvent.touches[0].clientY;

				const pitchRect = this.els.pitch.getBoundingClientRect();
				const newLeft = Math.max(0, Math.min(100, (moveClientX - pitchRect.left) / pitchRect.width * 100));
				const newTop = Math.max(0, Math.min(100, (moveClientY - pitchRect.top) / pitchRect.height * 100));
				marker.style.left = `${newLeft}%`;
				marker.style.top = `${newTop}%`;
			};
			const handleUp = () => {
				marker.classList.remove('is-moving');
				document.removeEventListener('mousemove', handleMove);
				document.removeEventListener('touchmove', handleMove);
				
				const posId = marker.dataset.posId;
				const newLeftPercent = parseFloat(marker.style.left);
				const newTopPercent = parseFloat(marker.style.top);
				
				if (this.state.config.orientation === 'vertical') {
					this.state.starters[posId].coords = { top: newLeftPercent, left: (100 - newTopPercent) / 0.9 };
				} else {
					this.state.starters[posId].coords = { top: newTopPercent, left: newLeftPercent / 0.9 };
				}
				this.saveState();
			};
			
			document.addEventListener('mousemove', handleMove);
			document.addEventListener('touchmove', handleMove, { passive: false });
			document.addEventListener('mouseup', handleUp, { once: true });
			document.addEventListener('touchend', handleUp, { once: true });
		};
	const playerMarkerEl = marker.querySelector('.player-marker');
	playerMarkerEl.addEventListener('mousedown', handleDown);
	playerMarkerEl.addEventListener('touchstart', handleDown, { passive: false });	},

    renderPlayerList() {
        const assignedPlayerIds = new Set([
            ...Object.values(this.state.starters).map(s => s.playerId),
            ...Object.values(this.state.substitutes).flat()
        ]);

        if (this.isMobile) {
            // ▼▼▼ スマートフォン用のレンダリング処理 ▼▼▼
            const gridContainer = this.els.mobile.playerListGrid;
            gridContainer.innerHTML = '';

            if (this.state.squad.length === 0) {
                gridContainer.innerHTML = '<p style="color:#888; grid-column: 1 / -1; text-align: center;">選手がいません。<br>「+」ボタンから追加してください。</p>';
                return;
            }

            this.state.squad.sort((a, b) => a.number - b.number).forEach(player => {
                const isAssigned = assignedPlayerIds.has(player.id);
                const itemEl = document.createElement('div');
                itemEl.className = `list-player-item ${isAssigned ? 'is-assigned' : ''}`;
                
                if (!isAssigned) {
                    itemEl.draggable = true;

                                         let longPressTimer;
                    let hasMoved = false;
                    let touchStartX, touchStartY;

                    const handleTouchStart = (e) => {
                        // ▼▼▼ ここから修正 ▼▼▼
                        const targetElement = e.currentTarget; // 先に要素を保持しておく
                        hasMoved = false;
                        const touch = e.touches[0];
                        touchStartX = touch.clientX;
                        touchStartY = touch.clientY;
                        
                        // 300ミリ秒後にドラッグを開始するタイマーをセット
                        longPressTimer = setTimeout(() => {
                            if (navigator.vibrate) navigator.vibrate(50); // 短い振動でフィードバック
                            // 保持しておいた要素を引数で渡す
                            this.handleDragStart(e, { type: 'list', playerId: player.id }, targetElement); 
                        }, 300);
                        // ▲▲▲ ここまで修正 ▲▲▲
                    };

                                        const handleTouchMove = (e) => {
                        // イベントのデフォルトの動作（スクロール）をキャンセルする
                        e.preventDefault();

                        // 指が少しでも動いたら、長押し判定をキャンセル
                        clearTimeout(longPressTimer);
                        const touch = e.touches[0];
                        if (Math.abs(touch.clientX - touchStartX) > 10 || Math.abs(touch.clientY - touchStartY) > 10) {
                            hasMoved = true;
                        }
                    };

                    const handleTouchEnd = (e) => {
                        // 指を離した時点で、長押し判定をキャンセル
                        clearTimeout(longPressTimer);
                        if (!hasMoved) {
                            // スワイプされていなければ（＝タップなら）編集モーダルを開く
                            this.openEditModal(player.id);
                        }
                    };

                    itemEl.addEventListener('dragstart', (e) => this.handleDragStart(e, { type: 'list', playerId: player.id }));
                    // passive: false を設定
                    itemEl.addEventListener('touchstart', handleTouchStart, { passive: false });
                    itemEl.addEventListener('touchmove', handleTouchMove, { passive: false }); // ← touchmoveにも設定
                    itemEl.addEventListener('touchend', handleTouchEnd);
                }

                const role = (player.posCategory || 'fw').toLowerCase();
                itemEl.innerHTML = `
                    <div class="list-player-marker ${role}">
                        <span class="list-player-number">${player.number}</span>
                        <span class="list-player-name">${player.name}</span>
                    </div>`;
                
                gridContainer.appendChild(itemEl);
            });
            return; 
        }

        // ▼▼▼ PC用のレンダリング処理 (変更なし) ▼▼▼
        const listContainer = this.els.sidebar.list;
        listContainer.innerHTML = '';
        if (this.state.squad.length === 0) {
            listContainer.className = 'is-empty';
            listContainer.textContent = '上のフォームから選手を追加してください。';
            return;
        }
        listContainer.className = '';
        
        this.state.squad.sort((a, b) => a.number - b.number).forEach(player => {
            const isAssigned = assignedPlayerIds.has(player.id);
            const itemEl = document.createElement('div');
            itemEl.className = `player-list-item ${isAssigned ? 'is-assigned' : ''}`;
            itemEl.dataset.playerId = player.id;
            itemEl.innerHTML = `
                <span class="num">${player.number}</span>
                <div class="name">
                    <span>${player.name}</span>
                    <button class="edit-player-btn" title="編集">✏️</button>
                </div>`;
            
            itemEl.querySelector('.edit-player-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                this.openEditModal(player.id);
            });

            if (!isAssigned) {
                itemEl.draggable = true;
                itemEl.addEventListener('dragstart', (e) => this.handleDragStart(e, { type: 'list', playerId: player.id }));
            }

            itemEl.addEventListener('dblclick', () => {
                this.openEditModal(player.id);
            });

            listContainer.appendChild(itemEl);
        });
    },

renderSubstitutes() {
    if (this.isMobile) {
        const subsContainer = this.els.mobile.subsArea;
        subsContainer.innerHTML = '';

                // 「控え」ラベルを追加
        const label = document.createElement('div');
        label.textContent = '控え';
        label.style.cssText = `
            font-weight: bold; color: #868e96; font-size: 13px;
            display: flex; align-items: center; flex-shrink: 0;
            padding-right: 10px;
        `;
        subsContainer.appendChild(label);

        ['GK', 'DF', 'MF', 'FW'].forEach(pos => {
                const categoryEl = document.createElement('div');
                categoryEl.className = 'sub-category-mobile';
                categoryEl.innerHTML = `<span class="sub-category-mobile-label">${pos}</span>`;
                
                const playersWrapper = document.createElement('div');
                playersWrapper.className = 'sub-players-wrapper';
                
                const playersInPos = (this.state.substitutes[pos] || [])
                    .map(id => this.state.squad.find(p => p.id === id)).filter(Boolean);

                playersInPos.forEach(player => {
                    const role = (player.posCategory || 'fw').toLowerCase();
                    const chipEl = document.createElement('div');
                    chipEl.className = `sub-player-chip ${role}`;
                    chipEl.textContent = player.number;
                    chipEl.draggable = true;
                    chipEl.dataset.playerId = player.id;
                    chipEl.addEventListener('dragstart', (e) => this.handleDragStart(e, { type: 'substitute', playerId: player.id, category: pos }));
                    // passiveをfalseに変更
                    chipEl.addEventListener('touchstart', (e) => this.handleDragStart(e, { type: 'substitute', playerId: player.id, category: pos }), { passive: false });
                    playersWrapper.appendChild(chipEl);
                });
                categoryEl.appendChild(playersWrapper);
                subsContainer.appendChild(categoryEl);
            });
            return;
        }

        const zone = document.querySelector('.sub-drop-zone');
        zone.innerHTML = '';
        const allSubIds = Object.values(this.state.substitutes).flat();
        
        allSubIds.forEach(playerId => {
            const player = this.state.squad.find(p => p.id === playerId);
            if (!player) return;
            const subItem = document.createElement('div');
            subItem.className = 'substitute-item';
            subItem.dataset.playerId = playerId;
            subItem.draggable = true;
            subItem.addEventListener('dragstart', (e) => this.handleDragStart(e, { type: 'substitute', playerId, category: player.posCategory }));
            subItem.innerHTML = `
                <span class="num">${player.number}</span>
                <span class="name">${player.name}</span>
                <button class="unassign-btn-sub">&times;</button>`;
            subItem.querySelector('.unassign-btn-sub').addEventListener('click', (e) => {
                e.stopPropagation();
                this.unassignPlayer(playerId);
                this.renderAll();
            });
            zone.appendChild(subItem);
        });
    },

		handleDragStart(e, data, element = null) { // ← 引数を追加
		if (this.isMobile) {
			this.els.mobile.unassignBumper.classList.add('is-visible');
			if (data.type === 'list') {
				this.els.mobile.playerListPanel.classList.remove('is-open');
			}
		}

		this.isDraggingPlayer = true;
		this._lastDragStartType = data.type; 
		
		const player = this.state.squad.find(p => p.id === data.playerId);
		if (!player) return;

		
document.body.classList.add('is-dragging-player');

if (e.type === 'touchstart') {
    e.preventDefault();
    const draggedEl = element || e.currentTarget;

    // マーカー移動モードの処理は変更しません
    if (this.state.config.dragMode === 'position' && data.type === 'pitch') {
        const touch = e.touches[0];
        const simulatedMouseEvent = new MouseEvent('mousedown', { bubbles: true, cancelable: true, clientX: touch.clientX, clientY: touch.clientY });
        draggedEl.querySelector('.player-marker').dispatchEvent(simulatedMouseEvent);
        return;
    }

    // ▼▼▼ ここからが変更箇所です ▼▼▼
    // ドラッグ元の見た目に関わらず、統一されたデザインのゴースト要素を新しく生成します
    const role = (player.posCategory || 'fw').toLowerCase();
    const ghostEl = document.createElement('div');
    ghostEl.className = 'list-player-item is-drag-ghost-mobile'; // 選手リスト用のゴーストスタイルを適用
    ghostEl.innerHTML = `
        <div class="list-player-marker ${role}">
            <span class="list-player-number">${player.number}</span>
            <span class="list-player-name">${player.name}</span>
        </div>`;
    
    // ゴースト要素の基本的なスタイルを設定
    ghostEl.style.transition = 'none';
    ghostEl.style.position = 'absolute';
    ghostEl.style.zIndex = '2100';
    ghostEl.style.pointerEvents = 'none';
    document.body.appendChild(ghostEl);

    // ドラッグ元の要素を一時的に非表示または半透明にします
    if (data.type === 'pitch') {
        draggedEl.style.opacity = '0.4';
    } else {
        draggedEl.style.visibility = 'hidden';
    }

    // 指で触れている位置に、ゴーストのマーカーの中心が来るように座標を計算します
    const markerSize = 52; // CSSで指定されているゴーストのマーカーサイズ
    const offsetX = markerSize / 2;
    const offsetY = markerSize / 2;

    const updatePosition = (touchEvent) => {
        // ここにpreventDefaultを追加
        touchEvent.preventDefault();
        const currentTouch = touchEvent.touches[0];
        ghostEl.style.left = `${currentTouch.pageX - offsetX}px`;
        ghostEl.style.top = `${currentTouch.pageY - offsetY}px`;
    };
    updatePosition(e);

    // addEventListenerに passive: false を設定
    document.addEventListener('touchmove', updatePosition, { passive: false });
    document.addEventListener('touchend', (endEvent) => {
        document.removeEventListener('touchmove', updatePosition);
        ghostEl.style.display = 'none';
        const dropTarget = document.elementFromPoint(endEvent.changedTouches[0].clientX, endEvent.changedTouches[0].clientY);
        ghostEl.remove();
        
        const customDropEvent = new Event('drop', { bubbles: true });
        customDropEvent.dataTransfer = { getData: () => JSON.stringify(data) };
        dropTarget?.dispatchEvent(customDropEvent);
        this.renderAll();
        this.handleDragEnd();
    }, { once: true });

} else {
			const ghostEl = this.els.dragGhost;
            const numEl = ghostEl.querySelector('.num');
			numEl.textContent = player.number;
            const role = (player.posCategory || 'fw').toLowerCase();
            numEl.style.backgroundColor = `var(--marker-${role}-color)`;
            numEl.style.color = (role === 'gk') ? '#333' : 'white';

			ghostEl.querySelector('.name').textContent = player.name;
			e.dataTransfer.setData('application/json', JSON.stringify(data));
			e.dataTransfer.effectAllowed = 'move';
            // ゴースト要素の「マーカー部分」の中心をポインタに合わせる
			e.dataTransfer.setDragImage(ghostEl, ghostEl.offsetWidth / 2, ghostEl.offsetHeight - (numEl.offsetHeight / 2));
		}
		
		e.stopPropagation();
		
		if (this.els.sidebar.el.classList.contains('is-open')) {
			this.closeSidebar(true);
		}
	},

    // ▼▼▼ ここから書き換え ▼▼▼
handleDragEnd(e) {
    if (!this.isDraggingPlayer) return;
    this.isDraggingPlayer = false;
    document.body.classList.remove('is-dragging-player');

    if (this.isMobile) {
        this.els.mobile.unassignBumper.classList.remove('is-visible', 'is-droppable');

        if (this._lastDragStartType === 'list') {
            this.els.mobile.playerListPanel.classList.remove('is-open');
        }
    }
    this._lastDragStartType = null;
},
// ▲▲▲ ここまで書き換え ▲▲▲

    handleDragOver(e) { e.preventDefault(); e.currentTarget.classList.add('drop-target-hover'); },
    handleDragLeave(e) { e.currentTarget.classList.remove('drop-target-hover'); },

    handleDropOnPitch(e, targetPosId) {
        if (!this.isDraggingPlayer) return;
        e.preventDefault(); e.stopPropagation();
        e.currentTarget.classList.remove('drop-target-hover');
        const data = JSON.parse(e.dataTransfer.getData('application/json'));
        const draggedPlayerId = data.playerId;
        const playerOnTarget = this.state.starters[targetPosId]?.playerId;
        
        if (draggedPlayerId === playerOnTarget) return;

        this.unassignPlayer(draggedPlayerId);
        
        if (playerOnTarget) {
            this.unassignPlayer(playerOnTarget);
            if (data.type === 'pitch') {
                this.state.starters[data.posId] = { playerId: playerOnTarget, coords: this.state.starters[data.posId]?.coords || null };
            } else {
                const posName = targetPosId.split('_')[0];
                const role = this.getRole(posName).toUpperCase();
                this.state.substitutes[role].push(playerOnTarget);
            }
        }
        
        this.state.starters[targetPosId] = { playerId: draggedPlayerId, coords: this.state.starters[targetPosId]?.coords || null };
        this.renderAll();
    },

        handleDropOnSubZone(e, mobilePosCategory = null) {
        e.preventDefault(); e.stopPropagation();
        e.currentTarget.classList.remove('drop-target-hover');

        try {
            const data = JSON.parse(e.dataTransfer.getData('application/json'));
            const player = this.state.squad.find(p => p.id === data.playerId);

            if (player) {
                this.unassignPlayer(data.playerId);
                const targetCategory = player.posCategory || 'FW'; // ← この行を修正
                
                if (!this.state.substitutes[targetCategory]) {
                    this.state.substitutes[targetCategory] = [];
                }
                this.state.substitutes[targetCategory].push(data.playerId);
                this.renderAll();
            }
        } catch (err) {
            console.error("Drop failed:", err);
        }
    },

    unassignPlayer(playerId) {
        for (const posId in this.state.starters) {
            if (this.state.starters[posId]?.playerId === playerId) {
                delete this.state.starters[posId];
                return;
            }
        }
        for (const category in this.state.substitutes) {
            this.state.substitutes[category] = (this.state.substitutes[category] || []).filter(id => id !== playerId);
        }
    },

    addPlayer() {
        const number = this.els.sidebar.numberInput.value;
        const name = this.els.sidebar.nameInput.value.trim();
        const posCategory = this.els.sidebar.posSelect.value;
        if (!number || !name) { alert('背番号と選手名を入力してください。'); return; }
        if (this.state.squad.some(p => p.number === parseInt(number))) { alert('この背番号は既に使用されています。'); return; }
        this.state.squad.push({ id: `p_${Date.now()}`, number: parseInt(number), name, posCategory });
        this.els.sidebar.numberInput.value = '';
        this.els.sidebar.nameInput.value = '';
        this.els.sidebar.numberInput.focus();
        this.renderAll();
    },

    resetAllAssignments() {
        if (confirm('すべての選手の配置をリセットしますか？')) {
            this.state.starters = {};
            this.state.substitutes = { GK: [], DF: [], MF: [], FW: [] };
            this.renderAll();
        }
    },
    
    openModal(modalEl) { modalEl.style.display = 'flex'; },
    closeAllModals() {
        this.els.allModals.forEach(modal => modal.style.display = 'none');
        clearInterval(this.numberChangeInterval);
    },

    buildFormationModal() {
        this.els.formationModal.grid.innerHTML = '';
        for (const key in this.formations) {
            const formation = this.formations[key];
            const card = document.createElement('div');
            card.className = 'formation-card';
            card.dataset.formation = key;
            card.innerHTML = `<div class="formation-name">${formation.name}</div><div class="formation-note">${formation.note || '&nbsp;'}</div>`;
            if (key === this.state.config.formation) card.classList.add('selected');
            card.addEventListener('click', () => {
                this.changeFormation(key);
                this.closeAllModals();
            });
            this.els.formationModal.grid.appendChild(card);
        }
    },

    changeFormation(newFormationKey) {
        const oldStarters = { ...this.state.starters };
        this.state.starters = {};

        const newPositions = this.formations[newFormationKey].spec.map((spec, index) => {
            const posId = `${spec.pos}_${spec.isDuplicate ? index : 1}`;
            const coords = this.formationCoords[newFormationKey][index];
            const characteristics = this.getPositionCharacteristics(spec.pos, coords);
            return { posId, pos: spec.pos, characteristics, isAssigned: false };
        });

        Object.values(oldStarters).forEach(starterData => {
            const player = this.state.squad.find(p => p.id === starterData.playerId);
            if (!player) return;

            let bestMatch = null;
            let bestScore = -Infinity;

            const oldPosId = Object.keys(oldStarters).find(key => oldStarters[key].playerId === starterData.playerId);
            const oldPosName = oldPosId ? oldPosId.split('_')[0] : '';
            const oldFormationKey = this.state.config.formation;
            const oldPosIndex = this.formations[oldFormationKey].spec.findIndex((spec, i) => `${spec.pos}_${spec.isDuplicate ? i : 1}` === oldPosId);
            const oldCoords = (oldPosIndex !== -1) ? this.formationCoords[oldFormationKey][oldPosIndex] : { top: 50, left: 50 };
            const oldCharacteristics = this.getPositionCharacteristics(oldPosName, oldCoords);

            newPositions.forEach(newPos => {
                if (newPos.isAssigned) return;
                const score = this.calculatePositionSimilarity(oldCharacteristics, newPos.characteristics);
                if (score > bestScore) {
                    bestScore = score;
                    bestMatch = newPos;
                }
            });

            if (bestMatch) {
                this.state.starters[bestMatch.posId] = { playerId: starterData.playerId, coords: null };
                bestMatch.isAssigned = true;
            } else {
                const role = this.getRole(oldPosName).toUpperCase();
                if (!this.state.substitutes[role]) this.state.substitutes[role] = [];
                this.state.substitutes[role].push(starterData.playerId);
            }
        });
        
        this.state.config.formation = newFormationKey;
        this.renderAll();
    },

    getPositionCharacteristics(posName, coords) {
        let role = 'GENERIC';
        if (posName === 'GK') role = 'GK';
        else if (posName.includes('CB')) role = 'CB';
        else if (posName.includes('SB')) role = 'SB';
        else if (posName.includes('WB')) role = 'WB';
        else if (posName.includes('DMF') || posName.includes('CMF')) role = 'CM';
        else if (posName.includes('AMF')) role = 'AM';
        else if (posName.includes('WG') || posName.includes('MF')) role = 'WM';
        else if (posName.includes('FW') || posName.includes('CF')) role = 'FW';
        
        let side = 'Center';
        if (posName.startsWith('R') || coords.top > 60) side = 'Right';
        if (posName.startsWith('L') || coords.top < 40) side = 'Left';
        
        let vertical = 'Mid';
        if (coords.left < 35) vertical = 'Def';
        if (coords.left > 75) vertical = 'Fwd';
        
        return { role, side, vertical, x: coords.top, y: coords.left };
    },

    calculatePositionSimilarity(char1, char2) {
        let score = 0;
        if (char1.role === char2.role) {
            score += 100;
        } else {
            const similarRoles = { 'SB': ['WB'], 'WB': ['SB', 'WM'], 'CM': ['AM'], 'AM': ['CM', 'FW'], 'WM': ['FW', 'WB'] };
            if (similarRoles[char1.role]?.includes(char2.role)) score += 50;
        }
        if (char1.side === char2.side) score += 20;
        if (char1.vertical === char2.vertical) score += 10;
        
        const distance = Math.sqrt(Math.pow(char1.x - char2.x, 2) + Math.pow(char1.y - char2.y, 2));
        score -= distance;
        return score;
    },

            openEditModal(playerId) {
        const player = this.state.squad.find(p => p.id === playerId);
        if (!player) return;
        this.editingPlayerId = playerId;

        // PC表示の場合、モーダルを開く際にサイドバーをピン留め状態にする
        if (!this.isMobile && !this.els.sidebar.el.classList.contains('is-pinned')) {
            this.toggleSidebarPin(); // ピン留め状態をトグル（ONにする）
        }
        
        this.els.editModal.numberInput.value = player.number;
        this.els.editModal.nameInput.value = player.name;
        this.els.editModal.posSelect.value = player.posCategory || 'FW';
        this.openModal(this.els.editModal.overlay);
    },

    savePlayerChanges() {
        const newNumber = parseInt(this.els.editModal.numberInput.value, 10);
        const newName = this.els.editModal.nameInput.value.trim();
        const newPosCategory = this.els.editModal.posSelect.value;

        if (!newNumber || !newName) {
            alert('背番号と選手名を入力してください。');
            return;
        }

        if (this.editingPlayerId) {
            const player = this.state.squad.find(p => p.id === this.editingPlayerId);
            if (player) {
                if (this.state.squad.some(p => p.number === newNumber && p.id !== player.id)) {
                    alert('その背番号は既に使用されています。'); return;
                }
                player.number = newNumber;
                player.name = newName;
                player.posCategory = newPosCategory;
            }
        } else {
            if (this.state.squad.some(p => p.number === newNumber)) {
                alert('この背番号は既に使用されています。'); return;
            }
            this.state.squad.push({ id: `p_${Date.now()}`, number: newNumber, name: newName, posCategory: newPosCategory });
        }

        this.renderAll();
        this.closeAllModals();
    },

    deletePlayerFromModal() {
        if (this.editingPlayerId && confirm('この選手をリストから完全に削除しますか？\nこの操作は元に戻せません。')) {
            this.unassignPlayer(this.editingPlayerId);
            this.state.squad = this.state.squad.filter(p => p.id !== this.editingPlayerId);
            this.closeAllModals();
            this.renderAll();
        }
    },
    
    changeNumber(amount) {
        let currentNum = parseInt(this.els.editModal.numberInput.value, 10) || 0;
        let newNum = currentNum + amount;
        if (newNum < 1) newNum = 1;
        this.els.editModal.numberInput.value = newNum;
    },

    toggleDragMode() {
        this.state.config.dragMode = this.state.config.dragMode === 'position' ? 'swap' : 'position';
        this.showModeToast();
        this.renderAll();
    },

    showModeToast() {
        clearTimeout(this.toastTimer);
        this.els.modeToast.textContent = this.state.config.dragMode === 'swap' ? '選手交代モード' : 'マーカー移動モード';
        this.els.modeToast.classList.add('show');
        this.toastTimer = setTimeout(() => { this.els.modeToast.classList.remove('show'); }, 1500);
    },
    
    async saveImage() {
        // --- 処理本体（画像生成と共有/保存） ---
        const processImage = async (action) => {
            // 描画用のクローン要素を準備
            const originalArea = document.getElementById('capture-area');
            const cloneArea = originalArea.cloneNode(true);
            cloneArea.style.position = 'absolute';
            cloneArea.style.left = '-9999px';
            cloneArea.style.top = '0px';
            cloneArea.style.width = '800px';
            document.body.appendChild(cloneArea);

            // 控え選手リストを描画
            let subsHTML = '';
            ['GK', 'DF', 'MF', 'FW'].forEach(pos => {
                const playersInPos = (this.state.substitutes[pos] || []).map(id => this.state.squad.find(p => p.id === id)).filter(Boolean);
                if (playersInPos.length > 0) {
                    const names = playersInPos.map(p => `${p.number} ${p.name}`).join(' / ');
                    subsHTML += `<div class="subs-pos-group"><span class="pos-label">${pos}:</span><span class="names">${names}</span></div>`;
                }
            });
            const captureSubs = cloneArea.querySelector('#capture-subs');
            if (captureSubs) {
                captureSubs.innerHTML = subsHTML ? `<h4>SUBSTITUTES</h4><div class="subs-grid">${subsHTML}</div>` : '';
            }

            // タイトルとウォーターマークを描画
            const titleInput = this.isMobile ? this.els.mobile.titleInput : this.els.titleInput;
            const title = titleInput.value.trim();
            const captureTitle = cloneArea.querySelector('#capture-title');
            if (captureTitle) {
                captureTitle.textContent = title || "XISync Tactical Canvas";
                captureTitle.style.display = 'block';
            }
            const watermark = cloneArea.querySelector('#capture-watermark');
            if (watermark) watermark.textContent = "Created with XISync";
            cloneArea.classList.add('is-capturing');

            try {
                const canvas = await html2canvas(cloneArea, { backgroundColor: '#4a8d4d', scale: 3 });
                
                if (action === 'share') {
                    // --- アプリで共有 ---
                    canvas.toBlob(async (blob) => {
                        const file = new File([blob], "tactical-board.png", { type: 'image/png' });
                        try {
                            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                                await navigator.share({ files: [file] });
                            } else {
                                throw new Error('Cannot share files.');
                            }
                        } catch (err) {
                            if (err.name !== 'AbortError') {
                                console.error('Share failed:', err);
                                alert('共有機能が利用できませんでした。');
                                this.downloadImage(canvas, generateFilename(title)); // フォールバックとしてダウンロード
                            }
                        }
                    }, 'image/png');

                } else if (action === 'save') {
                    // --- 端末に保存 ---
                    this.downloadImage(canvas, generateFilename(title));
                }

            } catch (err) {
                console.error('Image generation failed:', err);
                alert('画像の生成に失敗しました。');
            } finally {
                document.body.removeChild(cloneArea);
            }
        };

        // --- ファイル名生成ヘルパー ---
        const generateFilename = (baseTitle) => {
            const now = new Date();
            const timestamp = `${now.getFullYear()}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}_${now.getHours().toString().padStart(2, '0')}${now.getMinutes().toString().padStart(2, '0')}${now.getSeconds().toString().padStart(2, '0')}`;
            const safeTitle = (baseTitle || 'tactical-canvas').replace(/[\\/:"*?<>|]/g, '').replace(/\s+/g, '_');
            return `${safeTitle}_${timestamp}.png`;
        };

        // --- OSごとの処理分岐 ---
        if (this.isIOS()) {
            // 【iOSの場合】即座に共有処理を実行
            await processImage('share');
        } else {
            // 【Android/PCの場合】アクションシートを表示
            const sheet = this.els.shareActionSheet;
            sheet.overlay.style.display = 'flex';
            setTimeout(() => sheet.overlay.classList.add('is-open'), 10);

            const closeSheet = () => {
                sheet.overlay.classList.remove('is-open');
                setTimeout(() => sheet.overlay.style.display = 'none', 300);
            };

            const shareHandler = async () => { closeSheet(); await processImage('share'); };
            const saveHandler = async () => { closeSheet(); await processImage('save'); };
            
            sheet.shareBtn.onclick = shareHandler;
            sheet.saveBtn.onclick = saveHandler;
            sheet.cancelBtn.onclick = closeSheet;
            sheet.overlay.onclick = (e) => {
                if (e.target === sheet.overlay) closeSheet();
            };
        }
        
    },

    downloadImage(canvas, fileName) {
        const link = document.createElement('a');
        link.download = fileName;
        link.href = canvas.toDataURL('image/png');
        link.click();
    },
    
    checkUrlForSquadData() {
        const dataParam = new URLSearchParams(window.location.search).get('data');
        if (dataParam) {
            try {
                const decompressed = LZString.decompressFromEncodedURIComponent(dataParam);
                const squadData = JSON.parse(decompressed);
                if (this.isValidSquad(squadData)) {
                    this.showImportConfirmation(squadData);
                }
            } catch (error) {
                console.error('URL Data Error:', error);
                history.replaceState(null, '', window.location.pathname);
            }
        }
    },
    
    isValidSquad(squad) {
        return Array.isArray(squad) && squad.every(p => p.id && typeof p.number !== 'undefined' && p.name);
    },
    
    showImportConfirmation(squadData) {
        this._importedSquadData = squadData;
        this.els.importConfirmModal.previewList.innerHTML = '<ul style="list-style: none; padding: 0;">' + squadData
            .sort((a,b) => a.number - b.number)
            .map(p => `<li><strong>No.${p.number}</strong> ${p.name}</li>`).join('') + '</ul>';
        this.openModal(this.els.importConfirmModal.overlay);
    },

    confirmImport() {
        if (!this._importedSquadData) return;
        this.state.squad = this._importedSquadData;
        this.state.starters = {};
        this.state.substitutes = { GK: [], DF: [], MF: [], FW: [] };
        this.renderAll();
        this.closeAllModals();
        history.replaceState(null, '', window.location.pathname);
        alert(`${this.state.squad.length}人の選手をインポートしました。`);
        this._importedSquadData = null;
    },

    processImport(data) {
        if (this.isValidSquad(data)) {
            // posCategoryがない古いデータ形式に対応
            data.forEach(player => {
                if (!player.posCategory) {
                    player.posCategory = 'FW';
                }
            });
            this.showImportConfirmation(data);
        } else {
            alert('無効なデータ形式です。');
        }
    },

    copySquadUrlToClipboard() {
        if (this.state.squad.length === 0) { alert("共有する選手がいません。"); return; }
        try {
            const squadJSON = JSON.stringify(this.state.squad);
            const compressed = LZString.compressToEncodedURIComponent(squadJSON);
            const baseUrl = window.location.href.split('?')[0].split('#')[0];
            const shareUrl = `${baseUrl}?data=${compressed}`;
            navigator.clipboard.writeText(shareUrl).then(() => {
                alert("共有用URLをクリップボードにコピーしました！");
                this.closeAllModals();
            }).catch(err => alert("URLのコピーに失敗しました。"));
        } catch(e) {
            alert("URLの生成に失敗しました。");
        }
    },

    copySquadToClipboard() {
        if (this.state.squad.length === 0) { alert("コピーする選手がいません。"); return; }
        navigator.clipboard.writeText(JSON.stringify(this.state.squad)).then(() => {
            alert('クリップボードにコピーしました！');
            this.closeAllModals();
        }).catch(() => alert('コピーに失敗しました。'));
    },
    
    exportSquadToFile() {
        if (this.state.squad.length === 0) { alert("エクスポートする選手がいません。"); return; }
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.state.squad));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "xisync_squad.json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
        this.closeAllModals();
    },

    importFromFile(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                this.processImport(JSON.parse(event.target.result));
            } catch (error) {
                alert('ファイルの読み込みに失敗しました。');
            }
        };
        reader.readAsText(file);
        e.target.value = ''; // Reset file input
    },

    async importFromClipboard() {
        try {
            const text = await navigator.clipboard.readText();
            if (text) {
                try {
                    this.processImport(JSON.parse(text));
                } catch (e) { alert('クリップボードのデータ形式が無効です。'); }
            } else { alert('クリップボードが空です。'); }
        } catch (err) {
            alert('クリップボードの読み込みに失敗しました。');
        }
    },
    setupSidebarControls() {
        const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        
        // 既存のボタンのイベント
        this.els.allOpenSidebarBtns.forEach(btn => btn.addEventListener('click', () => this.openSidebar(true)));
        
        if (isTouchDevice) {
            this.setupTouchSidebar();
        } else {
            this.setupMouseSidebar();
        }
    },

    setupMouseSidebar() {
        const sidebar = this.els.sidebar.el;
        const handle = this.els.sidebarHandle;

        handle.addEventListener('mouseenter', () => {
            this.sidebarHoverTimer = setTimeout(() => {
                this.openSidebar();
            }, 200);
        });

        handle.addEventListener('mouseleave', () => clearTimeout(this.sidebarHoverTimer));

        sidebar.addEventListener('mouseleave', () => {
            const activeEl = document.activeElement;
            const isTypingInSidebar = 
                activeEl === this.els.sidebar.numberInput ||
                activeEl === this.els.sidebar.nameInput ||
                activeEl === this.els.sidebar.posSelect;

            if (isTypingInSidebar) {
                return;
            }

            clearTimeout(this.sidebarHoverTimer);
            this.closeSidebar();
        });

                this.els.pinSidebarBtn.addEventListener('click', () => this.toggleSidebarPin());

        // [追加] サイドバーの外側をクリックしたら、ピン留めを解除して閉じる
        document.addEventListener('click', (e) => {
            const isClickInsideModal = e.target.closest('.modal-overlay');

            if (sidebar.classList.contains('is-open') && !sidebar.contains(e.target) && !e.target.closest('.sidebar-handle') && !e.target.closest('#open-sidebar-btn') && !isClickInsideModal) {
                // 強制的に閉じる(true)ことで、ピン留めも解除する
                this.closeSidebar(true); 
            }
        });
    },
    setupTouchSidebar() {
        const sidebar = this.els.sidebar.el;
        const handle = this.els.sidebarHandle;
        let startX = 0, currentX = 0, isDragging = false;

        const dragStart = (e) => {
            isDragging = true;
            startX = e.touches[0].clientX;
            sidebar.classList.add('no-transition');
            document.body.style.overflowX = 'hidden';
        };

        const dragMove = (e) => {
            if (!isDragging) return;
            currentX = e.touches[0].clientX;
            const diff = Math.min(300, Math.max(0, currentX - startX));
            sidebar.style.transform = `translateX(${-300 + diff}px)`;
        };

        const dragEnd = () => {
            if (!isDragging) return;
            isDragging = false;
            sidebar.classList.remove('no-transition');
            sidebar.style.transform = '';
            document.body.style.overflowX = '';

            const threshold = 100;
            if (currentX - startX > threshold) {
                this.openSidebar();
            } else {
                this.closeSidebar();
            }
        };

        handle.addEventListener('touchstart', dragStart, { passive: true });
        document.addEventListener('touchmove', dragMove, { passive: true });
        document.addEventListener('touchend', dragEnd);

                document.addEventListener('click', (e) => {
            // クリックされた場所がモーダルウィンドウの中かどうかを判定
            const isClickInsideModal = e.target.closest('.modal-overlay');

            // サイドバーが開いていて、かつクリック位置がサイドバー/ハンドル/ボタン/モーダルの「外側」の場合のみ閉じる
            if (sidebar.classList.contains('is-open') && !sidebar.contains(e.target) && !e.target.closest('.sidebar-handle') && !e.target.closest('#open-sidebar-btn') && !isClickInsideModal) {
                this.closeSidebar(true);
            }
        });
    },

    openSidebar(isPinned = false) {
        if (isPinned) this.els.sidebar.el.classList.add('is-pinned');
        this.els.sidebar.el.classList.add('is-open');
        this.els.body.classList.add('sidebar-is-open');
    },

    closeSidebar(force = false) {
        if (this.els.sidebar.el.classList.contains('is-pinned') && !force) return;
        
        if (force) {
           this.els.sidebar.el.classList.remove('is-pinned');
        }
        this.els.sidebar.el.classList.remove('is-open');
        this.els.body.classList.remove('sidebar-is-open');
    },

    toggleSidebarPin() {
        const sidebar = this.els.sidebar.el;
        sidebar.classList.toggle('is-pinned');
        if (sidebar.classList.contains('is-pinned')) {
            this.openSidebar();
        }
    }
};

// --- PWA Service Worker Registration & Update Handling ---
if ('serviceWorker' in navigator) {
    let newWorker;

    navigator.serviceWorker.register('./sw.js').then(reg => {
        reg.addEventListener('updatefound', () => {
            newWorker = reg.installing;
            newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                    const notification = document.getElementById('update-notification');
                    if (notification) notification.style.display = 'flex';
                }
            });
        });
    });

    const updateBtn = document.getElementById('update-btn');
    if (updateBtn) {
        updateBtn.addEventListener('click', () => {
            if (newWorker) {
                newWorker.postMessage({ action: 'skipWaiting' });
            }
        });
    }

    let refreshing;
    navigator.serviceWorker.addEventListener('controllerchange', () => {
        if (refreshing) return;
        window.location.reload();
        refreshing = true;
    });
}
    
App.init(); // Run the app

});

</script>
</body>
</html>