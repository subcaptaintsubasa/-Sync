<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>XISync</title>
    
    <!-- PWA Manifest (Inline) -->
    <link rel="manifest" href="manifest.json">

    <meta name="theme-color" content="#007bff">
    <link rel="icon" type="image/png" href="./icon.png">
    <link rel="apple-touch-icon" href="./icon.png">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <style>
        :root {
            --pitch-bg: #539d56; --line-color: rgba(255, 255, 255, 0.6); --sidebar-bg: #f4f4f4;
            --text-color: #333; --primary-color: #007bff; --secondary-color: #6c757d; --danger-color: #dc3545;
            --marker-gk-color: #f39c12; --marker-df-color: #3498db;
            --marker-mf-color: #2ecc71; --marker-fw-color: #e74c3c;
        }

        body {
            font-family: 'Helvetica Neue', 'Arial', 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', 'Meiryo', sans-serif;
            margin: 0; background-color: #e9e9e9; color: var(--text-color);
            padding: 20px; box-sizing: border-box; min-height: 100vh; overflow-x: hidden;
            touch-action: manipulation; /* Prevent double-tap zoom */
        }

        .container { display: flex; flex-wrap: wrap; gap: 20px; width: 100%; max-width: 1600px; margin: 0 auto; }
        .left-panel, .right-panel { width: 350px; flex-shrink: 0; background-color: var(--sidebar-bg); padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: flex; flex-direction: column; gap: 25px; }
        .main-content { flex-grow: 1; min-width: 400px; }

        .app-branding { text-align: center; padding-bottom: 20px; border-bottom: 1px solid #ddd; margin-bottom: 15px; }
        .app-branding h2 { margin: 0; font-size: 2em; color: var(--primary-color); letter-spacing: 1px;}
        .app-branding p { margin: 2px 0 0 0; font-size: 0.9em; color: #666; }

        [data-layout-mode="horizontal"] .left-panel { display: none; }
        [data-layout-mode="vertical"] .right-panel #player-management-section { display: none; }
        [data-layout-mode="vertical"] .container { align-items: flex-start; }

        @media (max-width: 1200px) {
            .container { flex-direction: column; align-items: center; }
            .left-panel, .right-panel, .main-content { width: 100%; max-width: 600px; }
            [data-layout-mode="vertical"] .left-panel { display: none; }
            [data-layout-mode="vertical"] .right-panel #player-management-section { display: flex; }
        }

        .control-group { display: flex; flex-direction: column; gap: 8px; }
        .control-group label { font-weight: bold; }
        #title-input { width: 100%; padding: 12px; font-size: 1.6em; font-weight: bold; border: 2px solid transparent; border-radius: 8px; box-sizing: border-box; margin-bottom: 15px; transition: border-color 0.3s; }
        #title-input:focus { outline: none; border-color: var(--primary-color); }
        
        #capture-area { position: relative; background-color: #4a8d4d; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .pitch-wrapper { position: relative; }
        .capture-title { color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.8); font-size: 30px; width: 100%; text-align:center; padding-bottom: 20px; box-sizing: border-box; display: none; }
        
        .pitch {
            position: relative; width: 100%; background-color: var(--pitch-bg);
            background-image: repeating-linear-gradient(90deg, transparent, transparent 4.8%, rgba(0,0,0,0.05) 5%, transparent 5.2%);
            border: 3px solid var(--line-color); border-radius: 10px; box-sizing: border-box; overflow: hidden;
        }
        .pitch-wrapper.vertical .pitch { padding-top: 125%; background-image: repeating-linear-gradient(0deg, transparent, transparent 4.8%, rgba(0,0,0,0.05) 5%, transparent 5.2%); } 
        .pitch-wrapper.horizontal .pitch { padding-top: 70%; }
        
        .pitch-line { position: absolute; box-sizing: border-box; border-color: var(--line-color); border-style: solid; }
        .vertical .center-line   { width: 100%; height: 3px; background-color: var(--line-color); top: 0; left: 0; }
        .vertical .center-circle { width: 40%; padding-top: 20%; border-width: 3px; border-radius: 0 0 50% 50%; border-top-style: none; top: -3px; left: 50%; transform: translateX(-50%); }
        .vertical .goal-area { width: 30%; height: 7%; border-width: 3px; border-bottom-style: none; bottom: 0; left: 50%; transform: translateX(-50%); }
        .vertical .penalty-area { width: 60%; height: 18%; border-width: 3px; border-bottom-style: none; bottom: 0; left: 50%; transform: translateX(-50%); }
        .vertical .penalty-arc { width: 20%; height: 8%; border-width: 3px; border-radius: 50% 50% 0 0; border-bottom-style: none; bottom: 18%; left: 50%; transform: translateX(-50%); }
        .vertical .goal { width: 20%; height: 4%; background: rgba(255,255,255,0.1); border-width: 3px; border-bottom-style: none; bottom: 0; left: 50%; transform: translateX(-50%); border-radius: 10px 10px 0 0; }
        
        .horizontal .center-line { width: 3px; height: 100%; background-color: var(--line-color); top: 0; right: 0; }
        .horizontal .center-circle { height: 52%; width: 18.2%; border: 3px solid var(--line-color); border-radius: 50% 0 0 50%; border-right-style: none; right: -3px; top: 50%; transform: translateY(-50%); }
        .horizontal .goal-area { width: 7%; height: 30%; border-width: 3px; border-left-style: none; top: 35%; left: 0; }
        .horizontal .penalty-area { width: 18%; height: 50%; border-width: 3px; border-left-style: none; top: 25%; left: 0; }
        .horizontal .penalty-arc { width: 8%; height: 20%; border-width: 3px; border-radius: 0 50% 50% 0; border-left-style: none; top: 40%; left: 18%; }
        .horizontal .goal { width: 4%; height: 20%; background: rgba(255,255,255,0.1); border-width: 3px; border-right-style: none; top: 40%; left: 0; border-radius: 0 10px 10px 0; }

        .capture-subs { padding-top: 20px; color: white; font-size: 15px; }
        .capture-subs h4 { margin: 0 0 12px 0; text-align: center; font-size: 1.2em; letter-spacing: 1px; }
        .subs-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .subs-pos-group { display: flex; align-items: baseline; gap: 10px; }
        .subs-pos-group .pos-label { font-weight: bold; flex-shrink: 0; width: 35px; }
        .subs-pos-group .names { word-break: keep-all; }

        .capture-watermark { display: none; }
        .is-capturing .capture-watermark { display: block; position: absolute; bottom: 10px; right: 15px; font-size: 14px; color: rgba(255, 255, 255, 0.7); text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }

        .player-container { position: absolute; display: flex; flex-direction: column; align-items: center; user-select: none; transform: translate(-50%, -50%); transition: top 0.3s ease, left 0.3s ease, transform 0.2s, box-shadow 0.2s; will-change: top, left, transform; border-radius: 50%; }
        .player-container.is-moving { cursor: move; z-index: 100; transform: translate(-50%, -50%) scale(1.15); transition: transform 0.2s, box-shadow 0.2s; } /* No position transition while moving */
        .player-container.drop-target-hover { transform: translate(-50%, -50%) scale(1.15); }
        .player-marker { width: 52px; height: 52px; border-radius: 50%; box-shadow: 0 3px 6px rgba(0,0,0,0.3); display: flex; flex-direction: column; justify-content: center; align-items: center; color: #333; font-weight: bold; border: 2px solid rgba(0,0,0,0.2); box-sizing: border-box; touch-action: none; /* For smoother drag on touch */ }
        [data-drag-mode="position"] .player-marker { cursor: grab; }
        [data-drag-mode="swap"] .player-marker { cursor: pointer; }
        .player-marker.gk { background-color: var(--marker-gk-color); } .player-marker.df { background-color: var(--marker-df-color); color: white; }
        .player-marker.mf { background-color: var(--marker-mf-color); color: white; } .player-marker.fw { background-color: var(--marker-fw-color); color: white; }
        .player-number { font-size: 22px; line-height: 1; pointer-events: none; } .player-pos { font-size: 11px; line-height: 1; opacity: 0.8; margin-top: 2px; pointer-events: none; }
        .player-name { background-color: rgba(0, 0, 0, 0.7); color: white; font-size: 14px; font-weight: bold; padding: 5px 8px; border-radius: 12px; margin-top: 6px; text-align: center; max-width: 120px; white-space: normal; word-break: break-all; line-height: 1.2; box-shadow: 0 1px 4px rgba(0,0,0,0.25); cursor: default; }
        .unassign-btn { position: absolute; top: -10px; right: -10px; width: 24px; height: 24px; background-color: rgba(255, 255, 255, 0.9); color: #555; border-radius: 50%; border: 1px solid #ccc; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 16px; font-weight: bold; line-height: 1; box-shadow: 0 1px 3px rgba(0,0,0,0.2); transition: all 0.2s; z-index: 11; padding: 0; }
        .unassign-btn:hover { background-color: #e74c3c; color: white; transform: scale(1.1); }
        .is-capturing .unassign-btn, .is-capturing .unassign-btn-sub { display: none; }
        
        button { width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: background-color 0.3s, transform 0.1s; }
        button:active { transform: scale(0.98); }
        .unassign-btn-sub:active,
        .edit-player-btn:active {
            transform: translateY(-50%) scale(1);
        }
        .btn-primary { background-color: var(--primary-color); color: white; } .btn-secondary { background-color: var(--secondary-color); color: white; } .btn-danger { background-color: var(--danger-color); color: white; }
        .orientation-toggle { display: flex; gap: 10px; }
        .orientation-toggle input { display: none; }
        .orientation-toggle label { flex: 1; text-align: center; padding: 8px; border-radius: 6px; border: 1px solid #ccc; cursor: pointer; background-color: #fff; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 14px; }
        .orientation-toggle input:checked + label { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        
        #player-list-controls { border: 1px solid #ddd; border-radius: 8px; padding: 15px; background-color: #fff; }
        
        .player-list-item { display: flex; align-items: center; padding: 8px 10px; border-bottom: 1px solid #eee; user-select: none; }
        .player-list-item:not(.is-assigned) { cursor: grab; }
        .player-list-item.is-assigned { background-color: #f0f0f0; color: #999; }
        .player-list-item .num, .player-list-item .name { padding: 4px; } .player-list-item .num { font-weight: bold; width: 30px; text-align: right; margin-right: 5px;}
        .player-list-item .name { flex-grow: 1; position: relative;}
        .player-list-item.is-assigned .num, .player-list-item.is-assigned .name { color: #888; } /* Assigned players are greyed out */
        .edit-player-btn { background: none; border: none; cursor: pointer; width: 30px; height: 30px; position: absolute; right: 5px; top: 50%; transform: translateY(-50%); color: #888; opacity: 0; transition: opacity 0.2s, background-color 0.2s; display: flex; align-items: center; justify-content: center; border-radius: 50%; padding: 0; }
        .edit-player-btn:hover { background-color: #f0f0f0; }
        .player-list-item:hover .edit-player-btn { opacity: 1; }
        .edit-player-btn:hover { color: var(--primary-color); }
        
        .drag-ghost { position: absolute; left: -1000px; background-color: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 2100; border-radius: 15px; padding: 5px 10px; font-size: 14px; display: inline-flex; align-items: center; }
        .drag-ghost .num { font-weight: bold; margin-right: 8px; }

        #substitutes-container { display: flex; flex-direction: column; gap: 10px; }
        .sub-category { display: flex; align-items: flex-start; gap: 8px; }
        .sub-category-label { font-weight: bold; width: 35px; padding-top: 10px; flex-shrink: 0; }
        .sub-drop-zone { flex-grow: 1; min-height: 40px; border: 2px dashed #ccc; border-radius: 8px; padding: 5px; background-color: #fff; transition: background-color 0.2s, border-color 0.2s; display: flex; flex-wrap: wrap; align-content: flex-start; gap: 8px; }
        .sub-drop-zone.drop-target-hover { background-color: #e9f5ff; border-color: var(--primary-color); }
        .substitute-item { position: relative; display: inline-flex; align-items: center; background-color: #e9ecef; border-radius: 15px; padding: 5px 25px 5px 10px; font-size: 14px; user-select: none; cursor: grab; }
        .substitute-item .num { font-weight: bold; margin-right: 8px; }
        .unassign-btn-sub { position: absolute; top: 50%; right: 4px; transform: translateY(-50%); width: 22px; height: 22px; background-color: #ccc; color: white; border-radius: 50%; border: none; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 16px; line-height: 1; padding: 0; transition: background-color 0.2s; }
        .unassign-btn-sub:hover { background-color: #e74c3c; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); width: 90%; max-width: 420px; position: relative; }
        .modal-close-btn { position: absolute; top: 10px; right: 15px; font-size: 28px; color: #999; background: none; border: none; cursor: pointer; width: auto; padding: 0; }
        .modal-content h3 { margin-top: 0; margin-bottom: 25px; text-align: center; }
        
        #edit-player-modal .form-group { margin-bottom: 20px; }
        #edit-player-modal .form-group label { display: block; margin-bottom: 8px; font-weight: bold; }
        #edit-player-modal input[type="text"] { width: 100%; padding: 12px; font-size: 16px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; }

        .number-input-wrapper { display: flex; align-items: center; gap: 5px; }
        .number-input-btn { width: 48px !important; height: 48px; font-size: 24px !important; padding: 0 !important; background-color: #f0f0f0; color: #333; flex-shrink: 0; user-select: none; }
        .number-input-btn:hover { background-color: #e0e0e0; }
        #edit-player-number { width: 100%; height: 48px; font-size: 22px; text-align: center; border: 1px solid #ccc; border-radius: 8px; -moz-appearance: textfield; }
        #edit-player-number::-webkit-outer-spin-button, #edit-player-number::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        #delete-player-btn-modal { display: flex; align-items: center; justify-content: center; gap: 8px; }
        #delete-player-btn-modal svg { width: 18px; height: 18px; }
        
        #formation-modal .modal-content { max-width: 600px; }
        #formation-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .formation-card { border: 2px solid #ddd; border-radius: 8px; padding: 15px; text-align: center; cursor: pointer; transition: all 0.2s ease; background-color: #fff; }
        .formation-card:hover { border-color: var(--primary-color); transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .formation-card.selected { border-color: var(--primary-color); background-color: #e9f5ff; font-weight: bold; }
        .formation-name { font-size: 1.1em; margin-bottom: 5px; }
        .formation-note { font-size: 0.8em; color: #666; }

        .share-section { margin-bottom: 25px; }
        .share-section-title { font-weight: bold; margin-bottom: 10px; }
        .share-actions { display: flex; flex-direction: column; gap: 10px; }
        .share-actions button, .share-actions label { flex: 1; font-size: 14px; padding: 10px; text-align: center; }
        #import-squad-input { display: none; }
        
        #open-sidebar-btn { display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 14px; padding: 10px; }
        #open-sidebar-btn svg { width: 20px; height: 20px; }

        #player-list-sidebar { position: fixed; top: 0; left: 0; width: 300px; height: 100vh; background-color: #fff; box-shadow: 4px 0 15px rgba(0,0,0,0.2); transform: translateX(-100%); transition: transform 0.3s ease-in-out; z-index: 1000; display: flex; flex-direction: column; }
        #player-list-sidebar.is-open { transform: translateX(0); }
        .sidebar-header { padding: 15px 15px 10px 15px; border-bottom: 1px solid #eee; display: flex; flex-direction: column; align-items: flex-start; gap: 4px; }
        .sidebar-header .title-bar { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .sidebar-header h3 { margin: 0; font-size: 1.2em; }
        .sidebar-add-player { padding: 15px; border-bottom: 1px solid #eee; background-color: #f9f9f9; }
        .add-player-form { display: flex; gap: 8px; align-items: center; }
        .add-player-form input[type="number"] { width: 60px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; } 
        .add-player-form input[type="text"] { flex: 1; min-width: 0; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .add-player-form button { width: auto; flex-shrink: 0; font-size: 14px; padding: 8px 12px; }
        #sidebar-player-list { flex-grow: 1; overflow-y: auto; }
        #sidebar-player-list.is-empty { padding: 20px; text-align: center; color: #888; }

        .mode-toggle-fab { position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px; background-color: var(--primary-color); color: white; border: none; border-radius: 50%; box-shadow: 0 4px 12px rgba(0,0,0,0.3); cursor: pointer; display: flex; justify-content: center; align-items: center; z-index: 1000; transition: transform 0.2s, background-color 0.2s; }
        .mode-toggle-fab:hover { background-color: #0056b3; }
        .mode-toggle-fab:active { transform: scale(0.95); }
        .mode-toggle-fab svg { width: 30px; height: 30px; }

        .mode-toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background-color: rgba(0, 0, 0, 0.8); color: white; padding: 10px 20px; border-radius: 20px; font-size: 14px; font-weight: bold; z-index: 3000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; white-space: nowrap; }
        .mode-toast.show { opacity: 1; visibility: visible; }
        
        /* --- „Çµ„Ç§„Éâ„Éê„ÉºÊìç‰ΩúÊîπÂñÑ„ÅÆ„Åü„ÇÅ„ÅÆ„Çπ„Çø„Ç§„É´ --- */
        .container {
            transition: padding-left 0.3s ease-in-out;
        }
        #player-list-sidebar.no-transition {
            /* JS„Åß„Éâ„É©„ÉÉ„Ç∞‰∏≠„Å´‰ΩøÁî® */
            transition: none;
        }

        .sidebar-handle {
            position: fixed;
            left: 0;
            top: calc(50% - 50px);
            width: 24px;
            height: 100px;
            background-color: var(--primary-color);
            border: 2px solid white;
            border-left: none;
            border-radius: 0 12px 12px 0;
            cursor: grab;
            z-index: 1001;
            transition: left 0.3s ease-in-out, background-color 0.2s;
            box-shadow: 2px 0 8px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sidebar-handle:hover {
            background-color: #0056b3;
        }
        .sidebar-handle::after {
            content: '';
            width: 4px;
            height: 40px;
            background-color: rgba(255,255,255,0.7);
            border-radius: 2px;
        }
        body.sidebar-is-open .sidebar-handle {
            left: -30px; /* Èñã„ÅÑ„Å¶„ÅÑ„Çã„Å®„Åç„ÅØÈö†„Åô */
        }

        .pin-sidebar-btn {
            width: auto;
            height: auto;
            background: #f0f0f0;
            color: #333;
            border: 1px solid #ccc;
            border-radius: 50%;
            font-size: 16px;
            cursor: pointer;
            padding: 6px;
            line-height: 1;
            transition: all 0.2s;
            display: none; /* „Çπ„Éû„Éõ„Åß„ÅØÈùûË°®Á§∫ */
        }
        @media (hover: hover) and (pointer: fine) {
            /* PC („Éõ„Éê„ÉºÂèØËÉΩ„Éá„Éê„Ç§„Çπ) „ÅÆ„ÅøË°®Á§∫ */
            .pin-sidebar-btn { display: block; }
        }
        .pin-sidebar-btn:hover {
            background-color: #e0e0e0;
            transform: scale(1.1);
        }
        #player-list-sidebar.is-pinned .pin-sidebar-btn {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: rotate(45deg);
        }

        .sidebar-header .title-bar {
            /* „Éî„É≥„Éú„Çø„É≥ÈÖçÁΩÆ„ÅÆ„Åü„ÇÅ„ÅÆË™øÊï¥ */
            gap: 10px;
        }
        .sidebar-header .title-bar h3 {
            margin-right: auto;
        }
    </style>
</head>
<body data-layout-mode="vertical" data-drag-mode="swap">
    <div class="sidebar-handle"></div>
    <div class="container">
        <div class="left-panel">
            <div id="player-management-section-left" class="control-group"></div>
        </div>
        
        <div class="main-content">
            <input type="text" id="title-input" placeholder="„Çπ„Çø„É°„É≥‰∫àÊÉ≥">
            <div id="capture-area">
                <div class="pitch-wrapper vertical" id="pitch-wrapper">
                    <div class="capture-title" id="capture-title"></div>
                    <div class="pitch" id="pitch"></div>
                </div>
                <div class="capture-subs" id="capture-subs"></div>
                <div id="capture-watermark" class="capture-watermark"></div>
            </div>
        </div>

        <aside class="right-panel">
             <div class="app-branding">
                <h2>XISync</h2>
            </div>

            <div class="control-group">
                <label>„Éî„ÉÉ„ÉÅ„ÅÆÂêë„Åç</label>
                <div class="orientation-toggle">
                    <input type="radio" id="orientation-v" name="orientation" value="vertical" checked><label for="orientation-v">Á∏¶</label>
                    <input type="radio" id="orientation-h" name="orientation" value="horizontal"><label for="orientation-h">Ê®™</label>
                </div>
            </div>
            <div class="control-group">
                <label>„Éï„Ç©„Éº„É°„Éº„Ç∑„Éß„É≥</label>
                <button id="open-formation-modal-btn" class="btn-secondary"></button>
            </div>

            <div id="player-management-section" class="control-group" style="gap: 25px;">
                <div class="control-group">
                    <label>ÈÅ∏ÊâãÁÆ°ÁêÜ</label>
                    <div id="player-list-controls">
                        <button id="open-sidebar-btn" class="btn-primary">
                             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M15.78 4.33C15.42 4.08 15 4 14.56 4h-5.12c-.44 0-.82.08-1.18.33L3 7.84V19c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V7.84l-5.22-3.51zM10 16H8v-2h2v2zm0-4H8v-2h2v2zm6 4h-2v-2h2v2zm0-4h-2v-2h2v2z"></path></svg>
                            <span>ÈÅ∏Êâã„É™„Çπ„Éà„ÇíÈñã„Åè</span>
                        </button>
                        <button id="share-data-btn" class="btn-secondary" style="margin-top: 10px; font-size: 14px; padding: 10px;">„É™„Çπ„Éà„ÇíÂÖ±Êúâ / Ë™≠Ëæº</button>
                    </div>
                </div>
                <div class="control-group">
                    <label>Êéß„ÅàÈÅ∏Êâã</label>
                    <div id="substitutes-container">
                        <div class="sub-drop-zone" data-pos-category="ALL"></div>
                    </div>
                </div>
            </div>
            
            <div class="control-group">
                <label>Êìç‰Ωú</label>
                <button id="save-image-btn" class="btn-primary">ÁîªÂÉè„Çí‰øùÂ≠ò„Åô„Çã</button>
                <button id="reset-all-btn" class="btn-danger" style="margin-top: 10px;">ÂÖ®ÈÖçÁΩÆ„Çí„É™„Çª„ÉÉ„Éà</button>
            </div>
        </aside>
    </div>

    <!-- Sidebar, Modals, FAB -->
    <div id="player-list-sidebar">
        <div class="sidebar-header">
            <div class="title-bar">
                <h3>ÈÅ∏Êâã„É™„Çπ„Éà</h3>
                <button class="pin-sidebar-btn" title="„Çµ„Ç§„Éâ„Éê„Éº„ÇíÂõ∫ÂÆö">üìå</button>
            </div>
        </div>
        <div class="sidebar-add-player">
            <div class="add-player-form">
                <input type="number" id="sidebar-new-player-number" placeholder="No." min="1" inputmode="numeric" style="ime-mode: inactive;">
                <input type="text" id="sidebar-new-player-name" placeholder="ÈÅ∏ÊâãÂêç">
                <select id="sidebar-new-player-pos" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                    <option value="FW">FW</option>
                    <option value="MF">MF</option>
                    <option value="DF">DF</option>
                    <option value="GK">GK</option>
                </select>
                <button id="sidebar-add-player-btn" class="btn-primary">+</button>
            </div>
        </div>
        <div id="sidebar-player-list"></div>
    </div>

    <div class="modal-overlay" id="formation-modal">
        <div class="modal-content">
            <button class="modal-close-btn">&times;</button>
            <h3>„Éï„Ç©„Éº„É°„Éº„Ç∑„Éß„É≥„ÇíÈÅ∏Êäû</h3>
            <div id="formation-grid"></div>
        </div>
    </div>
    
    <div class="modal-overlay" id="edit-player-modal">
        <div class="modal-content">
            <button class="modal-close-btn">&times;</button>
            <h3>ÈÅ∏ÊâãÊÉÖÂ†±„ÅÆÁ∑®ÈõÜ</h3>
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <div class="form-group">
                    <label for="edit-player-number">ËÉåÁï™Âè∑</label>
                    <div class="number-input-wrapper">
                        <button id="decrement-btn" class="number-input-btn">-</button>
                        <input type="number" id="edit-player-number" inputmode="numeric" style="ime-mode: inactive;">
                        <button id="increment-btn" class="number-input-btn">+</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="edit-player-name">ÈÅ∏ÊâãÂêç</label>
                    <input type="text" id="edit-player-name">
                </div>
                <div class="form-group">
                    <label for="edit-player-pos">„Éù„Ç∏„Ç∑„Éß„É≥</label>
                    <select id="edit-player-pos" style="width: 100%; padding: 12px; font-size: 16px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box;">
                        <option value="FW">FW</option>
                        <option value="MF">MF</option>
                        <option value="DF">DF</option>
                        <option value="GK">GK</option>
                    </select>
                </div>
                <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;">
                    <button id="save-player-changes-btn" class="btn-primary">Â§âÊõ¥„Çí‰øùÂ≠ò</button>
                    <button id="delete-player-btn-modal" class="btn-danger">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
                        <span>„Åì„ÅÆÈÅ∏Êâã„ÇíÂâäÈô§„Åô„Çã</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="share-modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn">&times;</button>
            <h3>ÈÅ∏Êâã„É™„Çπ„Éà„ÅÆÂÖ±Êúâ / Ë™≠„ÅøËæº„Åø</h3>
            <div class="share-section">
                <div class="share-section-title">„É™„Çπ„Éà„ÇíÂá∫Âäõ</div>
                <div class="share-actions" style="flex-direction: column; gap: 10px;">
                    <button id="copy-url-btn" class="btn-primary">URL„Çí„Ç≥„Éî„Éº„Åó„Å¶ÂÖ±Êúâ</button>
                    <button id="copy-squad-btn" class="btn-secondary">„ÉÜ„Ç≠„Çπ„Éà(„Éá„Éº„Çø)„Çí„Ç≥„Éî„Éº</button>
                    <button id="export-squad-btn" class="btn-secondary">„Éï„Ç°„Ç§„É´„Åß‰øùÂ≠ò</button>
                </div>
            </div>
            <div class="share-section">
                <div class="share-section-title">„É™„Çπ„Éà„ÇíË™≠„ÅøËæº„Åø</div>
                <div class="share-actions">
                    <button id="import-from-clipboard-btn" class="btn-primary">„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Åã„ÇâË™≠Ëæº</button>
                    <label for="import-squad-input" class="btn-secondary">„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶Ë™≠Ëæº</label>
                    <input type="file" id="import-squad-input" accept=".json, .txt">
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="import-confirm-modal">
        <div class="modal-content">
            <h3>ÈÅ∏Êâã„É™„Çπ„Éà„ÅÆ„Ç§„É≥„Éù„Éº„Éà</h3>
            <p>ÂÖ±Êúâ„Åï„Çå„ÅüÈÅ∏Êâã„Éá„Éº„Çø„ÅßÁèæÂú®„ÅÆ„É™„Çπ„Éà„Çí‰∏äÊõ∏„Åç„Åó„Åæ„Åô„ÅãÔºüÈÖçÁΩÆ„ÅØ„É™„Çª„ÉÉ„Éà„Åï„Çå„Åæ„Åô„ÄÇ</p>
            <div id="import-preview-list" style="max-height: 200px; overflow-y: auto; border: 1px solid #eee; padding: 10px; margin-bottom: 20px; border-radius: 6px;">
            </div>
            <div style="display: flex; gap: 10px;">
                <button id="confirm-import-btn" class="btn-primary" style="flex: 1;">„Ç§„É≥„Éù„Éº„Éà„Åô„Çã</button>
                <button id="cancel-import-btn" class="btn-secondary" style="flex: 1;">„Ç≠„É£„É≥„Çª„É´</button>
            </div>
        </div>
    </div>
    
    <div class="drag-ghost" id="drag-ghost"></div>

    <button id="mode-toggle-btn" class="mode-toggle-fab" title="„Éû„Éº„Ç´„ÉºÊìç‰Ωú„É¢„Éº„ÉâÂàáÊõø"></button>
    <div id="mode-toast" class="mode-toast"></div>

<script>
// --- PWA Service Worker Registration ---
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js')
        .then(reg => console.log('Service Worker registered successfully:', reg.scope))
        .catch(err => console.log('Service Worker registration failed:', err));
}


document.addEventListener('DOMContentLoaded', () => {
    
const App = {
    els: {},
    state: {
        squad: [],
        starters: {}, // { "posId": { playerId, coords }, ... }
        substitutes: { GK: [], DF: [], MF: [], FW: [] },
        config: {
            orientation: 'vertical',
            formation: '4-2-3-1',
            dragMode: 'swap',
            title: ''
        },
    },

    editingPlayerId: null,
    toastTimer: null,
    numberChangeInterval: null,
    _importedSquadData: null,
    sidebarHoverTimer: null,

    init() {
        this.cacheElements();
        this.defineConstants();
        this.clonePanels();
        this.loadState();
        this.checkUrlForSquadData();
        this.buildFormationModal();
        this.bindEvents();
        this.renderAll();
    },

    cacheElements() {
        const query = (selector) => document.querySelector(selector);
        const queryAll = (selector) => document.querySelectorAll(selector);
        this.els = {
            body: document.body, pitch: query('#pitch'), pitchWrapper: query('#pitch-wrapper'),
            saveImageBtn: query('#save-image-btn'), dragGhost: query('#drag-ghost'),
            orientationRadios: document.getElementsByName('orientation'), titleInput: query('#title-input'),
            playerManagementSectionLeft: query('#player-management-section-left'),
            playerManagementSectionRight: query('#player-management-section'),
            panels: {
                left: { subDropZones: queryAll('.left-panel .sub-drop-zone') },
                right: { openFormationModalBtn: query('.right-panel #open-formation-modal-btn'), subDropZones: queryAll('.right-panel .sub-drop-zone'), resetAllBtn: query('#reset-all-btn') }
            },
            shareModal: {
                overlay: query('#share-modal-overlay'), copyUrlBtn: query('#copy-url-btn'),
                copySquadBtn: query('#copy-squad-btn'), exportSquadBtn: query('#export-squad-btn'),
                importSquadInput: query('#import-squad-input'), importFromClipboardBtn: query('#import-from-clipboard-btn')
            },
            sidebar: {
                el: query('#player-list-sidebar'), list: query('#sidebar-player-list'),
                addBtn: query('#sidebar-add-player-btn'), numberInput: query('#sidebar-new-player-number'),
                nameInput: query('#sidebar-new-player-name'), posSelect: query('#sidebar-new-player-pos')
            },
            editModal: {
                overlay: query('#edit-player-modal'), numberInput: query('#edit-player-number'),
                nameInput: query('#edit-player-name'), posSelect: query('#edit-player-pos'), saveBtn: query('#save-player-changes-btn'),
                deleteBtn: query('#delete-player-btn-modal'), incrementBtn: query('#increment-btn'), decrementBtn: query('#decrement-btn')
            },
            importConfirmModal: {
                overlay: query('#import-confirm-modal'), previewList: query('#import-preview-list'),
                confirmBtn: query('#confirm-import-btn'), cancelBtn: query('#cancel-import-btn')
            },
            formationModal: { overlay: query('#formation-modal'), grid: query('#formation-grid') },
            modeToggleBtn: query('#mode-toggle-btn'), modeToast: query('#mode-toast'),
            sidebarHandle: query('.sidebar-handle'),
            pinSidebarBtn: query('.pin-sidebar-btn')
        };
        this.els.allModals = queryAll('.modal-overlay');
        this.els.allCloseBtns = queryAll('.modal-close-btn');
    },

    defineConstants() {
        this.formations = {'4-3-3':{name:'4-3-3',note:'',spec:[{pos:'GK'},{pos:'RSB'},{pos:'RCB'},{pos:'LCB'},{pos:'LSB'},{pos:'DMF'},{pos:'RCM'},{pos:'LCM'},{pos:'RWG'},{pos:'CF'},{pos:'LWG'}]},'4-4-2':{name:'4-4-2',note:'',spec:[{pos:'GK'},{pos:'RSB'},{pos:'RCB'},{pos:'LCB'},{pos:'LSB'},{pos:'RMF'},{pos:'CMF'},{pos:'CMF',isDuplicate:true},{pos:'LMF'},{pos:'FW'},{pos:'FW',isDuplicate:true}]},'4-2-3-1':{name:'4-2-3-1',note:'Standard',spec:[{pos:'GK'},{pos:'RSB'},{pos:'RCB'},{pos:'LCB'},{pos:'LSB'},{pos:'DMF'},{pos:'DMF',isDuplicate:true},{pos:'RMF'},{pos:'AMF'},{pos:'LMF'},{pos:'CF'}]},'4-1-4-1':{name:'4-1-4-1',note:'',spec:[{pos:'GK'},{pos:'RSB'},{pos:'RCB'},{pos:'LCB'},{pos:'LSB'},{pos:'DMF'},{pos:'RMF'},{pos:'RCM'},{pos:'LCM'},{pos:'LMF'},{pos:'CF'}]},'4-3-1-2':{name:'4-3-1-2',note:'Diamond',spec:[{pos:'GK'},{pos:'RSB'},{pos:'RCB'},{pos:'LCB'},{pos:'LSB'},{pos:'DMF'},{pos:'RCM'},{pos:'LCM'},{pos:'AMF'},{pos:'FW'},{pos:'FW',isDuplicate:true}]},'4-3-2-1':{name:'4-3-2-1',note:'Tree',spec:[{pos:'GK'},{pos:'RSB'},{pos:'RCB'},{pos:'LCB'},{pos:'LSB'},{pos:'RCM'},{pos:'CMF'},{pos:'LCM'},{pos:'RAM'},{pos:'LAM'},{pos:'CF'}]},'3-5-2':{name:'3-5-2',note:'',spec:[{pos:'GK'},{pos:'RCB'},{pos:'CB'},{pos:'LCB'},{pos:'RWB'},{pos:'RCM'},{pos:'DMF'},{pos:'LCM'},{pos:'LWB'},{pos:'FW'},{pos:'FW',isDuplicate:true}]},'3-4-3':{name:'3-4-3',note:'',spec:[{pos:'GK'},{pos:'RCB'},{pos:'CB'},{pos:'LCB'},{pos:'RMF'},{pos:'CMF'},{pos:'CMF',isDuplicate:true},{pos:'LMF'},{pos:'RWG'},{pos:'CF'},{pos:'LWG'}]},'3-4-2-1':{name:'3-4-2-1',note:'',spec:[{pos:'GK'},{pos:'RCB'},{pos:'CB'},{pos:'LCB'},{pos:'RWB'},{pos:'DMF'},{pos:'DMF',isDuplicate:true},{pos:'LWB'},{pos:'RAM'},{pos:'LAM'},{pos:'CF'}]},'5-3-2':{name:'5-3-2',note:'',spec:[{pos:'GK'},{pos:'RCB'},{pos:'CB'},{pos:'LCB'},{pos:'RWB'},{pos:'LWB'},{pos:'RCM'},{pos:'CMF'},{pos:'LCM'},{pos:'FW'},{pos:'FW',isDuplicate:true}]},'5-4-1':{name:'5-4-1',note:'',spec:[{pos:'GK'},{pos:'RSB'},{pos:'RCB'},{pos:'CB'},{pos:'LCB'},{pos:'LSB'},{pos:'RMF'},{pos:'RCM'},{pos:'LCM'},{pos:'LMF'},{pos:'CF'}]}};
        this.formationCoords = {'4-3-3':[{top:50,left:8},{top:85,left:28},{top:65,left:25},{top:35,left:25},{top:15,left:28},{top:50,left:48},{top:70,left:60},{top:30,left:60},{top:80,left:80},{top:50,left:85},{top:20,left:80}],'4-4-2':[{top:50,left:8},{top:85,left:28},{top:65,left:25},{top:35,left:25},{top:15,left:28},{top:85,left:55},{top:60,left:50},{top:40,left:50},{top:15,left:55},{top:65,left:78},{top:35,left:78}],'4-2-3-1':[{top:50,left:8},{top:85,left:28},{top:65,left:25},{top:35,left:25},{top:15,left:28},{top:65,left:48},{top:35,left:48},{top:80,left:70},{top:50,left:72},{top:20,left:70},{top:50,left:88}],'4-1-4-1':[{top:50,left:8},{top:85,left:28},{top:65,left:25},{top:35,left:25},{top:15,left:28},{top:50,left:45},{top:85,left:65},{top:65,left:62},{top:35,left:62},{top:15,left:65},{top:50,left:85}],'4-3-1-2':[{top:50,left:8},{top:85,left:28},{top:65,left:25},{top:35,left:25},{top:15,left:28},{top:50,left:45},{top:75,left:55},{top:25,left:55},{top:50,left:70},{top:65,left:85},{top:35,left:85}],'4-3-2-1':[{top:50,left:8},{top:85,left:28},{top:65,left:25},{top:35,left:25},{top:15,left:28},{top:70,left:55},{top:50,left:50},{top:30,left:55},{top:65,left:75},{top:35,left:75},{top:50,left:88}],'3-5-2':[{top:50,left:8},{top:75,left:28},{top:50,left:25},{top:25,left:28},{top:90,left:55},{top:70,left:50},{top:50,left:42},{top:30,left:50},{top:10,left:55},{top:65,left:82},{top:35,left:82}],'3-4-3':[{top:50,left:8},{top:75,left:28},{top:50,left:25},{top:25,left:28},{top:85,left:58},{top:65,left:52},{top:35,left:52},{top:15,left:58},{top:80,left:80},{top:50,left:85},{top:20,left:80}],'3-4-2-1':[{top:50,left:8},{top:75,left:28},{top:50,left:25},{top:25,left:28},{top:85,left:58},{top:65,left:50},{top:35,left:50},{top:15,left:58},{top:65,left:78},{top:35,left:78},{top:50,left:88}],'5-3-2':[{top:50,left:8},{top:75,left:28},{top:50,left:25},{top:25,left:28},{top:90,left:35},{top:10,left:35},{top:75,left:60},{top:50,left:55},{top:25,left:60},{top:65,left:82},{top:35,left:82}],'5-4-1':[{top:50,left:8},{top:90,left:28},{top:70,left:25},{top:50,left:22},{top:30,left:25},{top:10,left:28},{top:85,left:58},{top:60,left:52},{top:40,left:52},{top:15,left:58},{top:50,left:82}]};
        this.svgIcons = {position:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M7.646.146a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 1.707V5.5a.5.5 0 0 1-1 0V1.707L6.354 2.854a.5.5 0 1 1-.708-.708l2-2zM8 10a.5.5 0 0 1 .5.5v3.793l1.146-1.147a.5.5 0 0 1 .708.708l-2 2a.5.5 0 0 1-.708 0l-2-2a.5.5 0 0 1 .708-.708L7.5 14.293V10.5A.5.5 0 0 1 8 10zM.146 8.354a.5.5 0 0 1 0-.708l2-2a.5.5 0 1 1 .708.708L1.707 7.5H5.5a.5.5 0 0 1 0 1H1.707l1.147 1.146a.5.5 0 0 1-.708.708l-2-2zM10 8a.5.5 0 0 1 .5-.5h3.793l-1.147-1.146a.5.5 0 0 1 .708-.708l2 2a.5.5 0 0 1 0 .708l-2 2a.5.5 0 0 1-.708-.708L14.293 8.5H10.5A.5.5 0 0 1 10 8z"/></svg>',swap:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1 11.5a.5.5 0 0 0 .5.5h11.793l-1.147 1.146a.5.5 0 0 0 .708.708l2-2a.5.5 0 0 0 0-.708l-2-2a.5.5 0 0 0-.708.708L13.293 11H1.5a.5.5 0 0 0-.5.5zm14-7a.5.5 0 0 1-.5.5H2.707l1.147 1.146a.5.5 0 1 1-.708.708l-2-2a.5.5 0 0 1 0-.708l2-2a.5.5 0 1 1 .708.708L2.707 4H14.5a.5.5 0 0 1 .5.5z"/></svg>'};
    },

    clonePanels() {
        this.els.playerManagementSectionLeft.innerHTML = this.els.playerManagementSectionRight.innerHTML;
        this.cacheElements(); 
        this.els.allShareBtns = document.querySelectorAll('#share-data-btn');
        this.els.allOpenSidebarBtns = document.querySelectorAll('#open-sidebar-btn');
    },
    
    bindEvents() {
        // --- „Çµ„Ç§„Éâ„Éê„Éº‰ª•Â§ñ„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº ---
        [...this.els.orientationRadios].forEach(radio => radio.addEventListener('change', e => { this.state.config.orientation = e.target.value; this.renderAll(); }));
        this.els.allShareBtns.forEach(btn => btn.addEventListener('click', () => this.openModal(this.els.shareModal.overlay)));
        if (this.els.panels.right.resetAllBtn) this.els.panels.right.resetAllBtn.addEventListener('click', this.resetAllAssignments.bind(this));
        if (this.els.panels.right.openFormationModalBtn) this.els.panels.right.openFormationModalBtn.addEventListener('click', () => { this.buildFormationModal(); this.openModal(this.els.formationModal.overlay); });

        this.els.sidebar.addBtn.addEventListener('click', this.addPlayer.bind(this));
        this.els.sidebar.nameInput.addEventListener('keypress', e => e.key === 'Enter' && this.addPlayer());

        this.els.allModals.forEach(modal => modal.addEventListener('click', e => e.target === modal && this.closeAllModals()));
        this.els.allCloseBtns.forEach(btn => btn.addEventListener('click', this.closeAllModals.bind(this)));

        this.els.editModal.saveBtn.addEventListener('click', this.savePlayerChanges.bind(this));
        this.els.editModal.deleteBtn.addEventListener('click', this.deletePlayerFromModal.bind(this));
        this.els.editModal.incrementBtn.addEventListener('click', () => this.changeNumber(1));
        this.els.editModal.decrementBtn.addEventListener('click', () => this.changeNumber(-1));
        ['mousedown', 'touchstart'].forEach(evt => {
            this.els.editModal.incrementBtn.addEventListener(evt, () => this.numberChangeInterval = setInterval(() => this.changeNumber(1), 100));
            this.els.editModal.decrementBtn.addEventListener(evt, () => this.numberChangeInterval = setInterval(() => this.changeNumber(-1), 100));
        });
        ['mouseup', 'mouseleave', 'touchend'].forEach(evt => {
            document.addEventListener(evt, () => clearInterval(this.numberChangeInterval));
        });

        this.els.shareModal.copyUrlBtn.addEventListener('click', this.copySquadUrlToClipboard.bind(this));
        this.els.shareModal.copySquadBtn.addEventListener('click', this.copySquadToClipboard.bind(this));
        this.els.shareModal.exportSquadBtn.addEventListener('click', this.exportSquadToFile.bind(this));
        this.els.shareModal.importSquadInput.addEventListener('change', this.importFromFile.bind(this));
        this.els.shareModal.importFromClipboardBtn.addEventListener('click', this.importFromClipboard.bind(this));
        
        this.els.importConfirmModal.confirmBtn.addEventListener('click', this.confirmImport.bind(this));
        this.els.importConfirmModal.cancelBtn.addEventListener('click', () => { this.closeAllModals(); history.replaceState(null, '', window.location.pathname); });

        this.els.modeToggleBtn.addEventListener('click', this.toggleDragMode.bind(this));
        this.els.saveImageBtn.addEventListener('click', this.saveImage.bind(this));

        document.querySelectorAll('.sub-drop-zone').forEach(zone => {
            zone.addEventListener('dragover', this.handleDragOver.bind(this));
            zone.addEventListener('dragleave', this.handleDragLeave.bind(this));
            zone.addEventListener('drop', this.handleDropOnSubZone.bind(this));
        });
        
        let titleSaveTimeout;
        this.els.titleInput.addEventListener('input', () => { clearTimeout(titleSaveTimeout); titleSaveTimeout = setTimeout(() => this.saveState(), 500); });
        
        // --- Êñ∞„Åó„ÅÑ„Çµ„Ç§„Éâ„Éê„ÉºÊìç‰Ωú„ÅÆ„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó ---
        this.setupSidebarControls();
    },
    
    saveState() {
        this.state.config.title = this.els.titleInput.value;
        localStorage.setItem("xisyncAppState", JSON.stringify(this.state));
    },

    loadState() {
        const savedStateJSON = localStorage.getItem("xisyncAppState");
        if (savedStateJSON) {
            try {
                const savedState = JSON.parse(savedStateJSON);
                Object.assign(this.state, savedState);
                this.state.config = {
                    ...{ orientation: "vertical", formation: "4-2-3-1", dragMode: "swap", title: "" },
                    ...savedState.config
                };
                this.state.substitutes = savedState.substitutes || { GK: [], DF: [], MF: [], FW: [] };
            } catch (e) {
                console.error("Failed to load state:", e);
            }
        }
    },

    updateUI() {
        this.els.titleInput.value = this.state.config.title;
        document.querySelector(`input[name="orientation"][value="${this.state.config.orientation}"]`).checked = true;
        this.els.body.dataset.layoutMode = this.state.config.orientation;
        this.els.body.dataset.dragMode = this.state.config.dragMode;
        this.els.panels.right.openFormationModalBtn.textContent = this.formations[this.state.config.formation].name;
        this.els.modeToggleBtn.innerHTML = this.svgIcons[this.state.config.dragMode];
    },

    renderAll() {
        this.updateUI();
        this.renderFormation();
        this.renderPlayerList();
        this.renderSubstitutes();
        this.saveState();
    },

    renderFormation() {
        this.els.pitchWrapper.className = `pitch-wrapper ${this.state.config.orientation}`;
        this.els.pitch.innerHTML = '<div class="pitch-line center-line"></div><div class="pitch-line center-circle"></div><div class="pitch-line goal-area"></div><div class="pitch-line penalty-area"></div><div class="pitch-line penalty-arc"></div><div class="pitch-line goal"></div>';
        
        const formationSpec = this.formations[this.state.config.formation].spec;
        const formationCoords = this.formationCoords[this.state.config.formation];
        
        formationSpec.forEach((spec, index) => {
            const posId = `${spec.pos}_${spec.isDuplicate ? index : 1}`;
            this.createPlayerMarker(spec, formationCoords[index], posId);
        });
    },

    createPlayerMarker(posSpec, defaultCoords, posId) {
        const markerEl = document.createElement('div');
        markerEl.className = 'player-container';
        markerEl.dataset.posId = posId;

        const starter = this.state.starters[posId];
        const currentCoords = starter?.coords ?? defaultCoords;

        if (this.state.config.orientation === 'vertical') {
            markerEl.style.top = `${100 - (currentCoords.left * 0.9)}%`;
            markerEl.style.left = `${currentCoords.top}%`;
        } else {
            markerEl.style.top = `${currentCoords.top}%`;
            markerEl.style.left = `${currentCoords.left * 0.9}%`;
        }

        const player = starter ? this.state.squad.find(p => p.id === starter.playerId) : null;
        const role = this.getRole(posSpec.pos);

        markerEl.innerHTML = `
            <div class="player-marker ${role}">
                <span class="player-number">${player?.number ?? ''}</span>
                <span class="player-pos">${posSpec.pos}</span>
            </div>
            <div class="player-name">${player?.name ?? posSpec.pos}</div>`;
            
        markerEl.addEventListener('dragover', this.handleDragOver.bind(this));
        markerEl.addEventListener('dragleave', this.handleDragLeave.bind(this));
        markerEl.addEventListener('drop', (e) => this.handleDropOnPitch(e, posId));

        if (player) {
            if (this.state.config.dragMode === 'position') {
                this.makeMarkerMovable(markerEl);
                markerEl.draggable = false;
            } else {
                markerEl.draggable = true;
                markerEl.addEventListener('dragstart', (e) => this.handleDragStart(e, { type: 'pitch', posId: posId, playerId: player.id }));
            }
            const unassignBtn = document.createElement('button');
            unassignBtn.innerHTML = '&times;';
            unassignBtn.className = 'unassign-btn';
            unassignBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.unassignPlayer(player.id);
                this.renderAll();
            });
            markerEl.appendChild(unassignBtn);
        }
        this.els.pitch.appendChild(markerEl);
    },
    
    getRole(pos) {
        if (pos === 'GK') return 'gk';
        if (['B', 'SB', 'CB'].some(p => pos.includes(p))) return 'df';
        if (['MF', 'WB', 'AM', 'CM', 'DM'].some(p => pos.includes(p))) return 'mf';
        return 'fw';
    },

    makeMarkerMovable(marker) {
        const handleMouseDown = (e) => {
            if (e.target.tagName !== 'DIV' || !e.target.classList.contains('player-marker')) return;
            marker.classList.add('is-moving');

            const handleMouseMove = (moveEvent) => {
                const pitchRect = this.els.pitch.getBoundingClientRect();
                const newLeft = Math.max(0, Math.min(100, (moveEvent.clientX - pitchRect.left) / pitchRect.width * 100));
                const newTop = Math.max(0, Math.min(100, (moveEvent.clientY - pitchRect.top) / pitchRect.height * 100));
                marker.style.left = `${newLeft}%`;
                marker.style.top = `${newTop}%`;
            };
            const handleMouseUp = () => {
                marker.classList.remove('is-moving');
                document.removeEventListener('mousemove', handleMouseMove);
                
                const posId = marker.dataset.posId;
                const newLeftPercent = parseFloat(marker.style.left);
                const newTopPercent = parseFloat(marker.style.top);
                
                if (this.state.config.orientation === 'vertical') {
                    this.state.starters[posId].coords = { top: newLeftPercent, left: (100 - newTopPercent) / 0.9 };
                } else {
                    this.state.starters[posId].coords = { top: newTopPercent, left: newLeftPercent / 0.9 };
                }
                this.saveState();
            };
            
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp, { once: true });
        };
        marker.addEventListener('mousedown', handleMouseDown);
    },

    renderPlayerList() {
        const listContainer = this.els.sidebar.list;
        listContainer.innerHTML = '';
        if (this.state.squad.length === 0) {
            listContainer.className = 'is-empty';
            listContainer.textContent = '‰∏ä„ÅÆ„Éï„Ç©„Éº„É†„Åã„ÇâÈÅ∏Êâã„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
            return;
        }
        listContainer.className = '';

        const assignedPlayerIds = new Set([
            ...Object.values(this.state.starters).map(s => s.playerId),
            ...Object.values(this.state.substitutes).flat()
        ]);
        
        this.state.squad.sort((a, b) => a.number - b.number).forEach(player => {
            const isAssigned = assignedPlayerIds.has(player.id);
            const itemEl = document.createElement('div');
            itemEl.className = `player-list-item ${isAssigned ? 'is-assigned' : ''}`;
            itemEl.dataset.playerId = player.id;
            itemEl.innerHTML = `
                <span class="num">${player.number}</span>
                <div class="name">
                    <span>${player.name}</span>
                    <button class="edit-player-btn" title="Á∑®ÈõÜ">‚úèÔ∏è</button>
                </div>`;
            
            // Assign edit button event regardless of assignment status
            itemEl.querySelector('.edit-player-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                this.openEditModal(player.id);
            });

            // Make draggable only if not assigned
            if (!isAssigned) {
                itemEl.draggable = true;
                itemEl.addEventListener('dragstart', (e) => this.handleDragStart(e, { type: 'list', playerId: player.id }));
            }

            // Add Double-click event for PC
            itemEl.addEventListener('dblclick', () => {
                this.openEditModal(player.id);
            });

            // Add Long-press event for Touch devices
            let longPressTimer;
            const startLongPress = (e) => {
                // Prevent interfering with edit button clicks
                if (e.target.closest('.edit-player-btn')) return;
                longPressTimer = setTimeout(() => {
                    navigator.vibrate?.(50);
                    this.openEditModal(player.id);
                    longPressTimer = null; // Prevent re-triggering
                }, 500); // 500ms for long press
            };
            const cancelLongPress = () => {
                clearTimeout(longPressTimer);
            };
            itemEl.addEventListener('touchstart', startLongPress, { passive: true });
            itemEl.addEventListener('touchend', cancelLongPress);
            itemEl.addEventListener('touchmove', cancelLongPress);


            listContainer.appendChild(itemEl);
        });
    },

    renderSubstitutes() {
        const zone = document.querySelector('.sub-drop-zone');
        zone.innerHTML = '';
        const allSubIds = Object.values(this.state.substitutes).flat();
        
        allSubIds.forEach(playerId => {
            const player = this.state.squad.find(p => p.id === playerId);
            if (!player) return;
            const subItem = document.createElement('div');
            subItem.className = 'substitute-item';
            subItem.dataset.playerId = playerId;
            subItem.draggable = true;
            subItem.addEventListener('dragstart', (e) => this.handleDragStart(e, { type: 'substitute', playerId, category: player.posCategory }));
            subItem.innerHTML = `
                <span class="num">${player.number}</span>
                <span class="name">${player.name}</span>
                <button class="unassign-btn-sub">&times;</button>`;
            subItem.querySelector('.unassign-btn-sub').addEventListener('click', (e) => {
                e.stopPropagation();
                this.unassignPlayer(playerId);
                this.renderAll();
            });
            zone.appendChild(subItem);
        });
    },

    handleDragStart(e, data) {
        e.dataTransfer.setData('application/json', JSON.stringify(data));
        e.dataTransfer.effectAllowed = 'move';
        const player = this.state.squad.find(p => p.id === data.playerId);
        if (player) {
            this.els.dragGhost.innerHTML = `<span class="num">${player.number}</span><span class="name">${player.name}</span>`;
            e.dataTransfer.setDragImage(this.els.dragGhost, 15, 15);
        }
        e.stopPropagation();
        if (this.els.sidebar.el.classList.contains('is-open')) {
            this.closeSidebar(true);
        }
    },

    handleDragOver(e) { e.preventDefault(); e.currentTarget.classList.add('drop-target-hover'); },
    handleDragLeave(e) { e.currentTarget.classList.remove('drop-target-hover'); },

    handleDropOnPitch(e, targetPosId) {
        e.preventDefault(); e.stopPropagation();
        e.currentTarget.classList.remove('drop-target-hover');
        const data = JSON.parse(e.dataTransfer.getData('application/json'));
        const draggedPlayerId = data.playerId;
        const playerOnTarget = this.state.starters[targetPosId]?.playerId;
        
        if (draggedPlayerId === playerOnTarget) return;

        this.unassignPlayer(draggedPlayerId);
        
        if (playerOnTarget) {
            this.unassignPlayer(playerOnTarget);
            if (data.type === 'pitch') {
                this.state.starters[data.posId] = { playerId: playerOnTarget, coords: this.state.starters[data.posId]?.coords || null };
            } else {
                const posName = targetPosId.split('_')[0];
                const role = this.getRole(posName).toUpperCase();
                this.state.substitutes[role].push(playerOnTarget);
            }
        }
        
        this.state.starters[targetPosId] = { playerId: draggedPlayerId, coords: this.state.starters[targetPosId]?.coords || null };
        this.renderAll();
    },

    handleDropOnSubZone(e) {
        e.preventDefault(); e.stopPropagation();
        const zone = e.currentTarget;
        zone.classList.remove('drop-target-hover');
        const data = JSON.parse(e.dataTransfer.getData('application/json'));
        const player = this.state.squad.find(p => p.id === data.playerId);

        if (player) {
            this.unassignPlayer(data.playerId);
            // ÈÅ∏Êâã„ÅÆ„Éù„Ç∏„Ç∑„Éß„É≥„Ç´„ÉÜ„Ç¥„É™„Å´Âü∫„Å•„ÅÑ„Å¶Ê≠£„Åó„ÅÑÈÖçÂàó„Å´ËøΩÂä†
            if (!this.state.substitutes[player.posCategory]) {
                this.state.substitutes[player.posCategory] = [];
            }
            this.state.substitutes[player.posCategory].push(data.playerId);
            this.renderAll();
        }
    },

    unassignPlayer(playerId) {
        for (const posId in this.state.starters) {
            if (this.state.starters[posId]?.playerId === playerId) {
                delete this.state.starters[posId];
                return;
            }
        }
        for (const category in this.state.substitutes) {
            this.state.substitutes[category] = (this.state.substitutes[category] || []).filter(id => id !== playerId);
        }
    },

    addPlayer() {
        const number = this.els.sidebar.numberInput.value;
        const name = this.els.sidebar.nameInput.value.trim();
        const posCategory = this.els.sidebar.posSelect.value; // ËøΩÂä†
        if (!number || !name) { alert('ËÉåÁï™Âè∑„Å®ÈÅ∏ÊâãÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'); return; }
        if (this.state.squad.some(p => p.number === parseInt(number))) { alert('„Åì„ÅÆËÉåÁï™Âè∑„ÅØÊó¢„Å´‰ΩøÁî®„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ'); return; }
        this.state.squad.push({ id: `p_${Date.now()}`, number: parseInt(number), name, posCategory }); // Â§âÊõ¥
        this.els.sidebar.numberInput.value = '';
        this.els.sidebar.nameInput.value = '';
        this.els.sidebar.numberInput.focus();
        this.renderAll();
    },

    resetAllAssignments() {
        if (confirm('„Åô„Åπ„Å¶„ÅÆÈÅ∏Êâã„ÅÆÈÖçÁΩÆ„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü')) {
            this.state.starters = {};
            this.state.substitutes = { GK: [], DF: [], MF: [], FW: [] };
            this.renderAll();
        }
    },
    
    openModal(modalEl) { modalEl.style.display = 'flex'; },
    closeAllModals() {
        this.els.allModals.forEach(modal => modal.style.display = 'none');
        clearInterval(this.numberChangeInterval);
    },

    buildFormationModal() {
        this.els.formationModal.grid.innerHTML = '';
        for (const key in this.formations) {
            const formation = this.formations[key];
            const card = document.createElement('div');
            card.className = 'formation-card';
            card.dataset.formation = key;
            card.innerHTML = `<div class="formation-name">${formation.name}</div><div class="formation-note">${formation.note || '&nbsp;'}</div>`;
            if (key === this.state.config.formation) card.classList.add('selected');
            card.addEventListener('click', () => {
                this.changeFormation(key);
                this.closeAllModals();
            });
            this.els.formationModal.grid.appendChild(card);
        }
    },

    changeFormation(newFormationKey) {
        const oldStarters = { ...this.state.starters };
        this.state.starters = {};

        const newPositions = this.formations[newFormationKey].spec.map((spec, index) => {
            const posId = `${spec.pos}_${spec.isDuplicate ? index : 1}`;
            const coords = this.formationCoords[newFormationKey][index];
            const characteristics = this.getPositionCharacteristics(spec.pos, coords);
            return { posId, pos: spec.pos, characteristics, isAssigned: false };
        });

        Object.values(oldStarters).forEach(starterData => {
            const player = this.state.squad.find(p => p.id === starterData.playerId);
            if (!player) return;

            let bestMatch = null;
            let bestScore = -Infinity;

            const oldPosId = Object.keys(oldStarters).find(key => oldStarters[key].playerId === starterData.playerId);
            const oldPosName = oldPosId ? oldPosId.split('_')[0] : '';
            const oldFormationKey = this.state.config.formation;
            const oldPosIndex = this.formations[oldFormationKey].spec.findIndex((spec, i) => `${spec.pos}_${spec.isDuplicate ? i : 1}` === oldPosId);
            const oldCoords = (oldPosIndex !== -1) ? this.formationCoords[oldFormationKey][oldPosIndex] : { top: 50, left: 50 };
            const oldCharacteristics = this.getPositionCharacteristics(oldPosName, oldCoords);

            newPositions.forEach(newPos => {
                if (newPos.isAssigned) return;
                const score = this.calculatePositionSimilarity(oldCharacteristics, newPos.characteristics);
                if (score > bestScore) {
                    bestScore = score;
                    bestMatch = newPos;
                }
            });

            if (bestMatch) {
                this.state.starters[bestMatch.posId] = { playerId: starterData.playerId, coords: null };
                bestMatch.isAssigned = true;
            } else {
                const role = this.getRole(oldPosName).toUpperCase();
                if (!this.state.substitutes[role]) this.state.substitutes[role] = [];
                this.state.substitutes[role].push(starterData.playerId);
            }
        });
        
        this.state.config.formation = newFormationKey;
        this.renderAll();
    },

    getPositionCharacteristics(posName, coords) {
        let role = 'GENERIC';
        if (posName === 'GK') role = 'GK';
        else if (posName.includes('CB')) role = 'CB';
        else if (posName.includes('SB')) role = 'SB';
        else if (posName.includes('WB')) role = 'WB';
        else if (posName.includes('DMF') || posName.includes('CMF')) role = 'CM';
        else if (posName.includes('AMF')) role = 'AM';
        else if (posName.includes('WG') || posName.includes('MF')) role = 'WM';
        else if (posName.includes('FW') || posName.includes('CF')) role = 'FW';
        
        let side = 'Center';
        if (posName.startsWith('R') || coords.top > 60) side = 'Right';
        if (posName.startsWith('L') || coords.top < 40) side = 'Left';
        
        let vertical = 'Mid';
        if (coords.left < 35) vertical = 'Def';
        if (coords.left > 75) vertical = 'Fwd';
        
        return { role, side, vertical, x: coords.top, y: coords.left };
    },

    calculatePositionSimilarity(char1, char2) {
        let score = 0;
        if (char1.role === char2.role) {
            score += 100;
        } else {
            const similarRoles = { 'SB': ['WB'], 'WB': ['SB', 'WM'], 'CM': ['AM'], 'AM': ['CM', 'FW'], 'WM': ['FW', 'WB'] };
            if (similarRoles[char1.role]?.includes(char2.role)) score += 50;
        }
        if (char1.side === char2.side) score += 20;
        if (char1.vertical === char2.vertical) score += 10;
        
        const distance = Math.sqrt(Math.pow(char1.x - char2.x, 2) + Math.pow(char1.y - char2.y, 2));
        score -= distance;
        return score;
    },

    openEditModal(playerId) {
        const player = this.state.squad.find(p => p.id === playerId);
        if (!player) return;
        this.editingPlayerId = playerId;
        this.els.editModal.numberInput.value = player.number;
        this.els.editModal.nameInput.value = player.name;
        this.els.editModal.posSelect.value = player.posCategory || 'FW'; // ËøΩÂä†
        this.openModal(this.els.editModal.overlay);
    },

    savePlayerChanges() {
        if (!this.editingPlayerId) return;
        const player = this.state.squad.find(p => p.id === this.editingPlayerId);
        if (player) {
            const newNumber = parseInt(this.els.editModal.numberInput.value, 10);
            const newName = this.els.editModal.nameInput.value.trim();
            const newPosCategory = this.els.editModal.posSelect.value; // ËøΩÂä†
            if (this.state.squad.some(p => p.number === newNumber && p.id !== player.id)) {
                alert('„Åù„ÅÆËÉåÁï™Âè∑„ÅØÊó¢„Å´‰ΩøÁî®„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ'); return;
            }
            player.number = newNumber || player.number;
            player.name = newName || player.name;
            player.posCategory = newPosCategory; // ËøΩÂä†
            this.renderAll();
        }
        this.closeAllModals();
    },

    deletePlayerFromModal() {
        if (this.editingPlayerId && confirm('„Åì„ÅÆÈÅ∏Êâã„Çí„É™„Çπ„Éà„Åã„ÇâÂÆåÂÖ®„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\n„Åì„ÅÆÊìç‰Ωú„ÅØÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„Çì„ÄÇ')) {
            this.unassignPlayer(this.editingPlayerId);
            this.state.squad = this.state.squad.filter(p => p.id !== this.editingPlayerId);
            this.closeAllModals();
            this.renderAll();
        }
    },
    
    changeNumber(amount) {
        let currentNum = parseInt(this.els.editModal.numberInput.value, 10) || 0;
        let newNum = currentNum + amount;
        if (newNum < 1) newNum = 1;
        this.els.editModal.numberInput.value = newNum;
    },

    toggleDragMode() {
        this.state.config.dragMode = this.state.config.dragMode === 'position' ? 'swap' : 'position';
        this.showModeToast();
        this.renderAll();
    },

    showModeToast() {
        clearTimeout(this.toastTimer);
        this.els.modeToast.textContent = this.state.config.dragMode === 'swap' ? 'ÈÅ∏Êâã‰∫§‰ª£„É¢„Éº„Éâ' : '„Éû„Éº„Ç´„ÉºÁßªÂãï„É¢„Éº„Éâ';
        this.els.modeToast.classList.add('show');
        this.toastTimer = setTimeout(() => { this.els.modeToast.classList.remove('show'); }, 1500);
    },
    
    saveImage() {
        const originalArea = document.getElementById('capture-area');
        // „É°„É¢„É™‰∏ä„ÅßË¶ÅÁ¥†„ÅÆ„ÇØ„É≠„Éº„É≥„Çí‰ΩúÊàê
        const cloneArea = originalArea.cloneNode(true);
        cloneArea.style.position = 'absolute';
        cloneArea.style.left = '-9999px'; // ÁîªÈù¢Â§ñ„Å´ÈÖçÁΩÆ
        cloneArea.style.top = '0px';
        cloneArea.style.width = originalArea.offsetWidth + 'px'; // ÂÖÉ„ÅÆ„Çµ„Ç§„Ç∫„ÇíÁ∂≠ÊåÅ
        document.body.appendChild(cloneArea);

        // „ÇØ„É≠„Éº„É≥„Å´ÂØæ„Åó„Å¶„ÅÆ„Åø„ÄÅÁîªÂÉèÂá∫ÂäõÁî®„ÅÆÂ§âÊõ¥„ÇíÂä†„Åà„Çã
        let subsHTML = '';
        ['GK', 'DF', 'MF', 'FW'].forEach(pos => {
            const playersInPos = (this.state.substitutes[pos] || [])
                .map(id => this.state.squad.find(p => p.id === id))
                .filter(Boolean);
            
            if (playersInPos.length > 0) {
                const names = playersInPos.map(p => `${p.number} ${p.name}`).join(' / ');
                subsHTML += `<div class="subs-pos-group"><span class="pos-label">${pos}:</span><span class="names">${names}</span></div>`;
            }
        });

        const captureSubs = cloneArea.querySelector('#capture-subs');
        if (captureSubs) {
            captureSubs.innerHTML = subsHTML ? `<h4>SUBSTITUTES</h4><div class="subs-grid">${subsHTML}</div>` : '';
        }

        const captureTitle = cloneArea.querySelector('#capture-title');
        const titleInput = this.els.titleInput;
        if (captureTitle) {
            captureTitle.textContent = titleInput.value || titleInput.placeholder;
            captureTitle.style.display = 'block';
        }
        
        const watermark = cloneArea.querySelector('#capture-watermark');
        if (watermark) {
            watermark.textContent = "Created with XISync";
        }
        
        cloneArea.classList.add('is-capturing');

        // „ÇØ„É≠„Éº„É≥„Åó„ÅüË¶ÅÁ¥†„ÇíÁîªÂÉèÂåñ
        html2canvas(cloneArea, { backgroundColor: '#4a8d4d', scale: 3 }).then(canvas => {
            const link = document.createElement('a');
            const fileName = (titleInput.value || 'tactical-canvas').replace(/[\\/:"*?<>|]/g, '').replace(/\s+/g, '_');
            link.download = `${fileName}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }).finally(() => {
            // ÁµÇ„Çè„Å£„Åü„Çâ„ÇØ„É≠„Éº„É≥„ÇíÂâäÈô§
            document.body.removeChild(cloneArea);
        });
    },
    
    checkUrlForSquadData() {
        const dataParam = new URLSearchParams(window.location.search).get('data');
        if (dataParam) {
            try {
                const decompressed = LZString.decompressFromEncodedURIComponent(dataParam);
                const squadData = JSON.parse(decompressed);
                if (this.isValidSquad(squadData)) {
                    this.showImportConfirmation(squadData);
                }
            } catch (error) {
                console.error('URL Data Error:', error);
                history.replaceState(null, '', window.location.pathname);
            }
        }
    },
    
    isValidSquad(squad) {
        return Array.isArray(squad) && squad.every(p => p.id && typeof p.number !== 'undefined' && p.name);
    },
    
    showImportConfirmation(squadData) {
        this._importedSquadData = squadData;
        this.els.importConfirmModal.previewList.innerHTML = '<ul style="list-style: none; padding: 0;">' + squadData
            .sort((a,b) => a.number - b.number)
            .map(p => `<li><strong>No.${p.number}</strong> ${p.name}</li>`).join('') + '</ul>';
        this.openModal(this.els.importConfirmModal.overlay);
    },

    confirmImport() {
        if (!this._importedSquadData) return;
        this.state.squad = this._importedSquadData;
        this.state.starters = {};
        this.state.substitutes = { GK: [], DF: [], MF: [], FW: [] };
        this.renderAll();
        this.closeAllModals();
        history.replaceState(null, '', window.location.pathname);
        alert(`${this.state.squad.length}‰∫∫„ÅÆÈÅ∏Êâã„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åó„Åü„ÄÇ`);
        this._importedSquadData = null;
    },

    processImport(data) {
        if (this.isValidSquad(data)) {
            this.showImportConfirmation(data);
        } else {
            alert('ÁÑ°Âäπ„Å™„Éá„Éº„ÇøÂΩ¢Âºè„Åß„Åô„ÄÇ');
        }
    },

    copySquadUrlToClipboard() {
        if (this.state.squad.length === 0) { alert("ÂÖ±Êúâ„Åô„ÇãÈÅ∏Êâã„Åå„ÅÑ„Åæ„Åõ„Çì„ÄÇ"); return; }
        try {
            const squadJSON = JSON.stringify(this.state.squad);
            const compressed = LZString.compressToEncodedURIComponent(squadJSON);
            const baseUrl = window.location.href.split('?')[0].split('#')[0];
            const shareUrl = `${baseUrl}?data=${compressed}`;
            navigator.clipboard.writeText(shareUrl).then(() => {
                alert("ÂÖ±ÊúâÁî®URL„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ");
                this.closeAllModals();
            }).catch(err => alert("URL„ÅÆ„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ"));
        } catch(e) {
            alert("URL„ÅÆÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ");
        }
    },

    copySquadToClipboard() {
        if (this.state.squad.length === 0) { alert("„Ç≥„Éî„Éº„Åô„ÇãÈÅ∏Êâã„Åå„ÅÑ„Åæ„Åõ„Çì„ÄÇ"); return; }
        navigator.clipboard.writeText(JSON.stringify(this.state.squad)).then(() => {
            alert('„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ');
            this.closeAllModals();
        }).catch(() => alert('„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ'));
    },
    
    exportSquadToFile() {
        if (this.state.squad.length === 0) { alert("„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åô„ÇãÈÅ∏Êâã„Åå„ÅÑ„Åæ„Åõ„Çì„ÄÇ"); return; }
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.state.squad));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "xisync_squad.json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
        this.closeAllModals();
    },

    importFromFile(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                this.processImport(JSON.parse(event.target.result));
            } catch (error) {
                alert('„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
            }
        };
        reader.readAsText(file);
        e.target.value = ''; // Reset file input
    },

    async importFromClipboard() {
        try {
            const text = await navigator.clipboard.readText();
            if (text) {
                try {
                    this.processImport(JSON.parse(text));
                } catch (e) { alert('„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„ÅÆ„Éá„Éº„ÇøÂΩ¢Âºè„ÅåÁÑ°Âäπ„Åß„Åô„ÄÇ'); }
            } else { alert('„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„ÅåÁ©∫„Åß„Åô„ÄÇ'); }
        } catch (err) {
            alert('„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
        }
    },
    setupSidebarControls() {
        const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        
        // Êó¢Â≠ò„ÅÆ„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà
        this.els.allOpenSidebarBtns.forEach(btn => btn.addEventListener('click', () => this.openSidebar(true)));
        
        if (isTouchDevice) {
            this.setupTouchSidebar();
        } else {
            this.setupMouseSidebar();
        }
    },

    setupMouseSidebar() {
        const sidebar = this.els.sidebar.el;
        const handle = this.els.sidebarHandle;

        handle.addEventListener('mouseenter', () => {
            this.sidebarHoverTimer = setTimeout(() => {
                this.openSidebar();
            }, 200);
        });

        handle.addEventListener('mouseleave', () => clearTimeout(this.sidebarHoverTimer));

        sidebar.addEventListener('mouseleave', () => {
            clearTimeout(this.sidebarHoverTimer);
            this.closeSidebar();
        });

        this.els.pinSidebarBtn.addEventListener('click', () => this.toggleSidebarPin());
    },

    setupTouchSidebar() {
        const sidebar = this.els.sidebar.el;
        const handle = this.els.sidebarHandle;
        let startX = 0, currentX = 0, isDragging = false;

        const dragStart = (e) => {
            isDragging = true;
            startX = e.touches[0].clientX;
            sidebar.classList.add('no-transition');
            document.body.style.overflowX = 'hidden';
        };

        const dragMove = (e) => {
            if (!isDragging) return;
            currentX = e.touches[0].clientX;
            const diff = Math.min(300, Math.max(0, currentX - startX));
            sidebar.style.transform = `translateX(${-300 + diff}px)`;
        };

        const dragEnd = () => {
            if (!isDragging) return;
            isDragging = false;
            sidebar.classList.remove('no-transition');
            sidebar.style.transform = '';
            document.body.style.overflowX = '';

            const threshold = 100;
            if (currentX - startX > threshold) {
                this.openSidebar();
            } else {
                this.closeSidebar();
            }
        };

        handle.addEventListener('touchstart', dragStart, { passive: true });
        document.addEventListener('touchmove', dragMove, { passive: true });
        document.addEventListener('touchend', dragEnd);

        // „Çµ„Ç§„Éâ„Éê„Éº„ÅÆÂ§ñÂÅ¥„Çø„ÉÉ„Éó„ÅßÈñâ„Åò„Çã
        document.addEventListener('click', (e) => {
            if (sidebar.classList.contains('is-open') && !sidebar.contains(e.target) && !e.target.closest('.sidebar-handle') && !e.target.closest('#open-sidebar-btn')) {
                this.closeSidebar(true);
            }
        });
    },

    openSidebar(isPinned = false) {
        if (isPinned) this.els.sidebar.el.classList.add('is-pinned');
        this.els.sidebar.el.classList.add('is-open');
        this.els.body.classList.add('sidebar-is-open');
    },

    closeSidebar(force = false) {
        if (this.els.sidebar.el.classList.contains('is-pinned') && !force) return;
        
        if (force) {
           this.els.sidebar.el.classList.remove('is-pinned');
        }
        this.els.sidebar.el.classList.remove('is-open');
        this.els.body.classList.remove('sidebar-is-open');
    },

    toggleSidebarPin() {
        const sidebar = this.els.sidebar.el;
        sidebar.classList.toggle('is-pinned');
        if (sidebar.classList.contains('is-pinned')) {
            this.openSidebar();
        }
    }
};

App.init(); // Run the app

});

</script>
</body>
</html>
